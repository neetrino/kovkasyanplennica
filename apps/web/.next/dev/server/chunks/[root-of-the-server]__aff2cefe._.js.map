{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/client.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as any;\n\n// Ensure UTF-8 encoding for PostgreSQL connection\n// This fixes encoding issues with Armenian and other UTF-8 characters\nconst databaseUrl = process.env.DATABASE_URL || '';\nlet urlWithEncoding = databaseUrl;\n\nif (!databaseUrl.includes('client_encoding')) {\n  urlWithEncoding = databaseUrl.includes('?') \n    ? `${databaseUrl}&client_encoding=UTF8`\n    : `${databaseUrl}?client_encoding=UTF8`;\n  \n  // Temporarily override DATABASE_URL for Prisma Client\n  process.env.DATABASE_URL = urlWithEncoding;\n}\n\nexport const db =\n  globalForPrisma.prisma ??\n  new PrismaClient({ \n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n    errorFormat: \"pretty\",\n  });\n\n// Prisma Client connects automatically on first query (lazy connection)\n// No need to call $connect() explicitly as it can cause issues in Next.js API routes\n// Connection will be established automatically when the first database query is made\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAExB,kDAAkD;AAClD,sEAAsE;AACtE,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI;AAChD,IAAI,kBAAkB;AAEtB,IAAI,CAAC,YAAY,QAAQ,CAAC,oBAAoB;IAC5C,kBAAkB,YAAY,QAAQ,CAAC,OACnC,GAAG,YAAY,qBAAqB,CAAC,GACrC,GAAG,YAAY,qBAAqB,CAAC;IAEzC,sDAAsD;IACtD,QAAQ,GAAG,CAAC,YAAY,GAAG;AAC7B;AAEO,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;IAC3E,aAAa;AACf;AAEF,wEAAwE;AACxE,qFAAqF;AACrF,qFAAqF;AAErF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/index.ts"],"sourcesContent":["export * from \"./client\";\r\n\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/middleware/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport * as jwt from \"jsonwebtoken\";\r\nimport { db } from \"@white-shop/db\";\r\n\r\nexport interface AuthUser {\r\n  id: string;\r\n  email: string | null;\r\n  phone: string | null;\r\n  locale: string;\r\n  roles: string[];\r\n}\r\n\r\n/**\r\n * Authenticate JWT token from request headers\r\n */\r\nexport async function authenticateToken(\r\n  request: NextRequest\r\n): Promise<AuthUser | null> {\r\n  try {\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const token = authHeader?.split(\" \")[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return null;\r\n    }\r\n\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error(\"❌ [AUTH] JWT_SECRET is not set!\");\r\n      return null;\r\n    }\r\n\r\n    const decoded = jwt.verify(token, process.env.JWT_SECRET) as {\r\n      userId: string;\r\n    };\r\n\r\n    const user = await db.user.findUnique({\r\n      where: { id: decoded.userId },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        locale: true,\r\n        roles: true,\r\n        blocked: true,\r\n        deletedAt: true,\r\n      },\r\n    });\r\n\r\n    if (!user || user.blocked || user.deletedAt) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      phone: user.phone,\r\n      locale: user.locale,\r\n      roles: user.roles,\r\n    };\r\n  } catch (error) {\r\n    if (\r\n      error instanceof jwt.JsonWebTokenError ||\r\n      error instanceof jwt.TokenExpiredError\r\n    ) {\r\n      return null;\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user is admin\r\n */\r\nexport function requireAdmin(user: AuthUser | null): boolean {\r\n  if (!user) {\r\n    return false;\r\n  }\r\n  return user.roles.includes(\"admin\");\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;AAAA;;;AAaO,eAAe,kBACpB,OAAoB;IAEpB,IAAI;QACF,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,QAAQ,YAAY,MAAM,IAAI,CAAC,EAAE,EAAE,eAAe;QAExD,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;YACd,OAAO;QACT;QAEA,MAAM,UAAU,iJAAU,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;QAIxD,MAAM,OAAO,MAAM,gIAAE,CAAC,IAAI,CAAC,UAAU,CAAC;YACpC,OAAO;gBAAE,IAAI,QAAQ,MAAM;YAAC;YAC5B,QAAQ;gBACN,IAAI;gBACJ,OAAO;gBACP,OAAO;gBACP,QAAQ;gBACR,OAAO;gBACP,SAAS;gBACT,WAAW;YACb;QACF;QAEA,IAAI,CAAC,QAAQ,KAAK,OAAO,IAAI,KAAK,SAAS,EAAE;YAC3C,OAAO;QACT;QAEA,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,OAAO,KAAK,KAAK;YACjB,QAAQ,KAAK,MAAM;YACnB,OAAO,KAAK,KAAK;QACnB;IACF,EAAE,OAAO,OAAO;QACd,IACE,iBAAiB,4JAAqB,IACtC,iBAAiB,4JAAqB,EACtC;YACA,OAAO;QACT;QACA,MAAM;IACR;AACF;AAKO,SAAS,aAAa,IAAqB;IAChD,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IACA,OAAO,KAAK,KAAK,CAAC,QAAQ,CAAC;AAC7B"}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/app/api/v1/admin/messages/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { authenticateToken, requireAdmin } from \"@/lib/middleware/auth\";\r\nimport { db } from \"@white-shop/db\";\r\n\r\n/**\r\n * GET /api/v1/admin/messages\r\n * Get all contact messages (admin only)\r\n */\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    const user = await authenticateToken(req);\r\n    if (!user || !requireAdmin(user)) {\r\n      return NextResponse.json(\r\n        {\r\n          type: \"https://api.shop.am/problems/forbidden\",\r\n          title: \"Forbidden\",\r\n          status: 403,\r\n          detail: \"Admin access required\",\r\n          instance: req.url,\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(req.url);\r\n    const page = parseInt(searchParams.get(\"page\") || \"1\", 10);\r\n    const limit = parseInt(searchParams.get(\"limit\") || \"20\", 10);\r\n    const skip = (page - 1) * limit;\r\n\r\n    // Get total count\r\n    let total: number;\r\n    let messages: any[];\r\n    \r\n    try {\r\n      total = await db.contactMessage.count();\r\n    } catch (dbError: any) {\r\n      console.error(\"❌ [ADMIN MESSAGES] Database count error:\", dbError);\r\n      throw new Error(`Database query failed: ${dbError.message || 'Unknown database error'}. Make sure Prisma Client is generated and migrations are applied.`);\r\n    }\r\n\r\n    try {\r\n      // Get messages\r\n      messages = await db.contactMessage.findMany({\r\n        skip,\r\n        take: limit,\r\n        orderBy: {\r\n          createdAt: 'desc',\r\n        },\r\n      });\r\n    } catch (dbError: any) {\r\n      console.error(\"❌ [ADMIN MESSAGES] Database findMany error:\", dbError);\r\n      throw new Error(`Database query failed: ${dbError.message || 'Unknown database error'}. Make sure Prisma Client is generated and migrations are applied.`);\r\n    }\r\n\r\n    const totalPages = Math.ceil(total / limit);\r\n\r\n    return NextResponse.json({\r\n      data: messages,\r\n      meta: {\r\n        total,\r\n        page,\r\n        limit,\r\n        totalPages,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"❌ [ADMIN MESSAGES] Error:\", error);\r\n    console.error(\"❌ [ADMIN MESSAGES] Error stack:\", error.stack);\r\n    return NextResponse.json(\r\n      {\r\n        type: error.type || \"https://api.shop.am/problems/internal-error\",\r\n        title: error.title || \"Internal Server Error\",\r\n        status: error.status || 500,\r\n        detail: error.detail || error.message || \"An error occurred\",\r\n        instance: req.url,\r\n      },\r\n      { status: error.status || 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/v1/admin/messages\r\n * Delete multiple messages by IDs (admin only)\r\n */\r\nexport async function DELETE(req: NextRequest) {\r\n  try {\r\n    const user = await authenticateToken(req);\r\n    if (!user || !requireAdmin(user)) {\r\n      return NextResponse.json(\r\n        {\r\n          type: \"https://api.shop.am/problems/forbidden\",\r\n          title: \"Forbidden\",\r\n          status: 403,\r\n          detail: \"Admin access required\",\r\n          instance: req.url,\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await req.json();\r\n    const { ids } = body;\r\n\r\n    if (!Array.isArray(ids) || ids.length === 0) {\r\n      return NextResponse.json(\r\n        {\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          status: 400,\r\n          detail: \"Field 'ids' is required and must be a non-empty array\",\r\n          instance: req.url,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Delete messages\r\n    const result = await db.contactMessage.deleteMany({\r\n      where: {\r\n        id: {\r\n          in: ids,\r\n        },\r\n      },\r\n    });\r\n\r\n    console.log(`✅ [ADMIN MESSAGES] Deleted ${result.count} messages`);\r\n\r\n    return NextResponse.json({\r\n      data: {\r\n        deletedCount: result.count,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"❌ [ADMIN MESSAGES] Error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        type: error.type || \"https://api.shop.am/problems/internal-error\",\r\n        title: error.title || \"Internal Server Error\",\r\n        status: error.status || 500,\r\n        detail: error.detail || error.message || \"An error occurred\",\r\n        instance: req.url,\r\n      },\r\n      { status: error.status || 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}