{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/client.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as any;\n\n// Ensure UTF-8 encoding for PostgreSQL connection\n// This fixes encoding issues with Armenian and other UTF-8 characters\nconst databaseUrl = process.env.DATABASE_URL || '';\nlet urlWithEncoding = databaseUrl;\n\nif (!databaseUrl.includes('client_encoding')) {\n  urlWithEncoding = databaseUrl.includes('?') \n    ? `${databaseUrl}&client_encoding=UTF8`\n    : `${databaseUrl}?client_encoding=UTF8`;\n  \n  // Temporarily override DATABASE_URL for Prisma Client\n  process.env.DATABASE_URL = urlWithEncoding;\n}\n\nexport const db =\n  globalForPrisma.prisma ??\n  new PrismaClient({ \n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n    errorFormat: \"pretty\",\n  });\n\n// Prisma Client connects automatically on first query (lazy connection)\n// No need to call $connect() explicitly as it can cause issues in Next.js API routes\n// Connection will be established automatically when the first database query is made\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAExB,kDAAkD;AAClD,sEAAsE;AACtE,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI;AAChD,IAAI,kBAAkB;AAEtB,IAAI,CAAC,YAAY,QAAQ,CAAC,oBAAoB;IAC5C,kBAAkB,YAAY,QAAQ,CAAC,OACnC,GAAG,YAAY,qBAAqB,CAAC,GACrC,GAAG,YAAY,qBAAqB,CAAC;IAEzC,sDAAsD;IACtD,QAAQ,GAAG,CAAC,YAAY,GAAG;AAC7B;AAEO,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;IAC3E,aAAa;AACf;AAEF,wEAAwE;AACxE,qFAAqF;AACrF,qFAAqF;AAErF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/index.ts"],"sourcesContent":["export * from \"./client\";\r\n\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/middleware/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport * as jwt from \"jsonwebtoken\";\r\nimport { db } from \"@white-shop/db\";\r\n\r\nexport interface AuthUser {\r\n  id: string;\r\n  email: string | null;\r\n  phone: string | null;\r\n  locale: string;\r\n  roles: string[];\r\n}\r\n\r\n/**\r\n * Authenticate JWT token from request headers\r\n */\r\nexport async function authenticateToken(\r\n  request: NextRequest\r\n): Promise<AuthUser | null> {\r\n  try {\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const token = authHeader?.split(\" \")[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return null;\r\n    }\r\n\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error(\"‚ùå [AUTH] JWT_SECRET is not set!\");\r\n      return null;\r\n    }\r\n\r\n    const decoded = jwt.verify(token, process.env.JWT_SECRET) as {\r\n      userId: string;\r\n    };\r\n\r\n    const user = await db.user.findUnique({\r\n      where: { id: decoded.userId },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        locale: true,\r\n        roles: true,\r\n        blocked: true,\r\n        deletedAt: true,\r\n      },\r\n    });\r\n\r\n    if (!user || user.blocked || user.deletedAt) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      phone: user.phone,\r\n      locale: user.locale,\r\n      roles: user.roles,\r\n    };\r\n  } catch (error) {\r\n    if (\r\n      error instanceof jwt.JsonWebTokenError ||\r\n      error instanceof jwt.TokenExpiredError\r\n    ) {\r\n      return null;\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user is admin\r\n */\r\nexport function requireAdmin(user: AuthUser | null): boolean {\r\n  if (!user) {\r\n    return false;\r\n  }\r\n  return user.roles.includes(\"admin\");\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;AAAA;;;AAaO,eAAe,kBACpB,OAAoB;IAEpB,IAAI;QACF,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,QAAQ,YAAY,MAAM,IAAI,CAAC,EAAE,EAAE,eAAe;QAExD,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;YACd,OAAO;QACT;QAEA,MAAM,UAAU,iJAAU,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;QAIxD,MAAM,OAAO,MAAM,gIAAE,CAAC,IAAI,CAAC,UAAU,CAAC;YACpC,OAAO;gBAAE,IAAI,QAAQ,MAAM;YAAC;YAC5B,QAAQ;gBACN,IAAI;gBACJ,OAAO;gBACP,OAAO;gBACP,QAAQ;gBACR,OAAO;gBACP,SAAS;gBACT,WAAW;YACb;QACF;QAEA,IAAI,CAAC,QAAQ,KAAK,OAAO,IAAI,KAAK,SAAS,EAAE;YAC3C,OAAO;QACT;QAEA,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,OAAO,KAAK,KAAK;YACjB,QAAQ,KAAK,MAAM;YACnB,OAAO,KAAK,KAAK;QACnB;IACF,EAAE,OAAO,OAAO;QACd,IACE,iBAAiB,4JAAqB,IACtC,iBAAiB,4JAAqB,EACtC;YACA,OAAO;QACT;QACA,MAAM;IACR;AACF;AAKO,SAAS,aAAa,IAAqB;IAChD,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IACA,OAAO,KAAK,KAAK,CAAC,QAAQ,CAAC;AAC7B"}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/services/orders.service.ts"],"sourcesContent":["import { db } from \"@white-shop/db\";\r\n\r\nfunction generateOrderNumber(): string {\r\n  const now = new Date();\r\n  const year = now.getFullYear().toString().slice(-2);\r\n  const month = String(now.getMonth() + 1).padStart(2, \"0\");\r\n  const day = String(now.getDate()).padStart(2, \"0\");\r\n  const random = String(Math.floor(Math.random() * 10000)).padStart(5, \"0\");\r\n  return `${year}${month}${day}-${random}`;\r\n}\r\n\r\nclass OrdersService {\r\n  /**\r\n   * Create order (checkout)\r\n   */\r\n  async checkout(data: any, userId?: string) {\r\n    try {\r\n      const {\r\n        cartId,\r\n        items: guestItems,\r\n        email,\r\n        phone,\r\n        shippingMethod = 'pickup',\r\n        shippingAddress,\r\n        shippingAmount: providedShippingAmount,\r\n        paymentMethod = 'idram',\r\n      } = data;\r\n\r\n      // Validate required fields\r\n      if (!email || !phone) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: \"Email and phone are required\",\r\n        };\r\n      }\r\n\r\n      // Get cart items - either from user cart or guest items\r\n      let cartItems: Array<{\r\n        variantId: string;\r\n        productId: string;\r\n        quantity: number;\r\n        price: number;\r\n        productTitle: string;\r\n        variantTitle?: string;\r\n        sku: string;\r\n        imageUrl?: string;\r\n      }> = [];\r\n\r\n      if (userId && cartId && cartId !== 'guest-cart') {\r\n        // Get items from user's cart\r\n        const cart = await db.cart.findFirst({\r\n          where: { id: cartId, userId },\r\n          include: {\r\n            items: {\r\n              include: {\r\n                variant: {\r\n                  include: {\r\n                    product: {\r\n                      include: {\r\n                        translations: true,\r\n                      },\r\n                    },\r\n                    options: true,\r\n                  },\r\n                },\r\n                product: {\r\n                  include: {\r\n                    translations: true,\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        });\r\n\r\n        if (!cart || cart.items.length === 0) {\r\n          throw {\r\n            status: 400,\r\n            type: \"https://api.shop.am/problems/validation-error\",\r\n            title: \"Cart is empty\",\r\n            detail: \"Cannot checkout with an empty cart\",\r\n          };\r\n        }\r\n\r\n        // Format cart items\r\n        console.log('üõí [ORDERS SERVICE] Processing cart items:', cart.items.map((item: any) => ({\r\n          itemId: item.id,\r\n          variantId: item.variantId,\r\n          productId: item.productId,\r\n          quantity: item.quantity,\r\n          hasVariant: !!item.variant,\r\n        })));\r\n        \r\n        cartItems = await Promise.all(\r\n          cart.items.map(async (item: {\r\n            productId: string;\r\n            variantId: string;\r\n            quantity: number;\r\n            priceSnapshot: number;\r\n            product: any;\r\n            variant: any;\r\n          }) => {\r\n            const product = item.product;\r\n            const variant = item.variant;\r\n            \r\n            if (!variant) {\r\n              console.error('‚ùå [ORDERS SERVICE] Cart item missing variant:', {\r\n                itemId: item.id,\r\n                variantId: item.variantId,\r\n                productId: item.productId,\r\n              });\r\n              throw {\r\n                status: 404,\r\n                type: \"https://api.shop.am/problems/not-found\",\r\n                title: \"Variant not found\",\r\n                detail: `Variant ${item.variantId} not found for cart item`,\r\n              };\r\n            }\r\n            \r\n            console.log('‚úÖ [ORDERS SERVICE] Processing cart item:', {\r\n              itemId: item.id,\r\n              variantId: variant.id,\r\n              productId: product.id,\r\n              quantity: item.quantity,\r\n              variantStock: variant.stock,\r\n              variantSku: variant.sku,\r\n            });\r\n            \r\n            const translation = product.translations?.[0] || product.translations?.[0];\r\n\r\n            // Get variant title from options\r\n            const variantTitle = variant.options\r\n              ?.map((opt: any) => `${opt.attributeKey}: ${opt.value}`)\r\n              .join(', ') || undefined;\r\n\r\n            // Get image URL\r\n            let imageUrl: string | undefined;\r\n            if (product.media && Array.isArray(product.media) && product.media.length > 0) {\r\n              const firstMedia = product.media[0];\r\n              if (typeof firstMedia === \"string\") {\r\n                imageUrl = firstMedia;\r\n              } else if ((firstMedia as any)?.url) {\r\n                imageUrl = (firstMedia as any).url;\r\n              } else if ((firstMedia as any)?.src) {\r\n                imageUrl = (firstMedia as any).src;\r\n              }\r\n            }\r\n\r\n            // Check stock availability\r\n            if (variant.stock < item.quantity) {\r\n              throw {\r\n                status: 422,\r\n                type: \"https://api.shop.am/problems/validation-error\",\r\n                title: \"Insufficient stock\",\r\n                detail: `Product \"${translation?.title || 'Unknown'}\" - insufficient stock. Available: ${variant.stock}, Requested: ${item.quantity}`,\r\n              };\r\n            }\r\n\r\n            const cartItem = {\r\n              variantId: variant.id,\r\n              productId: product.id,\r\n              quantity: item.quantity,\r\n              price: Number(item.priceSnapshot),\r\n              productTitle: translation?.title || 'Unknown Product',\r\n              variantTitle,\r\n              sku: variant.sku || '',\r\n              imageUrl,\r\n            };\r\n            \r\n            console.log('‚úÖ [ORDERS SERVICE] Cart item formatted:', {\r\n              variantId: cartItem.variantId,\r\n              productId: cartItem.productId,\r\n              quantity: cartItem.quantity,\r\n              sku: cartItem.sku,\r\n            });\r\n            \r\n            return cartItem;\r\n          })\r\n        );\r\n        \r\n        console.log('‚úÖ [ORDERS SERVICE] All cart items processed:', cartItems.length);\r\n      } else if (guestItems && Array.isArray(guestItems) && guestItems.length > 0) {\r\n        // Get items from guest checkout\r\n        cartItems = await Promise.all(\r\n          guestItems.map(async (item: any) => {\r\n            const { productId, variantId, quantity } = item;\r\n\r\n            if (!productId || !variantId || !quantity) {\r\n              throw {\r\n                status: 400,\r\n                type: \"https://api.shop.am/problems/validation-error\",\r\n                title: \"Validation Error\",\r\n                detail: \"Each item must have productId, variantId, and quantity\",\r\n              };\r\n            }\r\n\r\n            // Get product and variant details\r\n            const variant = await db.productVariant.findUnique({\r\n              where: { id: variantId },\r\n              include: {\r\n                product: {\r\n                  include: {\r\n                    translations: true,\r\n                  },\r\n                },\r\n                options: true,\r\n              },\r\n            });\r\n\r\n            if (!variant || variant.productId !== productId) {\r\n              throw {\r\n                status: 404,\r\n                type: \"https://api.shop.am/problems/not-found\",\r\n                title: \"Product variant not found\",\r\n                detail: `Variant ${variantId} not found for product ${productId}`,\r\n              };\r\n            }\r\n\r\n            // Check stock\r\n            if (variant.stock < quantity) {\r\n              throw {\r\n                status: 422,\r\n                type: \"https://api.shop.am/problems/validation-error\",\r\n                title: \"Insufficient stock\",\r\n                detail: `Insufficient stock. Available: ${variant.stock}, Requested: ${quantity}`,\r\n              };\r\n            }\r\n\r\n            const translation = variant.product.translations?.[0] || variant.product.translations?.[0];\r\n            const variantTitle = variant.options\r\n              ?.map((opt: any) => `${opt.attributeKey}: ${opt.value}`)\r\n              .join(', ') || undefined;\r\n\r\n            // Get image URL\r\n            let imageUrl: string | undefined;\r\n            if (variant.product.media && Array.isArray(variant.product.media) && variant.product.media.length > 0) {\r\n              const firstMedia = variant.product.media[0];\r\n              if (typeof firstMedia === \"string\") {\r\n                imageUrl = firstMedia;\r\n              } else if ((firstMedia as any)?.url) {\r\n                imageUrl = (firstMedia as any).url;\r\n              } else if ((firstMedia as any)?.src) {\r\n                imageUrl = (firstMedia as any).src;\r\n              }\r\n            }\r\n\r\n            return {\r\n              variantId: variant.id,\r\n              productId: variant.product.id,\r\n              quantity,\r\n              price: Number(variant.price),\r\n              productTitle: translation?.title || 'Unknown Product',\r\n              variantTitle,\r\n              sku: variant.sku || '',\r\n              imageUrl,\r\n            };\r\n          })\r\n        );\r\n      } else {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Cart is empty\",\r\n          detail: \"Cannot checkout with an empty cart\",\r\n        };\r\n      }\r\n\r\n      if (cartItems.length === 0) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Cart is empty\",\r\n          detail: \"Cannot checkout with an empty cart\",\r\n        };\r\n      }\r\n\r\n      // Calculate totals\r\n      const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n      const discountAmount = 0; // TODO: Implement discount/coupon logic\r\n      // Use provided shipping amount from frontend (calculated from delivery API), or 0 if not provided\r\n      const shippingAmount = providedShippingAmount !== undefined ? Number(providedShippingAmount) : 0;\r\n      const taxAmount = 0; // TODO: Calculate tax if needed\r\n      const total = subtotal - discountAmount + shippingAmount + taxAmount;\r\n\r\n      // Generate order number\r\n      const orderNumber = generateOrderNumber();\r\n\r\n      // Create order with items in a transaction\r\n      const order = await db.$transaction(async (tx: any) => {\r\n        // Create order\r\n        const newOrder = await tx.order.create({\r\n          data: {\r\n            number: orderNumber,\r\n            userId: userId || null,\r\n            status: 'pending',\r\n            paymentStatus: 'pending',\r\n            fulfillmentStatus: 'unfulfilled',\r\n            subtotal,\r\n            discountAmount,\r\n            shippingAmount,\r\n            taxAmount,\r\n            total,\r\n            currency: 'AMD',\r\n            customerEmail: email,\r\n            customerPhone: phone,\r\n            customerLocale: 'en', // TODO: Get from request\r\n            shippingMethod,\r\n            shippingAddress: shippingAddress ? JSON.parse(JSON.stringify(shippingAddress)) : null,\r\n            billingAddress: shippingAddress ? JSON.parse(JSON.stringify(shippingAddress)) : null,\r\n            items: {\r\n              create: cartItems.map((item) => ({\r\n                variantId: item.variantId,\r\n                productTitle: item.productTitle,\r\n                variantTitle: item.variantTitle,\r\n                sku: item.sku,\r\n                quantity: item.quantity,\r\n                price: item.price,\r\n                total: item.price * item.quantity,\r\n                imageUrl: item.imageUrl,\r\n              })),\r\n            },\r\n            events: {\r\n              create: {\r\n                type: 'order_created',\r\n                data: {\r\n                  source: userId ? 'user' : 'guest',\r\n                  paymentMethod,\r\n                  shippingMethod,\r\n                },\r\n              },\r\n            },\r\n          },\r\n          include: {\r\n            items: true,\r\n          },\r\n        });\r\n\r\n        // Update stock for all variants\r\n        console.log('üì¶ [ORDERS SERVICE] Updating stock for variants:', cartItems.map(item => ({\r\n          variantId: item.variantId,\r\n          quantity: item.quantity,\r\n          sku: item.sku,\r\n        })));\r\n        \r\n        try {\r\n          for (const item of cartItems) {\r\n            if (!item.variantId) {\r\n              console.error('‚ùå [ORDERS SERVICE] Missing variantId for item:', item);\r\n              throw {\r\n                status: 400,\r\n                type: \"https://api.shop.am/problems/validation-error\",\r\n                title: \"Validation Error\",\r\n                detail: `Missing variantId for item with SKU: ${item.sku}`,\r\n              };\r\n            }\r\n\r\n            // Get current stock before update for logging\r\n            const variantBefore = await tx.productVariant.findUnique({\r\n              where: { id: item.variantId },\r\n              select: { stock: true, sku: true },\r\n            });\r\n\r\n            if (!variantBefore) {\r\n              console.error('‚ùå [ORDERS SERVICE] Variant not found:', item.variantId);\r\n              throw {\r\n                status: 404,\r\n                type: \"https://api.shop.am/problems/not-found\",\r\n                title: \"Variant not found\",\r\n                detail: `Variant with id '${item.variantId}' not found`,\r\n              };\r\n            }\r\n\r\n            console.log(`üì¶ [ORDERS SERVICE] Updating stock for variant ${item.variantId} (SKU: ${variantBefore.sku}):`, {\r\n              currentStock: variantBefore.stock,\r\n              quantityToDecrement: item.quantity,\r\n              newStock: variantBefore.stock - item.quantity,\r\n            });\r\n\r\n            // Update stock with decrement\r\n            const updatedVariant = await tx.productVariant.update({\r\n              where: { id: item.variantId },\r\n              data: {\r\n                stock: {\r\n                  decrement: item.quantity,\r\n                },\r\n              },\r\n              select: { stock: true, sku: true },\r\n            });\r\n\r\n            console.log(`‚úÖ [ORDERS SERVICE] Stock updated for variant ${item.variantId} (SKU: ${updatedVariant.sku}):`, {\r\n              newStock: updatedVariant.stock,\r\n              expectedStock: variantBefore.stock - item.quantity,\r\n              match: updatedVariant.stock === (variantBefore.stock - item.quantity),\r\n            });\r\n\r\n            // Verify stock was actually decremented\r\n            if (updatedVariant.stock !== (variantBefore.stock - item.quantity)) {\r\n              console.error('‚ùå [ORDERS SERVICE] Stock update mismatch!', {\r\n                variantId: item.variantId,\r\n                expectedStock: variantBefore.stock - item.quantity,\r\n                actualStock: updatedVariant.stock,\r\n                quantity: item.quantity,\r\n              });\r\n              // Don't throw here - transaction will rollback if needed\r\n            }\r\n          }\r\n          \r\n          console.log('‚úÖ [ORDERS SERVICE] All variant stocks updated successfully');\r\n        } catch (stockError: any) {\r\n          console.error('‚ùå [ORDERS SERVICE] Error updating stock:', {\r\n            error: stockError,\r\n            message: stockError?.message,\r\n            detail: stockError?.detail,\r\n          });\r\n          // Re-throw to rollback transaction\r\n          throw stockError;\r\n        }\r\n\r\n        // Create payment record\r\n        const payment = await tx.payment.create({\r\n          data: {\r\n            orderId: newOrder.id,\r\n            provider: paymentMethod,\r\n            method: paymentMethod,\r\n            amount: total,\r\n            currency: 'AMD',\r\n            status: 'pending',\r\n          },\r\n        });\r\n\r\n        // If user cart, delete cart after successful checkout\r\n        if (userId && cartId && cartId !== 'guest-cart') {\r\n          await tx.cart.delete({\r\n            where: { id: cartId },\r\n          });\r\n        }\r\n\r\n        return { order: newOrder, payment };\r\n      });\r\n\r\n      // Return order and payment info\r\n      return {\r\n        order: {\r\n          id: order.order.id,\r\n          number: order.order.number,\r\n          status: order.order.status,\r\n          paymentStatus: order.order.paymentStatus,\r\n          total: order.order.total,\r\n          currency: order.order.currency,\r\n        },\r\n        payment: {\r\n          provider: order.payment.provider,\r\n          paymentUrl: null, // TODO: Generate payment URL for Idram/ArCa\r\n          expiresAt: null, // TODO: Set expiration if needed\r\n        },\r\n        nextAction: paymentMethod === 'idram' || paymentMethod === 'arca' \r\n          ? 'redirect_to_payment' \r\n          : 'view_order',\r\n      };\r\n    } catch (error: any) {\r\n      // If it's already our custom error, re-throw it\r\n      if (error.status && error.type) {\r\n        throw error;\r\n      }\r\n\r\n      // Log unexpected errors\r\n      console.error(\"‚ùå [ORDERS SERVICE] Checkout error:\", {\r\n        error: {\r\n          name: error?.name,\r\n          message: error?.message,\r\n          code: error?.code,\r\n          meta: error?.meta,\r\n          stack: error?.stack?.substring(0, 500),\r\n        },\r\n      });\r\n\r\n      // Handle Prisma errors\r\n      if (error?.code === 'P2002') {\r\n        throw {\r\n          status: 409,\r\n          type: \"https://api.shop.am/problems/conflict\",\r\n          title: \"Conflict\",\r\n          detail: \"Order number already exists, please try again\",\r\n        };\r\n      }\r\n\r\n      // Generic error\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: error?.message || \"An error occurred during checkout\",\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get user orders list\r\n   */\r\n  async list(userId: string) {\r\n    const orders = await db.order.findMany({\r\n      where: { userId },\r\n      include: {\r\n        items: true,\r\n        payments: true,\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n    });\r\n\r\n    return {\r\n      data: orders.map((order: {\r\n        id: string;\r\n        number: string;\r\n        status: string;\r\n        paymentStatus: string;\r\n        fulfillmentStatus: string;\r\n        total: number;\r\n        subtotal: number;\r\n        discountAmount: number;\r\n        shippingAmount: number;\r\n        taxAmount: number;\r\n        currency: string;\r\n        createdAt: Date;\r\n        items: Array<{ id: string }>;\r\n      }) => ({\r\n        id: order.id,\r\n        number: order.number,\r\n        status: order.status,\r\n        paymentStatus: order.paymentStatus,\r\n        fulfillmentStatus: order.fulfillmentStatus,\r\n        total: order.total,\r\n        subtotal: order.subtotal,\r\n        discountAmount: order.discountAmount,\r\n        shippingAmount: order.shippingAmount,\r\n        taxAmount: order.taxAmount,\r\n        currency: order.currency,\r\n        createdAt: order.createdAt,\r\n        itemsCount: order.items.length,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get order by number\r\n   */\r\n  async findByNumber(orderNumber: string, userId: string) {\r\n    const order = await db.order.findFirst({\r\n      where: {\r\n        number: orderNumber,\r\n        userId,\r\n      },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            variant: {\r\n              include: {\r\n                options: {\r\n                  include: {\r\n                    attributeValue: {\r\n                      include: {\r\n                        attribute: true,\r\n                        translations: true,\r\n                      },\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        payments: true,\r\n        events: true,\r\n      },\r\n    });\r\n\r\n    if (!order) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Order not found\",\r\n        detail: `Order with number '${orderNumber}' not found`,\r\n      };\r\n    }\r\n\r\n    // Parse shipping address if it's a JSON string\r\n    let shippingAddress = order.shippingAddress;\r\n    if (typeof shippingAddress === 'string') {\r\n      try {\r\n        shippingAddress = JSON.parse(shippingAddress);\r\n      } catch {\r\n        shippingAddress = null;\r\n      }\r\n    }\r\n\r\n    // Debug logging\r\n    console.log('üì¶ [ORDERS SERVICE] Order found:', {\r\n      orderNumber: order.number,\r\n      itemsCount: order.items.length,\r\n      items: order.items.map((item: any) => ({\r\n        variantId: item.variantId,\r\n        productTitle: item.productTitle,\r\n        variant: item.variant ? {\r\n          id: item.variant.id,\r\n          optionsCount: item.variant.options?.length || 0,\r\n          options: item.variant.options,\r\n        } : null,\r\n      })),\r\n    });\r\n\r\n    return {\r\n      id: order.id,\r\n      number: order.number,\r\n      status: order.status,\r\n      paymentStatus: order.paymentStatus,\r\n      fulfillmentStatus: order.fulfillmentStatus,\r\n      items: order.items.map((item: {\r\n        variantId: string | null;\r\n        productTitle: string;\r\n        variantTitle: string | null;\r\n        sku: string;\r\n        quantity: number;\r\n        price: number;\r\n        total: number;\r\n        imageUrl: string | null;\r\n        variant: {\r\n          options: Array<{\r\n            attributeKey: string | null;\r\n            value: string | null;\r\n          }>;\r\n        } | null;\r\n      }) => {\r\n        const variantOptions = item.variant?.options?.map((opt: {\r\n          attributeKey: string | null;\r\n          value: string | null;\r\n          valueId: string | null;\r\n          attributeValue: {\r\n            value: string;\r\n            imageUrl: string | null;\r\n            colors: any;\r\n            translations: Array<{\r\n              locale: string;\r\n              label: string;\r\n            }>;\r\n            attribute: {\r\n              key: string;\r\n            };\r\n          } | null;\r\n        }) => {\r\n          // Debug logging for each option\r\n          console.log(`üîç [ORDERS SERVICE] Processing option:`, {\r\n            attributeKey: opt.attributeKey,\r\n            value: opt.value,\r\n            valueId: opt.valueId,\r\n            hasAttributeValue: !!opt.attributeValue,\r\n            attributeValueData: opt.attributeValue ? {\r\n              value: opt.attributeValue.value,\r\n              attributeKey: opt.attributeValue.attribute.key,\r\n              imageUrl: opt.attributeValue.imageUrl,\r\n              hasTranslations: opt.attributeValue.translations?.length > 0,\r\n            } : null,\r\n          });\r\n\r\n          // New format: Use AttributeValue if available\r\n          if (opt.attributeValue) {\r\n            // Get label from translations (prefer current locale, fallback to first available)\r\n            const translations = opt.attributeValue.translations || [];\r\n            const label = translations.length > 0 ? translations[0].label : opt.attributeValue.value;\r\n            \r\n            return {\r\n              attributeKey: opt.attributeValue.attribute.key || undefined,\r\n              value: opt.attributeValue.value || undefined,\r\n              label: label || undefined,\r\n              imageUrl: opt.attributeValue.imageUrl || undefined,\r\n              colors: opt.attributeValue.colors || undefined,\r\n            };\r\n          }\r\n          // Old format: Use attributeKey and value directly\r\n          return {\r\n            attributeKey: opt.attributeKey || undefined,\r\n            value: opt.value || undefined,\r\n          };\r\n        }) || [];\r\n\r\n        console.log(`üîç [ORDERS SERVICE] Item mapping:`, {\r\n          productTitle: item.productTitle,\r\n          variantId: item.variantId,\r\n          hasVariant: !!item.variant,\r\n          optionsCount: item.variant?.options?.length || 0,\r\n          variantOptions,\r\n        });\r\n\r\n        return {\r\n          variantId: item.variantId || '',\r\n          productTitle: item.productTitle,\r\n          variantTitle: item.variantTitle || '',\r\n          sku: item.sku,\r\n          quantity: item.quantity,\r\n          price: Number(item.price),\r\n          total: Number(item.total),\r\n          imageUrl: item.imageUrl || undefined,\r\n          variantOptions,\r\n        };\r\n      }),\r\n      totals: {\r\n        subtotal: Number(order.subtotal),\r\n        discount: Number(order.discountAmount),\r\n        shipping: Number(order.shippingAmount),\r\n        tax: Number(order.taxAmount),\r\n        total: Number(order.total),\r\n        currency: order.currency,\r\n      },\r\n      customer: {\r\n        email: order.customerEmail || undefined,\r\n        phone: order.customerPhone || undefined,\r\n      },\r\n      shippingAddress: shippingAddress,\r\n      shippingMethod: order.shippingMethod || 'pickup',\r\n      trackingNumber: order.trackingNumber || undefined,\r\n      createdAt: order.createdAt.toISOString(),\r\n      updatedAt: order.updatedAt.toISOString(),\r\n    };\r\n  }\r\n}\r\n\r\nexport const ordersService = new OrdersService();\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 800, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/app/api/v1/orders/checkout/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { authenticateToken } from \"@/lib/middleware/auth\";\r\nimport { ordersService } from \"@/lib/services/orders.service\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    console.log(\"üì¶ [ORDERS API] Checkout request received\");\r\n    const user = await authenticateToken(req);\r\n    const data = await req.json();\r\n    \r\n    console.log(\"üì¶ [ORDERS API] Checkout data:\", {\r\n      userId: user?.id,\r\n      cartId: data.cartId,\r\n      itemsCount: data.items?.length || 0,\r\n      email: data.email,\r\n      phone: data.phone,\r\n      paymentMethod: data.paymentMethod,\r\n      shippingMethod: data.shippingMethod,\r\n    });\r\n    \r\n    const result = await ordersService.checkout(data, user?.id);\r\n    \r\n    console.log(\"‚úÖ [ORDERS API] Checkout successful:\", {\r\n      orderNumber: result.order?.number,\r\n      orderId: result.order?.id,\r\n      total: result.order?.total,\r\n    });\r\n    \r\n    return NextResponse.json(result, { status: 201 });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå [ORDERS API] Checkout error:\", {\r\n      message: error?.message,\r\n      stack: error?.stack,\r\n      name: error?.name,\r\n      type: error?.type,\r\n      title: error?.title,\r\n      status: error?.status,\r\n      detail: error?.detail,\r\n      code: error?.code,\r\n      meta: error?.meta,\r\n      fullError: error,\r\n    });\r\n    return NextResponse.json(\r\n      {\r\n        type: error.type || \"https://api.shop.am/problems/internal-error\",\r\n        title: error.title || \"Internal Server Error\",\r\n        status: error.status || 500,\r\n        detail: error.detail || error.message || \"An error occurred\",\r\n        instance: req.url,\r\n      },\r\n      { status: error.status || 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,QAAQ,GAAG,CAAC;QACZ,MAAM,OAAO,MAAM,IAAA,+JAAiB,EAAC;QACrC,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,QAAQ,GAAG,CAAC,kCAAkC;YAC5C,QAAQ,MAAM;YACd,QAAQ,KAAK,MAAM;YACnB,YAAY,KAAK,KAAK,EAAE,UAAU;YAClC,OAAO,KAAK,KAAK;YACjB,OAAO,KAAK,KAAK;YACjB,eAAe,KAAK,aAAa;YACjC,gBAAgB,KAAK,cAAc;QACrC;QAEA,MAAM,SAAS,MAAM,sKAAa,CAAC,QAAQ,CAAC,MAAM,MAAM;QAExD,QAAQ,GAAG,CAAC,uCAAuC;YACjD,aAAa,OAAO,KAAK,EAAE;YAC3B,SAAS,OAAO,KAAK,EAAE;YACvB,OAAO,OAAO,KAAK,EAAE;QACvB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,QAAQ;YAAE,QAAQ;QAAI;IACjD,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,kCAAkC;YAC9C,SAAS,OAAO;YAChB,OAAO,OAAO;YACd,MAAM,OAAO;YACb,MAAM,OAAO;YACb,OAAO,OAAO;YACd,QAAQ,OAAO;YACf,QAAQ,OAAO;YACf,MAAM,OAAO;YACb,MAAM,OAAO;YACb,WAAW;QACb;QACA,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,MAAM,MAAM,IAAI,IAAI;YACpB,OAAO,MAAM,KAAK,IAAI;YACtB,QAAQ,MAAM,MAAM,IAAI;YACxB,QAAQ,MAAM,MAAM,IAAI,MAAM,OAAO,IAAI;YACzC,UAAU,IAAI,GAAG;QACnB,GACA;YAAE,QAAQ,MAAM,MAAM,IAAI;QAAI;IAElC;AACF"}}]
}