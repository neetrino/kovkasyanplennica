{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/client.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = globalThis as any;\r\n\r\n// Ensure UTF-8 encoding for PostgreSQL connection\r\n// This fixes encoding issues with Armenian and other UTF-8 characters\r\nconst databaseUrl = process.env.DATABASE_URL || '';\r\nlet urlWithEncoding = databaseUrl;\r\n\r\nif (!databaseUrl.includes('client_encoding')) {\r\n  urlWithEncoding = databaseUrl.includes('?') \r\n    ? `${databaseUrl}&client_encoding=UTF8`\r\n    : `${databaseUrl}?client_encoding=UTF8`;\r\n  \r\n  // Temporarily override DATABASE_URL for Prisma Client\r\n  process.env.DATABASE_URL = urlWithEncoding;\r\n}\r\n\r\nexport const db =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({ \r\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\r\n    errorFormat: \"pretty\",\r\n  });\r\n\r\n// Prisma Client connects automatically on first query (lazy connection)\r\n// No need to call $connect() explicitly as it can cause issues in Next.js API routes\r\n// Connection will be established automatically when the first database query is made\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db;\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAExB,kDAAkD;AAClD,sEAAsE;AACtE,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI;AAChD,IAAI,kBAAkB;AAEtB,IAAI,CAAC,YAAY,QAAQ,CAAC,oBAAoB;IAC5C,kBAAkB,YAAY,QAAQ,CAAC,OACnC,GAAG,YAAY,qBAAqB,CAAC,GACrC,GAAG,YAAY,qBAAqB,CAAC;IAEzC,sDAAsD;IACtD,QAAQ,GAAG,CAAC,YAAY,GAAG;AAC7B;AAEO,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;IAC3E,aAAa;AACf;AAEF,wEAAwE;AACxE,qFAAqF;AACrF,qFAAqF;AAErF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/index.ts"],"sourcesContent":["export * from \"./client\";\r\n\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/middleware/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport * as jwt from \"jsonwebtoken\";\r\nimport { db } from \"@white-shop/db\";\r\n\r\nexport interface AuthUser {\r\n  id: string;\r\n  email: string | null;\r\n  phone: string | null;\r\n  locale: string;\r\n  roles: string[];\r\n}\r\n\r\n/**\r\n * Authenticate JWT token from request headers\r\n */\r\nexport async function authenticateToken(\r\n  request: NextRequest\r\n): Promise<AuthUser | null> {\r\n  try {\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const token = authHeader?.split(\" \")[1]; // Bearer TOKEN\r\n\r\n    if (!token) {\r\n      return null;\r\n    }\r\n\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error(\"‚ùå [AUTH] JWT_SECRET is not set!\");\r\n      return null;\r\n    }\r\n\r\n    const decoded = jwt.verify(token, process.env.JWT_SECRET) as {\r\n      userId: string;\r\n    };\r\n\r\n    const user = await db.user.findUnique({\r\n      where: { id: decoded.userId },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        locale: true,\r\n        roles: true,\r\n        blocked: true,\r\n        deletedAt: true,\r\n      },\r\n    });\r\n\r\n    if (!user || user.blocked || user.deletedAt) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      phone: user.phone,\r\n      locale: user.locale,\r\n      roles: user.roles,\r\n    };\r\n  } catch (error) {\r\n    if (\r\n      error instanceof jwt.JsonWebTokenError ||\r\n      error instanceof jwt.TokenExpiredError\r\n    ) {\r\n      return null;\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user is admin\r\n */\r\nexport function requireAdmin(user: AuthUser | null): boolean {\r\n  if (!user) {\r\n    return false;\r\n  }\r\n  return user.roles.includes(\"admin\");\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;AAAA;;;AAaO,eAAe,kBACpB,OAAoB;IAEpB,IAAI;QACF,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,QAAQ,YAAY,MAAM,IAAI,CAAC,EAAE,EAAE,eAAe;QAExD,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;YACd,OAAO;QACT;QAEA,MAAM,UAAU,iJAAU,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;QAIxD,MAAM,OAAO,MAAM,gIAAE,CAAC,IAAI,CAAC,UAAU,CAAC;YACpC,OAAO;gBAAE,IAAI,QAAQ,MAAM;YAAC;YAC5B,QAAQ;gBACN,IAAI;gBACJ,OAAO;gBACP,OAAO;gBACP,QAAQ;gBACR,OAAO;gBACP,SAAS;gBACT,WAAW;YACb;QACF;QAEA,IAAI,CAAC,QAAQ,KAAK,OAAO,IAAI,KAAK,SAAS,EAAE;YAC3C,OAAO;QACT;QAEA,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,OAAO,KAAK,KAAK;YACjB,QAAQ,KAAK,MAAM;YACnB,OAAO,KAAK,KAAK;QACnB;IACF,EAAE,OAAO,OAAO;QACd,IACE,iBAAiB,4JAAqB,IACtC,iBAAiB,4JAAqB,EACtC;YACA,OAAO;QACT;QACA,MAAM;IACR;AACF;AAKO,SAAS,aAAa,IAAqB;IAChD,IAAI,CAAC,MAAM;QACT,OAAO;IACT;IACA,OAAO,KAAK,KAAK,CAAC,QAAQ,CAAC;AAC7B"}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/utils/variant-generator.ts"],"sourcesContent":["import { db } from \"@white-shop/db\";\r\n\r\n/**\r\n * Generate all possible combinations of AttributeValues\r\n * @param attributeValueGroups Array of arrays, where each inner array contains AttributeValue IDs for one attribute\r\n * @returns Array of arrays, where each inner array is a combination of AttributeValue IDs\r\n * \r\n * Example:\r\n * Input: [[value1, value2], [value3, value4]]\r\n * Output: [[value1, value3], [value1, value4], [value2, value3], [value2, value4]]\r\n */\r\nexport function generateAttributeCombinations(\r\n  attributeValueGroups: string[][]\r\n): string[][] {\r\n  if (attributeValueGroups.length === 0) {\r\n    return [[]];\r\n  }\r\n\r\n  if (attributeValueGroups.length === 1) {\r\n    return attributeValueGroups[0].map((value) => [value]);\r\n  }\r\n\r\n  const [firstGroup, ...restGroups] = attributeValueGroups;\r\n  const restCombinations = generateAttributeCombinations(restGroups);\r\n\r\n  const result: string[][] = [];\r\n  for (const value of firstGroup) {\r\n    for (const combination of restCombinations) {\r\n      result.push([value, ...combination]);\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Get AttributeValue IDs for a product's attributes\r\n * @param productId Product ID\r\n * @returns Map of attribute keys to arrays of AttributeValue IDs\r\n */\r\nexport async function getProductAttributeValues(\r\n  productId: string\r\n): Promise<Map<string, string[]>> {\r\n  console.log('üîç [VARIANT GENERATOR] Getting attribute values for product:', productId);\r\n\r\n  const product = await db.product.findUnique({\r\n    where: { id: productId },\r\n    include: {\r\n      productAttributes: {\r\n        include: {\r\n          attribute: {\r\n            include: {\r\n              values: {\r\n                orderBy: { position: 'asc' },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  if (!product) {\r\n    console.warn('‚ö†Ô∏è [VARIANT GENERATOR] Product not found:', productId);\r\n    return new Map();\r\n  }\r\n\r\n  const attributeValueMap = new Map<string, string[]>();\r\n\r\n  for (const productAttribute of product.productAttributes) {\r\n    const attributeKey = productAttribute.attribute.key;\r\n    const valueIds = productAttribute.attribute.values.map((v) => v.id);\r\n    attributeValueMap.set(attributeKey, valueIds);\r\n    console.log(`‚úÖ [VARIANT GENERATOR] Attribute \"${attributeKey}\" has ${valueIds.length} values`);\r\n  }\r\n\r\n  return attributeValueMap;\r\n}\r\n\r\n/**\r\n * Find or create AttributeValue by attribute key and value string\r\n * @param attributeKey Attribute key (e.g., \"color\", \"size\")\r\n * @param valueString Value string (e.g., \"Red\", \"Large\")\r\n * @param locale Locale for creating translation if needed\r\n * @returns AttributeValue ID or null if not found\r\n */\r\nexport async function findOrCreateAttributeValue(\r\n  attributeKey: string,\r\n  valueString: string,\r\n  locale: string = \"en\"\r\n): Promise<string | null> {\r\n  console.log(`üîç [VARIANT GENERATOR] Finding/Creating AttributeValue: ${attributeKey} = ${valueString}`);\r\n\r\n  // Find attribute by key\r\n  const attribute = await db.attribute.findUnique({\r\n    where: { key: attributeKey },\r\n    include: {\r\n      values: {\r\n        where: {\r\n          value: valueString,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  if (!attribute) {\r\n    console.warn(`‚ö†Ô∏è [VARIANT GENERATOR] Attribute not found: ${attributeKey}`);\r\n    return null;\r\n  }\r\n\r\n  // If value exists, return its ID\r\n  if (attribute.values.length > 0) {\r\n    console.log(`‚úÖ [VARIANT GENERATOR] Found existing AttributeValue: ${attribute.values[0].id}`);\r\n    return attribute.values[0].id;\r\n  }\r\n\r\n  // Create new AttributeValue\r\n  const newValue = await db.attributeValue.create({\r\n    data: {\r\n      attributeId: attribute.id,\r\n      value: valueString,\r\n      translations: {\r\n        create: {\r\n          locale,\r\n          label: valueString,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  console.log(`‚úÖ [VARIANT GENERATOR] Created new AttributeValue: ${newValue.id}`);\r\n  return newValue.id;\r\n}\r\n\r\n/**\r\n * Generate variants for a product based on its attributes\r\n * @param productId Product ID\r\n * @param variantData Base variant data (price, stock, etc.)\r\n * @returns Array of variant data objects ready for creation\r\n */\r\nexport async function generateVariantsFromAttributes(\r\n  productId: string,\r\n  variantData: {\r\n    price: number;\r\n    compareAtPrice?: number;\r\n    stock?: number;\r\n    sku?: string;\r\n    imageUrl?: string;\r\n    published?: boolean;\r\n  }\r\n): Promise<Array<{\r\n  price: number;\r\n  compareAtPrice?: number;\r\n  stock: number;\r\n  sku?: string;\r\n  imageUrl?: string;\r\n  published: boolean;\r\n  options: Array<{ valueId: string }>;\r\n}>> {\r\n  console.log('üöÄ [VARIANT GENERATOR] Generating variants for product:', productId);\r\n\r\n  const attributeValueMap = await getProductAttributeValues(productId);\r\n\r\n  if (attributeValueMap.size === 0) {\r\n    console.log('‚ö†Ô∏è [VARIANT GENERATOR] No attributes found, creating single variant');\r\n    return [\r\n      {\r\n        ...variantData,\r\n        stock: variantData.stock || 0,\r\n        published: variantData.published !== false,\r\n        options: [],\r\n      },\r\n    ];\r\n  }\r\n\r\n  // Convert map to array of arrays\r\n  const attributeValueGroups = Array.from(attributeValueMap.values());\r\n\r\n  // Generate all combinations\r\n  const combinations = generateAttributeCombinations(attributeValueGroups);\r\n\r\n  console.log(`‚úÖ [VARIANT GENERATOR] Generated ${combinations.length} variant combinations`);\r\n\r\n  // Create variant data for each combination\r\n  const variants = combinations.map((combination, index) => {\r\n    const options = combination.map((valueId) => ({ valueId }));\r\n\r\n    // Generate SKU if not provided\r\n    let sku = variantData.sku;\r\n    if (!sku && combinations.length > 1) {\r\n      const baseSku = `VAR-${productId.slice(-6)}-${index + 1}`;\r\n      sku = baseSku;\r\n    }\r\n\r\n    return {\r\n      price: variantData.price,\r\n      compareAtPrice: variantData.compareAtPrice,\r\n      stock: variantData.stock || 0,\r\n      sku,\r\n      imageUrl: variantData.imageUrl,\r\n      published: variantData.published !== false,\r\n      options,\r\n    };\r\n  });\r\n\r\n  return variants;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 337, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/utils/db-ensure.ts"],"sourcesContent":["import { db } from \"@white-shop/db\";\r\n\r\n// Cache to track if table check has been performed\r\nlet tableChecked = false;\r\nlet tableExists = false;\r\n\r\n// Cache for product_reviews table\r\nlet reviewsTableChecked = false;\r\nlet reviewsTableExists = false;\r\n\r\n// Cache for product_variants.attributes column\r\nlet attributesColumnChecked = false;\r\nlet attributesColumnExists = false;\r\n\r\n/**\r\n * Ensures the product_attributes table exists in the database\r\n * This is a fallback mechanism for Vercel deployments where migrations might not run automatically\r\n * Uses lazy initialization - checks only once per process\r\n * \r\n * @returns Promise<boolean> - true if table exists or was created, false if creation failed\r\n */\r\nexport async function ensureProductAttributesTable(): Promise<boolean> {\r\n  // If already checked and exists, return immediately\r\n  if (tableChecked && tableExists) {\r\n    return true;\r\n  }\r\n  try {\r\n    // Try to query the table to check if it exists\r\n    await db.$queryRaw`SELECT 1 FROM \"product_attributes\" LIMIT 1`;\r\n    tableChecked = true;\r\n    tableExists = true;\r\n    return true;\r\n  } catch (error: any) {\r\n    // If table doesn't exist, create it\r\n    if (\r\n      error?.code === 'P2021' || \r\n      error?.message?.includes('does not exist') ||\r\n      error?.message?.includes('product_attributes')\r\n    ) {\r\n      console.log('üîß [DB UTILS] product_attributes table not found, creating...');\r\n      \r\n      try {\r\n        // Create table if it doesn't exist\r\n        await db.$executeRaw`\r\n          CREATE TABLE IF NOT EXISTS \"product_attributes\" (\r\n            \"id\" TEXT NOT NULL,\r\n            \"productId\" TEXT NOT NULL,\r\n            \"attributeId\" TEXT NOT NULL,\r\n            \"createdAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n            \"updatedAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n            CONSTRAINT \"product_attributes_pkey\" PRIMARY KEY (\"id\")\r\n          )\r\n        `;\r\n\r\n        // Create unique index if it doesn't exist\r\n        await db.$executeRaw`\r\n          CREATE UNIQUE INDEX IF NOT EXISTS \"product_attributes_productId_attributeId_key\" \r\n          ON \"product_attributes\"(\"productId\", \"attributeId\")\r\n        `;\r\n\r\n        // Create indexes if they don't exist\r\n        await db.$executeRaw`\r\n          CREATE INDEX IF NOT EXISTS \"product_attributes_productId_idx\" \r\n          ON \"product_attributes\"(\"productId\")\r\n        `;\r\n\r\n        await db.$executeRaw`\r\n          CREATE INDEX IF NOT EXISTS \"product_attributes_attributeId_idx\" \r\n          ON \"product_attributes\"(\"attributeId\")\r\n        `;\r\n\r\n        // Add foreign key constraints if they don't exist\r\n        // Check and add productId foreign key\r\n        const productFkExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_constraint \r\n            WHERE conname = 'product_attributes_productId_fkey'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!productFkExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            ALTER TABLE \"product_attributes\" \r\n            ADD CONSTRAINT \"product_attributes_productId_fkey\" \r\n            FOREIGN KEY (\"productId\") \r\n            REFERENCES \"products\"(\"id\") \r\n            ON DELETE CASCADE ON UPDATE CASCADE\r\n          `;\r\n        }\r\n\r\n        // Check and add attributeId foreign key\r\n        const attributeFkExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_constraint \r\n            WHERE conname = 'product_attributes_attributeId_fkey'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!attributeFkExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            ALTER TABLE \"product_attributes\" \r\n            ADD CONSTRAINT \"product_attributes_attributeId_fkey\" \r\n            FOREIGN KEY (\"attributeId\") \r\n            REFERENCES \"attributes\"(\"id\") \r\n            ON DELETE CASCADE ON UPDATE CASCADE\r\n          `;\r\n        }\r\n\r\n        // Create trigger for updatedAt (if it doesn't exist)\r\n        const triggerExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_trigger \r\n            WHERE tgname = 'product_attributes_updated_at'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!triggerExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            CREATE OR REPLACE FUNCTION update_updated_at_column()\r\n            RETURNS TRIGGER AS $$\r\n            BEGIN\r\n              NEW.\"updatedAt\" = CURRENT_TIMESTAMP;\r\n              RETURN NEW;\r\n            END;\r\n            $$ language 'plpgsql';\r\n\r\n            CREATE TRIGGER product_attributes_updated_at\r\n            BEFORE UPDATE ON \"product_attributes\"\r\n            FOR EACH ROW\r\n            EXECUTE FUNCTION update_updated_at_column();\r\n          `;\r\n        }\r\n\r\n        console.log('‚úÖ [DB UTILS] product_attributes table created successfully');\r\n        tableChecked = true;\r\n        tableExists = true;\r\n        return true;\r\n      } catch (createError: any) {\r\n        console.error('‚ùå [DB UTILS] Failed to create product_attributes table:', {\r\n          message: createError?.message,\r\n          code: createError?.code,\r\n        });\r\n        tableChecked = true;\r\n        tableExists = false;\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Other errors - log and return false\r\n    console.error('‚ùå [DB UTILS] Unexpected error checking product_attributes table:', {\r\n      message: error?.message,\r\n      code: error?.code,\r\n    });\r\n    tableChecked = true;\r\n    tableExists = false;\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Ensures the product_reviews table exists in the database\r\n * This is a fallback mechanism for deployments where migrations might not run automatically\r\n * Uses lazy initialization - checks only once per process\r\n * \r\n * @returns Promise<boolean> - true if table exists or was created, false if creation failed\r\n */\r\nexport async function ensureProductReviewsTable(): Promise<boolean> {\r\n  // If already checked and exists, return immediately\r\n  if (reviewsTableChecked && reviewsTableExists) {\r\n    return true;\r\n  }\r\n  try {\r\n    // Try to query the table to check if it exists\r\n    await db.$queryRaw`SELECT 1 FROM \"product_reviews\" LIMIT 1`;\r\n    reviewsTableChecked = true;\r\n    reviewsTableExists = true;\r\n    return true;\r\n  } catch (error: any) {\r\n    // If table doesn't exist, create it\r\n    if (\r\n      error?.code === 'P2021' || \r\n      error?.message?.includes('does not exist') ||\r\n      error?.message?.includes('product_reviews')\r\n    ) {\r\n      console.log('üîß [DB UTILS] product_reviews table not found, creating...');\r\n      \r\n      try {\r\n        // Create table if it doesn't exist\r\n        await db.$executeRaw`\r\n          CREATE TABLE IF NOT EXISTS \"product_reviews\" (\r\n            \"id\" TEXT NOT NULL,\r\n            \"productId\" TEXT NOT NULL,\r\n            \"userId\" TEXT NOT NULL,\r\n            \"rating\" INTEGER NOT NULL,\r\n            \"comment\" TEXT,\r\n            \"published\" BOOLEAN NOT NULL DEFAULT true,\r\n            \"createdAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n            \"updatedAt\" TIMESTAMP(3) NOT NULL,\r\n            CONSTRAINT \"product_reviews_pkey\" PRIMARY KEY (\"id\")\r\n          )\r\n        `;\r\n\r\n        // Create indexes if they don't exist\r\n        await db.$executeRaw`\r\n          CREATE INDEX IF NOT EXISTS \"product_reviews_productId_idx\" \r\n          ON \"product_reviews\"(\"productId\")\r\n        `;\r\n\r\n        await db.$executeRaw`\r\n          CREATE INDEX IF NOT EXISTS \"product_reviews_userId_idx\" \r\n          ON \"product_reviews\"(\"userId\")\r\n        `;\r\n\r\n        await db.$executeRaw`\r\n          CREATE INDEX IF NOT EXISTS \"product_reviews_published_createdAt_idx\" \r\n          ON \"product_reviews\"(\"published\", \"createdAt\" DESC)\r\n        `;\r\n\r\n        // Create unique constraint (one review per user per product)\r\n        await db.$executeRaw`\r\n          CREATE UNIQUE INDEX IF NOT EXISTS \"product_reviews_productId_userId_key\" \r\n          ON \"product_reviews\"(\"productId\", \"userId\")\r\n        `;\r\n\r\n        // Add foreign key constraints if they don't exist\r\n        // Check and add productId foreign key\r\n        const productFkExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_constraint \r\n            WHERE conname = 'product_reviews_productId_fkey'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!productFkExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            ALTER TABLE \"product_reviews\" \r\n            ADD CONSTRAINT \"product_reviews_productId_fkey\" \r\n            FOREIGN KEY (\"productId\") \r\n            REFERENCES \"products\"(\"id\") \r\n            ON DELETE CASCADE ON UPDATE CASCADE\r\n          `;\r\n        }\r\n\r\n        // Check and add userId foreign key\r\n        const userFkExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_constraint \r\n            WHERE conname = 'product_reviews_userId_fkey'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!userFkExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            ALTER TABLE \"product_reviews\" \r\n            ADD CONSTRAINT \"product_reviews_userId_fkey\" \r\n            FOREIGN KEY (\"userId\") \r\n            REFERENCES \"users\"(\"id\") \r\n            ON DELETE CASCADE ON UPDATE CASCADE\r\n          `;\r\n        }\r\n\r\n        // Create trigger for updatedAt (if it doesn't exist)\r\n        const triggerExists = await db.$queryRaw<Array<{ exists: boolean }>>`\r\n          SELECT EXISTS (\r\n            SELECT 1 FROM pg_trigger \r\n            WHERE tgname = 'product_reviews_updated_at'\r\n          ) as exists\r\n        `;\r\n\r\n        if (!triggerExists[0]?.exists) {\r\n          await db.$executeRaw`\r\n            CREATE OR REPLACE FUNCTION update_updated_at_column()\r\n            RETURNS TRIGGER AS $$\r\n            BEGIN\r\n              NEW.\"updatedAt\" = CURRENT_TIMESTAMP;\r\n              RETURN NEW;\r\n            END;\r\n            $$ language 'plpgsql';\r\n\r\n            CREATE TRIGGER product_reviews_updated_at\r\n            BEFORE UPDATE ON \"product_reviews\"\r\n            FOR EACH ROW\r\n            EXECUTE FUNCTION update_updated_at_column();\r\n          `;\r\n        }\r\n\r\n        console.log('‚úÖ [DB UTILS] product_reviews table created successfully');\r\n        reviewsTableChecked = true;\r\n        reviewsTableExists = true;\r\n        return true;\r\n      } catch (createError: any) {\r\n        console.error('‚ùå [DB UTILS] Failed to create product_reviews table:', {\r\n          message: createError?.message,\r\n          code: createError?.code,\r\n        });\r\n        reviewsTableChecked = true;\r\n        reviewsTableExists = false;\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Other errors - log and return false\r\n    console.error('‚ùå [DB UTILS] Unexpected error checking product_reviews table:', {\r\n      message: error?.message,\r\n      code: error?.code,\r\n    });\r\n    reviewsTableChecked = true;\r\n    reviewsTableExists = false;\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Ensures the attributes column exists in the product_variants table\r\n * This is a fallback mechanism for Vercel deployments where migrations might not run automatically\r\n * Uses lazy initialization - checks only once per process\r\n * \r\n * @returns Promise<boolean> - true if column exists or was created, false if creation failed\r\n */\r\nexport async function ensureProductVariantAttributesColumn(): Promise<boolean> {\r\n  // If already checked and exists, return immediately\r\n  if (attributesColumnChecked && attributesColumnExists) {\r\n    return true;\r\n  }\r\n  \r\n  try {\r\n    // Try to query the column to check if it exists\r\n    await db.$queryRaw`SELECT \"attributes\" FROM \"product_variants\" LIMIT 1`;\r\n    attributesColumnChecked = true;\r\n    attributesColumnExists = true;\r\n    return true;\r\n  } catch (error: any) {\r\n    // If column doesn't exist, create it\r\n    if (\r\n      error?.code === 'P2022' || \r\n      error?.message?.includes('does not exist') ||\r\n      error?.message?.includes('product_variants.attributes') ||\r\n      (error?.message?.includes('column') && error?.message?.includes('attributes'))\r\n    ) {\r\n      console.log('üîß [DB UTILS] product_variants.attributes column not found, creating...');\r\n      \r\n      try {\r\n        // Add the attributes JSONB column if it doesn't exist\r\n        await db.$executeRaw`\r\n          ALTER TABLE \"product_variants\" \r\n          ADD COLUMN IF NOT EXISTS \"attributes\" JSONB\r\n        `;\r\n        \r\n        console.log('‚úÖ [DB UTILS] product_variants.attributes column created successfully');\r\n        attributesColumnChecked = true;\r\n        attributesColumnExists = true;\r\n        return true;\r\n      } catch (createError: any) {\r\n        console.error('‚ùå [DB UTILS] Failed to create product_variants.attributes column:', {\r\n          message: createError?.message,\r\n          code: createError?.code,\r\n        });\r\n        attributesColumnChecked = true;\r\n        attributesColumnExists = false;\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // Other errors - log and return false\r\n    console.error('‚ùå [DB UTILS] Unexpected error checking product_variants.attributes column:', {\r\n      message: error?.message,\r\n      code: error?.code,\r\n    });\r\n    attributesColumnChecked = true;\r\n    attributesColumnExists = false;\r\n    return false;\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 655, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/utils/image-utils.ts"],"sourcesContent":["/**\r\n * Unified image URL utilities for consistent handling across the application\r\n */\r\n\r\nimport imageCompression from 'browser-image-compression';\r\n\r\n/**\r\n * Validates if a URL is a valid image URL\r\n */\r\nexport function isValidImageUrl(url: any): boolean {\r\n  if (!url) return false;\r\n  \r\n  const urlStr = typeof url === 'string' ? url.trim() : '';\r\n  if (!urlStr) return false;\r\n  \r\n  // Base64 images are valid\r\n  if (urlStr.startsWith('data:image/')) return true;\r\n  \r\n  // HTTP/HTTPS URLs are valid\r\n  if (urlStr.startsWith('http://') || urlStr.startsWith('https://')) return true;\r\n  \r\n  // Relative paths starting with / are valid\r\n  if (urlStr.startsWith('/')) return true;\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Processes and normalizes an image URL from various formats\r\n * Returns null if invalid\r\n */\r\nexport function processImageUrl(url: any): string | null {\r\n  if (!url) return null;\r\n  \r\n  let finalUrl = '';\r\n  if (typeof url === 'string') {\r\n    finalUrl = url.trim();\r\n  } else if (typeof url === 'object' && url !== null) {\r\n    finalUrl = (url.url || url.src || url.value || '').trim();\r\n  }\r\n  \r\n  if (!finalUrl) return null;\r\n  \r\n  // Validate\r\n  if (!isValidImageUrl(finalUrl)) {\r\n    return null;\r\n  }\r\n  \r\n  // For base64 or full URLs, return as-is\r\n  if (finalUrl.startsWith('data:') || finalUrl.startsWith('http://') || finalUrl.startsWith('https://')) {\r\n    return finalUrl;\r\n  }\r\n  \r\n  // For relative paths, ensure they start with /\r\n  if (finalUrl.startsWith('/')) {\r\n    return finalUrl;\r\n  }\r\n  \r\n  return `/${finalUrl}`;\r\n}\r\n\r\n/**\r\n * Smart split for comma-separated image URLs that handles Base64 data URIs\r\n * Base64 strings can contain commas, so we need special handling\r\n */\r\nexport function smartSplitUrls(str: string | null | undefined): string[] {\r\n  if (!str) return [];\r\n  \r\n  // If no base64, simple split\r\n  if (!str.includes('data:image/')) {\r\n    return str.split(',').map(s => s.trim()).filter(Boolean);\r\n  }\r\n  \r\n  // Handle base64 - split carefully\r\n  // Base64 format: data:image/type;base64,<base64data>\r\n  // The comma after base64, is the separator, but base64 data itself can contain commas\r\n  // We need to find the comma that separates base64 header from data, then find the next URL separator\r\n  \r\n  const results: string[] = [];\r\n  let i = 0;\r\n  \r\n  while (i < str.length) {\r\n    if (str.substring(i).startsWith('data:image/')) {\r\n      // Found start of base64 image\r\n      // Find the comma after base64, (this is the separator between header and data)\r\n      const headerEnd = str.indexOf(',', i);\r\n      if (headerEnd === -1) {\r\n        // No comma found, treat entire rest as base64\r\n        results.push(str.substring(i).trim());\r\n        break;\r\n      }\r\n      \r\n      // Find the next comma that's likely a URL separator (followed by whitespace and another URL pattern)\r\n      // Or find end of string\r\n      let nextSeparator = str.length;\r\n      for (let j = headerEnd + 1; j < str.length; j++) {\r\n        if (str[j] === ',') {\r\n          // Check if this comma is followed by a URL pattern (not part of base64)\r\n          const afterComma = str.substring(j + 1).trim();\r\n          if (afterComma.startsWith('data:image/') || \r\n              afterComma.startsWith('http://') || \r\n              afterComma.startsWith('https://') ||\r\n              afterComma.startsWith('/')) {\r\n            nextSeparator = j;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Extract base64 image (from start to separator)\r\n      const base64Image = str.substring(i, nextSeparator).trim();\r\n      if (base64Image) {\r\n        results.push(base64Image);\r\n      }\r\n      \r\n      i = nextSeparator + 1;\r\n    } else {\r\n      // Regular URL - find next comma or end\r\n      const nextComma = str.indexOf(',', i);\r\n      if (nextComma === -1) {\r\n        // No more commas, add rest as single URL\r\n        const url = str.substring(i).trim();\r\n        if (url) {\r\n          results.push(url);\r\n        }\r\n        break;\r\n      } else {\r\n        // Add URL up to comma\r\n        const url = str.substring(i, nextComma).trim();\r\n        if (url) {\r\n          results.push(url);\r\n        }\r\n        i = nextComma + 1;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return results.filter(Boolean);\r\n}\r\n\r\n/**\r\n * Normalizes URL for comparison (ensures consistent format for deduplication)\r\n * Returns normalized string for exact matching\r\n */\r\nexport function normalizeUrlForComparison(url: string): string {\r\n  if (!url) return '';\r\n  \r\n  // Base64 images - return as-is (exact match required)\r\n  if (url.startsWith('data:')) {\r\n    return url;\r\n  }\r\n  \r\n  // HTTP/HTTPS URLs - return as-is (exact match)\r\n  if (url.startsWith('http://') || url.startsWith('https://')) {\r\n    return url;\r\n  }\r\n  \r\n  // Relative paths - normalize to start with /\r\n  const trimmed = url.trim();\r\n  if (trimmed.startsWith('/')) {\r\n    return trimmed;\r\n  }\r\n  \r\n  return `/${trimmed}`;\r\n}\r\n\r\n/**\r\n * Gets all normalized variations of a URL for comparison\r\n * Useful when comparing URLs that might have different formats\r\n */\r\nexport function getUrlVariations(url: string): string[] {\r\n  if (!url) return [];\r\n  \r\n  const normalized = normalizeUrlForComparison(url);\r\n  const variations = new Set<string>([normalized]);\r\n  \r\n  // For relative paths, add variations with/without leading slash\r\n  if (!normalized.startsWith('data:') && !normalized.startsWith('http')) {\r\n    if (normalized.startsWith('/')) {\r\n      variations.add(normalized.substring(1));\r\n      variations.add(normalized);\r\n    } else {\r\n      variations.add(normalized);\r\n      variations.add(`/${normalized}`);\r\n    }\r\n    \r\n    // Also add without query params\r\n    const withoutQuery = normalized.split('?')[0];\r\n    if (withoutQuery !== normalized) {\r\n      variations.add(withoutQuery);\r\n      if (withoutQuery.startsWith('/')) {\r\n        variations.add(withoutQuery.substring(1));\r\n      } else {\r\n        variations.add(`/${withoutQuery}`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  return Array.from(variations);\r\n}\r\n\r\n/**\r\n * Cleans and validates an array of image URLs\r\n * Removes invalid, empty, and duplicate URLs\r\n */\r\nexport function cleanImageUrls(urls: (string | any)[]): string[] {\r\n  if (!Array.isArray(urls)) return [];\r\n  \r\n  const seen = new Set<string>();\r\n  const cleaned: string[] = [];\r\n  \r\n  for (const url of urls) {\r\n    const processed = processImageUrl(url);\r\n    if (!processed) continue;\r\n    \r\n    const normalized = normalizeUrlForComparison(processed);\r\n    if (seen.has(normalized)) continue;\r\n    \r\n    seen.add(normalized);\r\n    cleaned.push(processed);\r\n  }\r\n  \r\n  return cleaned;\r\n}\r\n\r\n/**\r\n * Separates main images from variant images\r\n * Removes variant images from main images array to prevent duplication\r\n */\r\nexport function separateMainAndVariantImages(\r\n  mainImages: (string | any)[],\r\n  variantImages: (string | any)[]\r\n): {\r\n  main: string[];\r\n  variants: string[];\r\n} {\r\n  // Process and normalize all variant images\r\n  const variantUrlSet = new Set<string>();\r\n  const variantVariationsMap = new Map<string, string[]>();\r\n  \r\n  for (const variantImg of variantImages) {\r\n    const processed = processImageUrl(variantImg);\r\n    if (!processed) continue;\r\n    \r\n    const normalized = normalizeUrlForComparison(processed);\r\n    variantUrlSet.add(normalized);\r\n    \r\n    // Store all variations for this URL\r\n    const variations = getUrlVariations(processed);\r\n    variations.forEach(v => variantVariationsMap.set(v, variations));\r\n  }\r\n  \r\n  // Process main images and filter out those that match variants\r\n  const mainProcessed: string[] = [];\r\n  const seenMain = new Set<string>();\r\n  \r\n  for (const mainImg of mainImages) {\r\n    const processed = processImageUrl(mainImg);\r\n    if (!processed) continue;\r\n    \r\n    const normalized = normalizeUrlForComparison(processed);\r\n    \r\n    // Check if this main image matches any variant image\r\n    const isVariantImage = variantUrlSet.has(normalized) || \r\n                          variantVariationsMap.has(normalized) ||\r\n                          Array.from(variantVariationsMap.values()).some(variations => \r\n                            variations.some(v => {\r\n                              const mainVariations = getUrlVariations(processed);\r\n                              return mainVariations.includes(v);\r\n                            })\r\n                          );\r\n    \r\n    if (isVariantImage) {\r\n      continue; // Skip - this is a variant image\r\n    }\r\n    \r\n    // Check for duplicates in main images\r\n    if (seenMain.has(normalized)) {\r\n      continue;\r\n    }\r\n    \r\n    seenMain.add(normalized);\r\n    mainProcessed.push(processed);\r\n  }\r\n  \r\n  // Process variant images (already validated above)\r\n  const variantProcessed: string[] = [];\r\n  const seenVariant = new Set<string>();\r\n  \r\n  for (const variantImg of variantImages) {\r\n    const processed = processImageUrl(variantImg);\r\n    if (!processed) continue;\r\n    \r\n    const normalized = normalizeUrlForComparison(processed);\r\n    if (seenVariant.has(normalized)) continue;\r\n    \r\n    seenVariant.add(normalized);\r\n    variantProcessed.push(processed);\r\n  }\r\n  \r\n  return {\r\n    main: mainProcessed,\r\n    variants: variantProcessed,\r\n  };\r\n}\r\n\r\n/**\r\n * Processes an image file with compression, EXIF orientation correction, and size optimization\r\n * Automatically handles:\r\n * - EXIF orientation (rotates image correctly)\r\n * - Resize to max dimensions (1920x1920 by default)\r\n * - Compression to reduce file size (maxSizeMB: 2MB by default)\r\n * \r\n * @param file - The image file to process\r\n * @param options - Processing options\r\n * @returns Promise<string> - Base64 data URL of processed image\r\n */\r\nexport async function processImageFile(\r\n  file: File,\r\n  options?: {\r\n    maxSizeMB?: number; // Maximum file size in MB (default: 2)\r\n    maxWidthOrHeight?: number; // Maximum width or height in pixels (default: 1920)\r\n    useWebWorker?: boolean; // Use web worker for processing (default: true)\r\n    fileType?: string; // Output file type (default: 'image/jpeg')\r\n    initialQuality?: number; // Initial quality 0-1 (default: 0.8)\r\n  }\r\n): Promise<string> {\r\n  try {\r\n    console.log('üñºÔ∏è [IMAGE PROCESSING] Starting image processing:', {\r\n      fileName: file.name,\r\n      originalSize: `${Math.round(file.size / 1024)}KB`,\r\n      type: file.type\r\n    });\r\n\r\n    const {\r\n      maxSizeMB = 2,\r\n      maxWidthOrHeight = 1920,\r\n      useWebWorker = true,\r\n      fileType = 'image/jpeg',\r\n      initialQuality = 0.8\r\n    } = options || {};\r\n\r\n    // Process image with compression and EXIF orientation correction\r\n    // browser-image-compression automatically handles EXIF orientation\r\n    const compressedFile = await imageCompression(file, {\r\n      maxSizeMB,\r\n      maxWidthOrHeight,\r\n      useWebWorker,\r\n      fileType,\r\n      initialQuality,\r\n      // EXIF orientation is automatically handled by browser-image-compression\r\n    });\r\n\r\n    console.log('‚úÖ [IMAGE PROCESSING] Image processed successfully:', {\r\n      originalSize: `${Math.round(file.size / 1024)}KB`,\r\n      compressedSize: `${Math.round(compressedFile.size / 1024)}KB`,\r\n      reduction: `${Math.round((1 - compressedFile.size / file.size) * 100)}%`\r\n    });\r\n\r\n    // Convert to base64\r\n    return new Promise<string>((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        const result = reader.result as string;\r\n        console.log('‚úÖ [IMAGE PROCESSING] Image converted to base64, length:', result.length);\r\n        resolve(result);\r\n      };\r\n      reader.onerror = (error) => {\r\n        console.error('‚ùå [IMAGE PROCESSING] Error converting to base64:', error);\r\n        reject(new Error('Failed to convert image to base64'));\r\n      };\r\n      reader.readAsDataURL(compressedFile);\r\n    });\r\n  } catch (error: any) {\r\n    console.error('‚ùå [IMAGE PROCESSING] Error processing image:', error);\r\n    throw new Error(error?.message || 'Failed to process image');\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 930, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/services/admin.service.ts"],"sourcesContent":["\r\nimport { db } from \"@white-shop/db\";\r\nimport { revalidatePath, revalidateTag } from \"next/cache\";\r\nimport { findOrCreateAttributeValue } from \"../utils/variant-generator\";\r\nimport { ensureProductAttributesTable, ensureProductVariantAttributesColumn } from \"../utils/db-ensure\";\r\nimport {\r\n  processImageUrl,\r\n  smartSplitUrls,\r\n  cleanImageUrls,\r\n  separateMainAndVariantImages,\r\n} from \"../utils/image-utils\";\r\n\r\nclass AdminService {\r\n  /**\r\n   * Ensure colors and imageUrl columns exist in attribute_values table\r\n   * This is a runtime migration that runs automatically when needed\r\n   */\r\n  private async ensureColorsColumnsExist() {\r\n    try {\r\n      // Check if colors column exists\r\n      const colorsCheck = await db.$queryRawUnsafe(`\r\n        SELECT EXISTS (\r\n          SELECT 1 \r\n          FROM information_schema.columns \r\n          WHERE table_schema = 'public'\r\n          AND table_name = 'attribute_values' \r\n          AND column_name = 'colors'\r\n        ) as exists;\r\n      `) as Array<{ exists: boolean }>;\r\n\r\n      const colorsExists = colorsCheck[0]?.exists || false;\r\n\r\n      // Check if imageUrl column exists\r\n      const imageUrlCheck = await db.$queryRawUnsafe(`\r\n        SELECT EXISTS (\r\n          SELECT 1 \r\n          FROM information_schema.columns \r\n          WHERE table_schema = 'public'\r\n          AND table_name = 'attribute_values' \r\n          AND column_name = 'imageUrl'\r\n        ) as exists;\r\n      `) as Array<{ exists: boolean }>;\r\n\r\n      const imageUrlExists = imageUrlCheck[0]?.exists || false;\r\n\r\n      if (colorsExists && imageUrlExists) {\r\n        return; // Columns already exist\r\n      }\r\n\r\n      console.log('üìù [ADMIN SERVICE] Adding missing colors/imageUrl columns...');\r\n\r\n      // Add colors column if it doesn't exist\r\n      if (!colorsExists) {\r\n        await db.$executeRawUnsafe(`\r\n          ALTER TABLE \"attribute_values\" ADD COLUMN IF NOT EXISTS \"colors\" JSONB DEFAULT '[]'::jsonb;\r\n        `);\r\n        console.log('‚úÖ [ADMIN SERVICE] Added \"colors\" column');\r\n      }\r\n\r\n      // Add imageUrl column if it doesn't exist\r\n      if (!imageUrlExists) {\r\n        await db.$executeRawUnsafe(`\r\n          ALTER TABLE \"attribute_values\" ADD COLUMN IF NOT EXISTS \"imageUrl\" TEXT;\r\n        `);\r\n        console.log('‚úÖ [ADMIN SERVICE] Added \"imageUrl\" column');\r\n      }\r\n\r\n      // Create index if it doesn't exist\r\n      await db.$executeRawUnsafe(`\r\n        CREATE INDEX IF NOT EXISTS \"attribute_values_colors_idx\" \r\n        ON \"attribute_values\" USING GIN (\"colors\");\r\n      `);\r\n\r\n      console.log('‚úÖ [ADMIN SERVICE] Migration completed successfully!');\r\n    } catch (error: any) {\r\n      console.error('‚ùå [ADMIN SERVICE] Migration error:', error.message);\r\n      throw error; // Re-throw to handle in calling code\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get dashboard stats\r\n   */\r\n  async getStats() {\r\n    // Count users\r\n    const totalUsers = await db.user.count({\r\n      where: { deletedAt: null },\r\n    });\r\n\r\n    // Count products\r\n    const totalProducts = await db.product.count({\r\n      where: { deletedAt: null },\r\n    });\r\n\r\n    // Count products with low stock (stock < 10)\r\n    const lowStockProducts = await db.productVariant.count({\r\n      where: {\r\n        stock: { lt: 10 },\r\n        published: true,\r\n      },\r\n    });\r\n\r\n    // Count orders\r\n    const totalOrders = await db.order.count();\r\n\r\n    // Count recent orders (last 7 days)\r\n    const sevenDaysAgo = new Date();\r\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n    const recentOrders = await db.order.count({\r\n      where: {\r\n        createdAt: { gte: sevenDaysAgo },\r\n      },\r\n    });\r\n\r\n    // Count pending orders\r\n    const pendingOrders = await db.order.count({\r\n      where: { status: \"pending\" },\r\n    });\r\n\r\n    // Calculate total revenue from completed/paid orders\r\n    const completedOrders = await db.order.findMany({\r\n      where: {\r\n        OR: [\r\n          { status: \"completed\" },\r\n          { paymentStatus: \"paid\" },\r\n        ],\r\n      },\r\n      select: {\r\n        total: true,\r\n        currency: true,\r\n      },\r\n    });\r\n\r\n    const totalRevenue = completedOrders.reduce((sum: number, order: { total: number; currency: string | null }) => sum + order.total, 0);\r\n    const currency = completedOrders[0]?.currency || \"AMD\";\r\n\r\n    return {\r\n      users: {\r\n        total: totalUsers,\r\n      },\r\n      products: {\r\n        total: totalProducts,\r\n        lowStock: lowStockProducts,\r\n      },\r\n      orders: {\r\n        total: totalOrders,\r\n        recent: recentOrders,\r\n        pending: pendingOrders,\r\n      },\r\n      revenue: {\r\n        total: totalRevenue,\r\n        currency,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get users\r\n   */\r\n  async getUsers(_filters: any) {\r\n    const users = await db.user.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n      },\r\n      take: 100,\r\n      orderBy: { createdAt: \"desc\" },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        roles: true,\r\n        blocked: true,\r\n        createdAt: true,\r\n        _count: {\r\n          select: {\r\n            orders: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    return {\r\n      data: users.map((user: { id: string; email: string | null; phone: string | null; firstName: string | null; lastName: string | null; roles: string[] | null; blocked: boolean; createdAt: Date; _count?: { orders?: number } }) => ({\r\n        id: user.id,\r\n        email: user.email,\r\n        phone: user.phone,\r\n        firstName: user.firstName,\r\n        lastName: user.lastName,\r\n        roles: user.roles,\r\n        blocked: user.blocked,\r\n        createdAt: user.createdAt,\r\n        ordersCount: user._count?.orders ?? 0,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update user\r\n   */\r\n  async updateUser(userId: string, data: any) {\r\n    return await db.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        blocked: data.blocked,\r\n        roles: data.roles,\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        roles: true,\r\n        blocked: true,\r\n        createdAt: true,\r\n        updatedAt: true,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete user (soft delete)\r\n   */\r\n  async deleteUser(userId: string) {\r\n    const user = await db.user.findUnique({\r\n      where: { id: userId },\r\n      select: { id: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"User not found\",\r\n        detail: `User with id '${userId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    await db.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        deletedAt: new Date(),\r\n        blocked: true,\r\n      },\r\n      select: { id: true },\r\n    });\r\n\r\n    return { success: true };\r\n  }\r\n\r\n  /**\r\n   * Get orders with filters and pagination\r\n   */\r\n  async getOrders(filters: {\r\n    page?: number;\r\n    limit?: number;\r\n    status?: string;\r\n    paymentStatus?: string;\r\n    search?: string;\r\n    sortBy?: string;\r\n    sortOrder?: 'asc' | 'desc';\r\n  } = {}) {\r\n    const page = filters.page || 1;\r\n    const limit = filters.limit || 20;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where: any = {};\r\n\r\n    // Build AND conditions array\r\n    const andConditions: any[] = [];\r\n\r\n    // Apply status filter\r\n    if (filters.status) {\r\n      andConditions.push({ status: filters.status });\r\n    }\r\n\r\n    // Apply payment status filter\r\n    if (filters.paymentStatus) {\r\n      andConditions.push({ paymentStatus: filters.paymentStatus });\r\n    }\r\n\r\n    // Apply search filter\r\n    if (filters.search && filters.search.trim()) {\r\n      const searchTerm = filters.search.trim();\r\n      andConditions.push({\r\n        OR: [\r\n          { number: { contains: searchTerm, mode: 'insensitive' } },\r\n          { customerEmail: { contains: searchTerm, mode: 'insensitive' } },\r\n          { customerPhone: { contains: searchTerm, mode: 'insensitive' } },\r\n          {\r\n            user: {\r\n              OR: [\r\n                { firstName: { contains: searchTerm, mode: 'insensitive' } },\r\n                { lastName: { contains: searchTerm, mode: 'insensitive' } },\r\n                { email: { contains: searchTerm, mode: 'insensitive' } },\r\n                { phone: { contains: searchTerm, mode: 'insensitive' } },\r\n              ],\r\n            },\r\n          },\r\n        ],\r\n      });\r\n    }\r\n\r\n    // Apply AND conditions if any exist\r\n    if (andConditions.length > 0) {\r\n      where.AND = andConditions;\r\n    }\r\n\r\n    // Determine sort field and order\r\n    const sortBy = filters.sortBy || 'createdAt';\r\n    const sortOrder = filters.sortOrder || 'desc';\r\n    \r\n    // Map frontend sort fields to database fields\r\n    const sortFieldMap: Record<string, string> = {\r\n      'total': 'total',\r\n      'createdAt': 'createdAt',\r\n    };\r\n    \r\n    const dbSortField = sortFieldMap[sortBy] || 'createdAt';\r\n    const orderBy: any = { [dbSortField]: sortOrder };\r\n\r\n    console.log('üì¶ [ADMIN SERVICE] getOrders with filters:', { where, page, limit, skip, orderBy });\r\n\r\n    // Get orders with pagination, including related user for basic customer info\r\n    const [orders, total] = await Promise.all([\r\n      db.order.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        orderBy,\r\n        include: {\r\n          items: true,\r\n          user: {\r\n            select: {\r\n              id: true,\r\n              firstName: true,\r\n              lastName: true,\r\n              email: true,\r\n              phone: true,\r\n            },\r\n          },\r\n        },\r\n      }),\r\n      db.order.count({ where }),\r\n    ]);\r\n\r\n    // Format orders for response\r\n    const formattedOrders = orders.map((order: { \r\n      id: string; \r\n      number: string; \r\n      status: string; \r\n      paymentStatus: string; \r\n      fulfillmentStatus: string; \r\n      total: number; \r\n      subtotal: number;\r\n      discountAmount: number;\r\n      shippingAmount: number;\r\n      taxAmount: number;\r\n      currency: string | null; \r\n      customerEmail: string | null; \r\n      customerPhone: string | null; \r\n      createdAt: Date;\r\n      items: Array<unknown>;\r\n      user?: {\r\n        id: string;\r\n        firstName: string | null;\r\n        lastName: string | null;\r\n        email: string | null;\r\n        phone: string | null;\r\n      } | null;\r\n    }) => {\r\n      const customer = order.user || null;\r\n      const firstName = customer?.firstName || '';\r\n      const lastName = customer?.lastName || '';\r\n\r\n      return {\r\n        id: order.id,\r\n        number: order.number,\r\n        status: order.status,\r\n        paymentStatus: order.paymentStatus,\r\n        fulfillmentStatus: order.fulfillmentStatus,\r\n        total: order.total,\r\n        subtotal: order.subtotal,\r\n        discountAmount: order.discountAmount,\r\n        shippingAmount: order.shippingAmount,\r\n        taxAmount: order.taxAmount,\r\n        currency: order.currency || 'AMD',\r\n        customerEmail: customer?.email || order.customerEmail || '',\r\n        customerPhone: customer?.phone || order.customerPhone || '',\r\n        customerFirstName: firstName,\r\n        customerLastName: lastName,\r\n        customerId: customer?.id || null,\r\n        itemsCount: order.items.length,\r\n        createdAt: order.createdAt.toISOString(),\r\n      };\r\n    });\r\n\r\n    return {\r\n      data: formattedOrders,\r\n      meta: {\r\n        total,\r\n        page,\r\n        limit,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get single order by ID with full details for admin\r\n   */\r\n  async getOrderById(orderId: string) {\r\n    // Fetch order with related user and items/variants/products\r\n    const order = await db.order.findUnique({\r\n      where: { id: orderId },\r\n      include: {\r\n        user: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            phone: true,\r\n            firstName: true,\r\n            lastName: true,\r\n          },\r\n        },\r\n        items: {\r\n          include: {\r\n            variant: {\r\n              include: {\r\n                product: {\r\n                  include: {\r\n                    translations: {\r\n                      where: { locale: \"en\" },\r\n                      take: 1,\r\n                    },\r\n                  },\r\n                },\r\n                options: {\r\n                  include: {\r\n                    attributeValue: {\r\n                      include: {\r\n                        attribute: true,\r\n                        translations: true,\r\n                      },\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        payments: true,\r\n      },\r\n    });\r\n\r\n    if (!order) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Order not found\",\r\n        detail: `Order with id '${orderId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    const user = order.user as any;\r\n    const items = Array.isArray(order.items) ? order.items : [];\r\n\r\n    const formattedItems = items.map((item: any) => {\r\n      const variant = item.variant;\r\n      const product = variant?.product;\r\n      const translations = Array.isArray(product?.translations)\r\n        ? product.translations\r\n        : [];\r\n      const translation = translations[0] || null;\r\n\r\n      const quantity = item.quantity ?? 0;\r\n      const total = item.total ?? 0;\r\n      const unitPrice =\r\n        quantity > 0 ? Number((total / quantity).toFixed(2)) : total;\r\n\r\n      // Extract variant options (color, size, etc.)\r\n      // Support both new format (AttributeValue) and old format (attributeKey/value)\r\n      const variantOptions = variant?.options?.map((opt: {\r\n        attributeKey: string | null;\r\n        value: string | null;\r\n        valueId: string | null;\r\n        attributeValue: {\r\n          value: string;\r\n          imageUrl: string | null;\r\n          colors: any;\r\n          translations: Array<{\r\n            locale: string;\r\n            label: string;\r\n          }>;\r\n          attribute: {\r\n            key: string;\r\n          };\r\n        } | null;\r\n      }) => {\r\n        // Debug logging for each option\r\n        console.log(`üîç [ADMIN SERVICE] Processing option:`, {\r\n          attributeKey: opt.attributeKey,\r\n          value: opt.value,\r\n          valueId: opt.valueId,\r\n          hasAttributeValue: !!opt.attributeValue,\r\n          attributeValueData: opt.attributeValue ? {\r\n            value: opt.attributeValue.value,\r\n            attributeKey: opt.attributeValue.attribute.key,\r\n            imageUrl: opt.attributeValue.imageUrl,\r\n            hasTranslations: opt.attributeValue.translations?.length > 0,\r\n          } : null,\r\n        });\r\n\r\n        // New format: Use AttributeValue if available\r\n        if (opt.attributeValue) {\r\n          // Get label from translations (prefer current locale, fallback to first available)\r\n          const translations = opt.attributeValue.translations || [];\r\n          const label = translations.length > 0 ? translations[0].label : opt.attributeValue.value;\r\n          \r\n          return {\r\n            attributeKey: opt.attributeValue.attribute.key || undefined,\r\n            value: opt.attributeValue.value || undefined,\r\n            label: label || undefined,\r\n            imageUrl: opt.attributeValue.imageUrl || undefined,\r\n            colors: opt.attributeValue.colors || undefined,\r\n          };\r\n        }\r\n        // Old format: Use attributeKey and value directly\r\n        return {\r\n          attributeKey: opt.attributeKey || undefined,\r\n          value: opt.value || undefined,\r\n        };\r\n      }) || [];\r\n\r\n      console.log(`üîç [ADMIN SERVICE] Item mapping:`, {\r\n        productTitle: item.productTitle,\r\n        variantId: item.variantId,\r\n        hasVariant: !!variant,\r\n        optionsCount: variant?.options?.length || 0,\r\n        variantOptions,\r\n      });\r\n\r\n      return {\r\n        id: item.id,\r\n        variantId: item.variantId || variant?.id || null,\r\n        productId: product?.id || null,\r\n        productTitle: translation?.title || item.productTitle || \"Unknown Product\",\r\n        sku: variant?.sku || item.sku || \"N/A\",\r\n        quantity,\r\n        total,\r\n        unitPrice,\r\n        variantOptions,\r\n      };\r\n    });\r\n\r\n    const payments = Array.isArray(order.payments) ? order.payments : [];\r\n    const primaryPayment = payments[0] || null;\r\n\r\n    return {\r\n      id: order.id,\r\n      number: order.number,\r\n      status: order.status,\r\n      paymentStatus: order.paymentStatus,\r\n      fulfillmentStatus: order.fulfillmentStatus,\r\n      total: order.total,\r\n      currency: order.currency || \"AMD\",\r\n      totals: {\r\n        subtotal: Number(order.subtotal || 0),\r\n        discount: Number(order.discountAmount || 0),\r\n        shipping: Number(order.shippingAmount || 0),\r\n        tax: Number(order.taxAmount || 0),\r\n        total: Number(order.total || 0),\r\n        currency: order.currency || \"AMD\",\r\n      },\r\n      customerEmail: order.customerEmail || user?.email || undefined,\r\n      customerPhone: order.customerPhone || user?.phone || undefined,\r\n      billingAddress: order.billingAddress as any || null,\r\n      shippingAddress: order.shippingAddress as any || null,\r\n      shippingMethod: order.shippingMethod || null,\r\n      notes: order.notes || null,\r\n      adminNotes: order.adminNotes || null,\r\n      ipAddress: order.ipAddress || null,\r\n      userAgent: order.userAgent || null,\r\n      payment: primaryPayment\r\n        ? {\r\n            id: primaryPayment.id,\r\n            provider: primaryPayment.provider,\r\n            method: primaryPayment.method,\r\n            amount: primaryPayment.amount,\r\n            currency: primaryPayment.currency,\r\n            status: primaryPayment.status,\r\n            cardLast4: primaryPayment.cardLast4,\r\n            cardBrand: primaryPayment.cardBrand,\r\n          }\r\n        : null,\r\n      customer: user\r\n        ? {\r\n            id: user.id,\r\n            email: user.email,\r\n            phone: user.phone,\r\n            firstName: user.firstName,\r\n            lastName: user.lastName,\r\n          }\r\n        : null,\r\n      createdAt: order.createdAt.toISOString(),\r\n      updatedAt: order.updatedAt?.toISOString?.() ?? undefined,\r\n      items: formattedItems,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Delete order\r\n   * ’Ä’•’º’°÷Å’∂’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’® ÷á ’¢’∏’¨’∏÷Ä ’Ø’°’∫’æ’°’Æ ’£÷Ä’°’º’∏÷Ç’¥’∂’•÷Ä’® (cascade)\r\n   */\r\n  async deleteOrder(orderId: string) {\r\n    try {\r\n      console.log('üóëÔ∏è [ADMIN] ’ç’Ø’Ω’æ’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’´ ’∞’•’º’°÷Å’∏÷Ç’¥:', {\r\n        orderId,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n      \r\n      // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’°÷Ä’§’µ’∏÷Ñ ’∫’°’ø’æ’•÷Ä’® ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´\r\n      console.log('üîç [ADMIN] ’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’´ ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂’®...');\r\n      const existing = await db.order.findUnique({\r\n        where: { id: orderId },\r\n        select: {\r\n          id: true,\r\n          number: true,\r\n          status: true,\r\n          total: true,\r\n          _count: {\r\n            select: {\r\n              items: true,\r\n              payments: true,\r\n              events: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!existing) {\r\n        console.log('‚ùå [ADMIN] ’ä’°’ø’æ’•÷Ä’® ’π’´ ’£’ø’∂’æ’•’¨:', orderId);\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Order not found\",\r\n          detail: `Order with id '${orderId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      console.log('‚úÖ [ADMIN] ’ä’°’ø’æ’•÷Ä’® ’£’ø’∂’æ’•’¨ ’ß:', {\r\n        id: existing.id,\r\n        number: existing.number,\r\n        status: existing.status,\r\n        total: existing.total,\r\n        itemsCount: existing._count.items,\r\n        paymentsCount: existing._count.payments,\r\n        eventsCount: existing._count.events,\r\n      });\r\n\r\n      // ’Ä’•’º’°÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ ’∫’°’ø’æ’•÷Ä’® (cascade-’® ’°’æ’ø’∏’¥’°’ø ’Ø’∞’•’º’°÷Å’∂’´ ’Ø’°’∫’æ’°’Æ items, payments, events)\r\n      console.log('üóëÔ∏è [ADMIN] ’Ä’•’º’°÷Å’æ’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’® ÷á ’Ø’°’∫’æ’°’Æ ’£÷Ä’°’º’∏÷Ç’¥’∂’•÷Ä’®...');\r\n      \r\n      try {\r\n        await db.order.delete({\r\n          where: { id: orderId },\r\n        });\r\n        console.log('‚úÖ [ADMIN] Prisma delete ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’°’æ’°÷Ä’ø’æ’°’Æ');\r\n      } catch (deleteError: any) {\r\n        console.error('‚ùå [ADMIN] Prisma delete ’Ω’≠’°’¨:', {\r\n          code: deleteError?.code,\r\n          meta: deleteError?.meta,\r\n          message: deleteError?.message,\r\n          name: deleteError?.name,\r\n        });\r\n        throw deleteError;\r\n      }\r\n\r\n      console.log('‚úÖ [ADMIN] ’ä’°’ø’æ’•÷Ä’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’∞’•’º’°÷Å’æ’•’¨ ’ß:', {\r\n        orderId,\r\n        orderNumber: existing.number,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n      \r\n      return { success: true };\r\n    } catch (error: any) {\r\n      // ‘µ’©’• ’Ω’° ’¥’•÷Ä ’Ω’ø’•’≤’Æ’°’Æ ’Ω’≠’°’¨ ’ß, ’°’∫’° ’æ’•÷Ä’°’§’°÷Ä’±’∂’∏÷Ç’¥ ’•’∂÷Ñ ’°’µ’∂\r\n      if (error.status && error.type) {\r\n        console.error('‚ùå [ADMIN] ’ç’ø’°’∂’§’°÷Ä’ø ’Ω’≠’°’¨:', {\r\n          status: error.status,\r\n          type: error.type,\r\n          title: error.title,\r\n          detail: error.detail,\r\n        });\r\n        throw error;\r\n      }\r\n\r\n      // ’Ñ’°’∂÷Ä’°’¥’°’Ω’∂ ’¨’∏’£’°’æ’∏÷Ä’∏÷Ç’¥ Prisma ’Ω’≠’°’¨’∂’•÷Ä’´ ’∞’°’¥’°÷Ä\r\n      console.error('‚ùå [ADMIN] ’ä’°’ø’æ’•÷Ä’´ ’∞’•’º’°÷Å’¥’°’∂ ’Ω’≠’°’¨:', {\r\n        orderId,\r\n        error: {\r\n          name: error?.name,\r\n          message: error?.message,\r\n          code: error?.code,\r\n          meta: error?.meta,\r\n          stack: error?.stack?.substring(0, 500),\r\n        },\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      // Prisma ’Ω’≠’°’¨’∂’•÷Ä’´ ’¥’∑’°’Ø’∏÷Ç’¥\r\n      if (error?.code === 'P2025') {\r\n        // Record not found\r\n        console.log('‚ö†Ô∏è [ADMIN] Prisma P2025: ‘≥÷Ä’°’º’∏÷Ç’¥’® ’π’´ ’£’ø’∂’æ’•’¨');\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Order not found\",\r\n          detail: `Order with id '${orderId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      if (error?.code === 'P2003') {\r\n        // Foreign key constraint failed\r\n        console.log('‚ö†Ô∏è [ADMIN] Prisma P2003: Foreign key ’Ω’°’∞’¥’°’∂’°÷É’°’Ø’∏÷Ç’¥');\r\n        throw {\r\n          status: 409,\r\n          type: \"https://api.shop.am/problems/conflict\",\r\n          title: \"Cannot delete order\",\r\n          detail: \"Order has related records that cannot be deleted\",\r\n        };\r\n      }\r\n\r\n      // ‘≥’•’∂’•÷Ä’´’Ø ’Ω’≠’°’¨\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: error?.message || \"Failed to delete order\",\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update order\r\n   */\r\n  async updateOrder(orderId: string, data: any) {\r\n    try {\r\n      // Check if order exists\r\n      const existing = await db.order.findUnique({\r\n        where: { id: orderId },\r\n      });\r\n\r\n      if (!existing) {\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Order not found\",\r\n          detail: `Order with id '${orderId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      // Validate status values\r\n      const validStatuses = ['pending', 'processing', 'completed', 'cancelled'];\r\n      const validPaymentStatuses = ['pending', 'paid', 'failed', 'refunded'];\r\n      const validFulfillmentStatuses = ['unfulfilled', 'fulfilled', 'shipped', 'delivered'];\r\n\r\n      if (data.status !== undefined && !validStatuses.includes(data.status)) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: `Invalid status. Must be one of: ${validStatuses.join(', ')}`,\r\n        };\r\n      }\r\n\r\n      if (data.paymentStatus !== undefined && !validPaymentStatuses.includes(data.paymentStatus)) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: `Invalid paymentStatus. Must be one of: ${validPaymentStatuses.join(', ')}`,\r\n        };\r\n      }\r\n\r\n      if (data.fulfillmentStatus !== undefined && !validFulfillmentStatuses.includes(data.fulfillmentStatus)) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: `Invalid fulfillmentStatus. Must be one of: ${validFulfillmentStatuses.join(', ')}`,\r\n        };\r\n      }\r\n\r\n      // Prepare update data\r\n      const updateData: any = {};\r\n      if (data.status !== undefined) updateData.status = data.status;\r\n      if (data.paymentStatus !== undefined) updateData.paymentStatus = data.paymentStatus;\r\n      if (data.fulfillmentStatus !== undefined) updateData.fulfillmentStatus = data.fulfillmentStatus;\r\n\r\n      // Update timestamps based on status changes\r\n      if (data.status === 'completed' && existing.status !== 'completed') {\r\n        updateData.fulfilledAt = new Date();\r\n      }\r\n      if (data.status === 'cancelled' && existing.status !== 'cancelled') {\r\n        updateData.cancelledAt = new Date();\r\n      }\r\n      if (data.paymentStatus === 'paid' && existing.paymentStatus !== 'paid') {\r\n        updateData.paidAt = new Date();\r\n      }\r\n\r\n      const order = await db.order.update({\r\n        where: { id: orderId },\r\n        data: updateData,\r\n        include: {\r\n          items: true,\r\n          payments: true,\r\n        },\r\n      });\r\n\r\n      // Create order event\r\n      await db.orderEvent.create({\r\n        data: {\r\n          orderId: order.id,\r\n          type: 'order_updated',\r\n          data: {\r\n            updatedFields: Object.keys(updateData),\r\n            previousStatus: existing.status,\r\n            newStatus: data.status || existing.status,\r\n          },\r\n        },\r\n      });\r\n\r\n      return order;\r\n    } catch (error: any) {\r\n      // If it's already our custom error, re-throw it\r\n      if (error.status && error.type) {\r\n        throw error;\r\n      }\r\n\r\n      // Log Prisma/database errors\r\n      console.error(\"‚ùå [ADMIN SERVICE] updateOrder error:\", {\r\n        orderId,\r\n        error: {\r\n          name: error?.name,\r\n          message: error?.message,\r\n          code: error?.code,\r\n          meta: error?.meta,\r\n          stack: error?.stack?.substring(0, 500),\r\n        },\r\n      });\r\n\r\n      // Handle specific Prisma errors\r\n      if (error?.code === 'P2025') {\r\n        // Record not found\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Not Found\",\r\n          detail: error?.meta?.cause || \"The requested order was not found\",\r\n        };\r\n      }\r\n\r\n      // Generic database error\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Database Error\",\r\n        detail: error?.message || \"An error occurred while updating the order\",\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get products with filters and pagination\r\n   */\r\n  async getProducts(filters: {\r\n    page?: number;\r\n    limit?: number;\r\n    search?: string;\r\n    category?: string;\r\n    categories?: string[];\r\n    sku?: string;\r\n    minPrice?: number;\r\n    maxPrice?: number;\r\n    sort?: string;\r\n  }) {\r\n    console.log(\"üì¶ [ADMIN SERVICE] getProducts called with filters:\", filters);\r\n    const startTime = Date.now();\r\n    \r\n    const page = filters.page || 1;\r\n    const limit = filters.limit || 20;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where: any = {\r\n      deletedAt: null,\r\n    };\r\n\r\n    const orConditions: any[] = [];\r\n\r\n    // Search filter\r\n    if (filters.search) {\r\n      orConditions.push(\r\n        {\r\n          translations: {\r\n            some: {\r\n              title: {\r\n                contains: filters.search,\r\n                mode: \"insensitive\",\r\n              },\r\n            },\r\n          },\r\n        },\r\n        {\r\n          variants: {\r\n            some: {\r\n              sku: {\r\n                contains: filters.search,\r\n                mode: \"insensitive\",\r\n              },\r\n            },\r\n          },\r\n        }\r\n      );\r\n    }\r\n\r\n    // Category filter - support both single category and multiple categories\r\n    const categoryIds = filters.categories && filters.categories.length > 0 \r\n      ? filters.categories \r\n      : filters.category \r\n        ? [filters.category] \r\n        : [];\r\n    \r\n    if (categoryIds.length > 0) {\r\n      const categoryConditions: any[] = [];\r\n      categoryIds.forEach((categoryId) => {\r\n        categoryConditions.push(\r\n          {\r\n            primaryCategoryId: categoryId,\r\n          },\r\n          {\r\n            categoryIds: {\r\n              has: categoryId,\r\n            },\r\n          }\r\n        );\r\n      });\r\n      orConditions.push(...categoryConditions);\r\n    }\r\n\r\n    if (orConditions.length > 0) {\r\n      where.OR = orConditions;\r\n    }\r\n\r\n    // SKU filter\r\n    if (filters.sku) {\r\n      where.variants = {\r\n        some: {\r\n          sku: {\r\n            contains: filters.sku,\r\n            mode: \"insensitive\",\r\n          },\r\n        },\r\n      };\r\n    }\r\n\r\n    // Sort\r\n    let orderBy: any = { createdAt: \"desc\" };\r\n    if (filters.sort) {\r\n      const [field, direction] = filters.sort.split(\"-\");\r\n      orderBy = { [field]: direction || \"desc\" };\r\n    }\r\n\r\n    console.log(\"üì¶ [ADMIN SERVICE] Executing database queries...\");\r\n    console.log(\"üì¶ [ADMIN SERVICE] Where clause:\", JSON.stringify(where, null, 2));\r\n    const queryStartTime = Date.now();\r\n\r\n    let products: any[] = [];\r\n    let total: number = 0;\r\n\r\n    try {\r\n      // Test database connection first\r\n      console.log(\"üì¶ [ADMIN SERVICE] Testing database connection...\");\r\n      await db.$queryRaw`SELECT 1`;\r\n      console.log(\"‚úÖ [ADMIN SERVICE] Database connection OK\");\r\n\r\n      // First, try to get products with a simpler query\r\n      console.log(\"üì¶ [ADMIN SERVICE] Fetching products...\");\r\n      products = await db.product.findMany({\r\n        where,\r\n        skip,\r\n        take: limit,\r\n        orderBy,\r\n        include: {\r\n          translations: {\r\n            where: { locale: \"en\" },\r\n            take: 1,\r\n          },\r\n          variants: {\r\n            where: { published: true },\r\n            take: 1,\r\n            orderBy: { price: \"asc\" },\r\n          },\r\n          labels: true,\r\n        },\r\n      });\r\n      \r\n      const productsTime = Date.now() - queryStartTime;\r\n      console.log(`‚úÖ [ADMIN SERVICE] Products fetched in ${productsTime}ms. Found ${products.length} products`);\r\n\r\n      // Then get count - use a simpler approach if count is slow\r\n      console.log(\"üì¶ [ADMIN SERVICE] Counting total products...\");\r\n      const countStartTime = Date.now();\r\n      \r\n      // Use a timeout for count query\r\n      const countPromise = db.product.count({ where });\r\n      const timeoutPromise = new Promise<number>((_, reject) => \r\n        setTimeout(() => reject(new Error(\"Count query timeout\")), 10000)\r\n      );\r\n      \r\n      total = await Promise.race([countPromise, timeoutPromise]) as number;\r\n      const countTime = Date.now() - countStartTime;\r\n      console.log(`‚úÖ [ADMIN SERVICE] Count completed in ${countTime}ms. Total: ${total}`);\r\n      \r\n      const queryTime = Date.now() - queryStartTime;\r\n      console.log(`‚úÖ [ADMIN SERVICE] All database queries completed in ${queryTime}ms`);\r\n    } catch (error: any) {\r\n      // If product_variants.attributes column doesn't exist, try to create it and retry\r\n      if (error?.message?.includes('product_variants.attributes') || \r\n          (error?.message?.includes('attributes') && error?.message?.includes('does not exist'))) {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] product_variants.attributes column not found, attempting to create it...');\r\n        try {\r\n          await ensureProductVariantAttributesColumn();\r\n          // Retry the query after creating the column\r\n          products = await db.product.findMany({\r\n            where,\r\n            skip,\r\n            take: limit,\r\n            orderBy,\r\n            include: {\r\n              translations: {\r\n                where: { locale: \"en\" },\r\n                take: 1,\r\n              },\r\n              variants: {\r\n                where: { published: true },\r\n                take: 1,\r\n                orderBy: { price: \"asc\" },\r\n              },\r\n              labels: true,\r\n            },\r\n          });\r\n          \r\n          const productsTime = Date.now() - queryStartTime;\r\n          console.log(`‚úÖ [ADMIN SERVICE] Products fetched in ${productsTime}ms. Found ${products.length} products (after creating attributes column)`);\r\n          \r\n          // Get count\r\n          const countStartTime = Date.now();\r\n          const countPromise = db.product.count({ where });\r\n          const timeoutPromise = new Promise<number>((_, reject) => \r\n            setTimeout(() => reject(new Error(\"Count query timeout\")), 10000)\r\n          );\r\n          \r\n          total = await Promise.race([countPromise, timeoutPromise]) as number;\r\n          const countTime = Date.now() - countStartTime;\r\n          console.log(`‚úÖ [ADMIN SERVICE] Count completed in ${countTime}ms. Total: ${total}`);\r\n          \r\n          const queryTime = Date.now() - queryStartTime;\r\n          console.log(`‚úÖ [ADMIN SERVICE] All database queries completed in ${queryTime}ms`);\r\n        } catch (retryError: any) {\r\n          const queryTime = Date.now() - queryStartTime;\r\n          console.error(`‚ùå [ADMIN SERVICE] Database query error after ${queryTime}ms (after retry):`, retryError);\r\n          throw retryError;\r\n        }\r\n      } else {\r\n        const queryTime = Date.now() - queryStartTime;\r\n        console.error(`‚ùå [ADMIN SERVICE] Database query error after ${queryTime}ms:`, error);\r\n        console.error(`‚ùå [ADMIN SERVICE] Error details:`, {\r\n          message: error.message,\r\n          code: error.code,\r\n          meta: error.meta,\r\n          stack: error.stack?.substring(0, 500),\r\n        });\r\n        \r\n        // If count fails, try to get products without count\r\n        if (error.message === \"Count query timeout\" || error.message?.includes(\"count\")) {\r\n          console.warn(\"‚ö†Ô∏è [ADMIN SERVICE] Count query failed, using estimated total\");\r\n          total = products?.length || limit; // Use current page size as fallback\r\n        } else {\r\n          // If products query also failed, rethrow\r\n          if (!products) {\r\n            throw error;\r\n          }\r\n          // If only count failed, use estimated total\r\n          console.warn(\"‚ö†Ô∏è [ADMIN SERVICE] Count query failed, using estimated total\");\r\n          total = products.length || limit;\r\n        }\r\n      }\r\n    }\r\n\r\n    const data = products.map((product) => {\r\n      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ translation —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n      const translation = Array.isArray(product.translations) && product.translations.length > 0\r\n        ? product.translations[0]\r\n        : null;\r\n      \r\n      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ variant —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n      const variant = Array.isArray(product.variants) && product.variants.length > 0\r\n        ? product.variants[0]\r\n        : null;\r\n      \r\n      const image =\r\n        Array.isArray(product.media) && product.media.length > 0\r\n          ? typeof product.media[0] === \"string\"\r\n            ? product.media[0]\r\n            : (product.media[0] as any)?.url\r\n          : null;\r\n\r\n      return {\r\n        id: product.id,\r\n        slug: translation?.slug || \"\",\r\n        title: translation?.title || \"\",\r\n        published: product.published,\r\n        featured: product.featured || false,\r\n        price: variant?.price || 0,\r\n        stock: variant?.stock || 0,\r\n        discountPercent: product.discountPercent || 0, // Include discountPercent\r\n        compareAtPrice: variant?.compareAtPrice || null, // Include compareAtPrice for showing original price\r\n        colorStocks: [], // Can be enhanced later\r\n        image,\r\n        createdAt: product.createdAt.toISOString(),\r\n      };\r\n    });\r\n\r\n    const totalTime = Date.now() - startTime;\r\n    console.log(`‚úÖ [ADMIN SERVICE] getProducts completed in ${totalTime}ms. Returning ${data.length} products`);\r\n\r\n    return {\r\n      data,\r\n      meta: {\r\n        total,\r\n        page,\r\n        limit,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get product by ID\r\n   */\r\n  async getProductById(productId: string) {\r\n    // Try to include productAttributes, but handle case where table might not exist\r\n    let product;\r\n    try {\r\n      product = await db.product.findUnique({\r\n        where: { id: productId },\r\n        include: {\r\n          translations: true,\r\n          brand: {\r\n            include: {\r\n              translations: true,\r\n            },\r\n          },\r\n          categories: {\r\n            include: {\r\n              translations: true,\r\n            },\r\n          },\r\n          variants: {\r\n            include: {\r\n              options: {\r\n                include: {\r\n                  attributeValue: {\r\n                    include: {\r\n                      attribute: true,\r\n                      translations: true,\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n            orderBy: {\r\n              position: 'asc',\r\n            },\r\n          },\r\n          labels: true,\r\n          productAttributes: {\r\n            include: {\r\n              attribute: true,\r\n            },\r\n          },\r\n        },\r\n      });\r\n    } catch (error: any) {\r\n      // If productAttributes table doesn't exist, retry without it\r\n      if (error?.code === 'P2021' || error?.message?.includes('productAttributes') || error?.message?.includes('does not exist')) {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] productAttributes table not found, fetching without it:', error.message);\r\n        product = await db.product.findUnique({\r\n          where: { id: productId },\r\n          include: {\r\n            translations: true,\r\n            brand: {\r\n              include: {\r\n                translations: true,\r\n              },\r\n            },\r\n            categories: {\r\n              include: {\r\n                translations: true,\r\n              },\r\n            },\r\n            variants: {\r\n              include: {\r\n                options: {\r\n                  include: {\r\n                    attributeValue: {\r\n                      include: {\r\n                        attribute: true,\r\n                        translations: true,\r\n                      },\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n              orderBy: {\r\n                position: 'asc',\r\n              },\r\n            },\r\n            labels: true,\r\n          },\r\n        });\r\n      } else {\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    if (!product) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Product not found\",\r\n        detail: `Product with id '${productId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ translation —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n    const translations = Array.isArray(product.translations) ? product.translations : [];\r\n    const translation = translations.find((t: { locale: string }) => t.locale === \"en\") || translations[0] || null;\r\n\r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ labels —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n    const labels = Array.isArray(product.labels) ? product.labels : [];\r\n    \r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ variants —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n    const variants = Array.isArray(product.variants) ? product.variants : [];\r\n    \r\n    // Get all attribute IDs from productAttributes relation\r\n    const productAttributes = Array.isArray((product as any).productAttributes) \r\n      ? (product as any).productAttributes \r\n      : [];\r\n    const attributeIds = productAttributes\r\n      .map((pa: any) => pa.attributeId || pa.attribute?.id)\r\n      .filter((id: string | undefined): id is string => !!id);\r\n    \r\n    // Also include attributeIds from product.attributeIds if available (backward compatibility)\r\n    const legacyAttributeIds = Array.isArray((product as any).attributeIds) \r\n      ? (product as any).attributeIds \r\n      : [];\r\n    \r\n    // Merge both sources and remove duplicates\r\n    const allAttributeIds = Array.from(new Set([...attributeIds, ...legacyAttributeIds]));\r\n\r\n    return {\r\n      id: product.id,\r\n      title: translation?.title || \"\",\r\n      slug: translation?.slug || \"\",\r\n      subtitle: translation?.subtitle || null,\r\n      descriptionHtml: translation?.descriptionHtml || null,\r\n      brandId: product.brandId || null,\r\n      primaryCategoryId: product.primaryCategoryId || null,\r\n      categoryIds: product.categoryIds || [],\r\n      attributeIds: allAttributeIds, // All attribute IDs that this product has\r\n      published: product.published,\r\n      media: Array.isArray(product.media) ? product.media : [],\r\n      labels: labels.map((label: { id: string; type: string; value: string; position: string; color: string | null }) => ({\r\n        id: label.id,\r\n        type: label.type,\r\n        value: label.value,\r\n        position: label.position,\r\n        color: label.color,\r\n      })),\r\n      variants: variants.map((variant: any) => {\r\n        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ options —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n        const options = Array.isArray(variant.options) ? variant.options : [];\r\n        \r\n        // Get attributes from JSONB column if available\r\n        let attributes = null;\r\n        let colorValues: string[] = [];\r\n        let sizeValues: string[] = [];\r\n        \r\n        if (variant.attributes) {\r\n          // attributes is already in JSONB format: { \"color\": [...], \"size\": [...] }\r\n          attributes = variant.attributes;\r\n          \r\n          // Extract color and size values from JSONB attributes\r\n          if (attributes.color && Array.isArray(attributes.color)) {\r\n            colorValues = attributes.color.map((item: any) => item.value || item).filter(Boolean);\r\n          }\r\n          if (attributes.size && Array.isArray(attributes.size)) {\r\n            sizeValues = attributes.size.map((item: any) => item.value || item).filter(Boolean);\r\n          }\r\n        } else if (options.length > 0) {\r\n          // Fallback: build attributes from options if JSONB column is empty\r\n          const attributesMap: Record<string, Array<{ valueId: string; value: string; attributeKey: string }>> = {};\r\n          options.forEach((opt: any) => {\r\n            const attrKey = opt.attributeKey || opt.attributeValue?.attribute?.key;\r\n            const value = opt.value || opt.attributeValue?.value;\r\n            const valueId = opt.valueId || opt.attributeValue?.id;\r\n            \r\n            if (attrKey && value && valueId) {\r\n              if (!attributesMap[attrKey]) {\r\n                attributesMap[attrKey] = [];\r\n              }\r\n              if (!attributesMap[attrKey].some((item: any) => item.valueId === valueId)) {\r\n                attributesMap[attrKey].push({\r\n                  valueId,\r\n                  value,\r\n                  attributeKey: attrKey,\r\n                });\r\n              }\r\n              \r\n              // Extract color and size for backward compatibility\r\n              if (attrKey === \"color\") {\r\n                colorValues.push(value);\r\n              } else if (attrKey === \"size\") {\r\n                sizeValues.push(value);\r\n              }\r\n            }\r\n          });\r\n          attributes = Object.keys(attributesMap).length > 0 ? attributesMap : null;\r\n        }\r\n        \r\n        // For backward compatibility: use first color/size if multiple values exist\r\n        const colorOption = options.find((opt: { attributeKey: string }) => opt.attributeKey === \"color\");\r\n        const sizeOption = options.find((opt: { attributeKey: string }) => opt.attributeKey === \"size\");\r\n        \r\n        // Use first value from arrays or fallback to single option value\r\n        const color = colorValues.length > 0 ? colorValues[0] : (colorOption?.value || \"\");\r\n        const size = sizeValues.length > 0 ? sizeValues[0] : (sizeOption?.value || \"\");\r\n\r\n        return {\r\n          id: variant.id,\r\n          price: variant.price.toString(),\r\n          compareAtPrice: variant.compareAtPrice?.toString() || \"\",\r\n          stock: variant.stock.toString(),\r\n          sku: variant.sku || \"\",\r\n          color: color, // First color for backward compatibility\r\n          size: size, // First size for backward compatibility\r\n          imageUrl: variant.imageUrl || \"\",\r\n          published: variant.published || false,\r\n          attributes: attributes, // JSONB attributes with all values - IMPORTANT: This is the main field\r\n          options: options, // Keep options for backward compatibility\r\n          // Additional fields for new format support\r\n          colorValues: colorValues, // All color values\r\n          sizeValues: sizeValues, // All size values\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate unique SKU for product variant\r\n   * Checks database to ensure uniqueness\r\n   */\r\n  private async generateUniqueSku(\r\n    tx: any,\r\n    baseSku: string | undefined,\r\n    productSlug: string,\r\n    variantIndex: number,\r\n    usedSkus: Set<string>\r\n  ): Promise<string> {\r\n    // If base SKU is provided and unique, use it\r\n    if (baseSku && baseSku.trim() !== '') {\r\n      const trimmedSku = baseSku.trim();\r\n      \r\n      // Check if already used in this transaction\r\n      if (!usedSkus.has(trimmedSku)) {\r\n        // Check if exists in database\r\n        const existing = await tx.productVariant.findUnique({\r\n          where: { sku: trimmedSku },\r\n        });\r\n        \r\n        if (!existing) {\r\n          usedSkus.add(trimmedSku);\r\n          console.log(`‚úÖ [ADMIN SERVICE] Using provided SKU: ${trimmedSku}`);\r\n          return trimmedSku;\r\n        } else {\r\n          console.log(`‚ö†Ô∏è [ADMIN SERVICE] SKU already exists in DB: ${trimmedSku}, generating new one`);\r\n        }\r\n      } else {\r\n        console.log(`‚ö†Ô∏è [ADMIN SERVICE] SKU already used in transaction: ${trimmedSku}, generating new one`);\r\n      }\r\n    }\r\n\r\n    // Generate new unique SKU\r\n    const baseSlug = productSlug || 'PROD';\r\n    let attempt = 0;\r\n    let newSku: string;\r\n    \r\n    do {\r\n      const timestamp = Date.now();\r\n      const random = Math.random().toString(36).substring(2, 6).toUpperCase();\r\n      const suffix = attempt > 0 ? `-${attempt}` : '';\r\n      newSku = `${baseSlug.toUpperCase()}-${timestamp}-${variantIndex + 1}${suffix}-${random}`;\r\n      attempt++;\r\n      \r\n      // Check if already used in this transaction\r\n      if (usedSkus.has(newSku)) {\r\n        continue;\r\n      }\r\n      \r\n      // Check if exists in database\r\n      const existing = await tx.productVariant.findUnique({\r\n        where: { sku: newSku },\r\n      });\r\n      \r\n      if (!existing) {\r\n        usedSkus.add(newSku);\r\n        console.log(`‚úÖ [ADMIN SERVICE] Generated unique SKU: ${newSku}`);\r\n        return newSku;\r\n      }\r\n      \r\n      console.log(`‚ö†Ô∏è [ADMIN SERVICE] Generated SKU exists in DB: ${newSku}, trying again...`);\r\n    } while (attempt < 100); // Safety limit\r\n    \r\n    // Fallback: use timestamp + random if all attempts failed\r\n    const finalSku = `${baseSlug.toUpperCase()}-${Date.now()}-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;\r\n    usedSkus.add(finalSku);\r\n    console.log(`‚úÖ [ADMIN SERVICE] Using fallback SKU: ${finalSku}`);\r\n    return finalSku;\r\n  }\r\n\r\n  /**\r\n   * Create product\r\n   */\r\n  async createProduct(data: {\r\n    title: string;\r\n    slug: string;\r\n    subtitle?: string;\r\n    descriptionHtml?: string;\r\n    brandId?: string;\r\n    primaryCategoryId?: string;\r\n    categoryIds?: string[];\r\n    published: boolean;\r\n    featured?: boolean;\r\n    locale: string;\r\n    media?: any[];\r\n    mainProductImage?: string;\r\n    labels?: Array<{\r\n      type: string;\r\n      value: string;\r\n      position: string;\r\n      color?: string | null;\r\n    }>;\r\n    attributeIds?: string[];\r\n    variants: Array<{\r\n      price: string | number;\r\n      compareAtPrice?: string | number;\r\n      stock: string | number;\r\n      sku?: string;\r\n      color?: string;\r\n      size?: string;\r\n      imageUrl?: string;\r\n      published?: boolean;\r\n      options?: Array<{\r\n        attributeKey: string;\r\n        value: string;\r\n        valueId?: string;\r\n      }>;\r\n    }>;\r\n  }) {\r\n    try {\r\n      console.log('üÜï [ADMIN SERVICE] Creating product:', data.title);\r\n\r\n      const result = await db.$transaction(async (tx: any) => {\r\n        // Track used SKUs within this transaction to ensure uniqueness\r\n        const usedSkus = new Set<string>();\r\n        \r\n        // Generate variants with options\r\n        // Support both old format (color/size strings) and new format (AttributeValue IDs)\r\n        // Also support generic options array for any attribute type\r\n        const variantsData = await Promise.all(\r\n          data.variants.map(async (variant: any, variantIndex: number) => {\r\n            const options: any[] = [];\r\n            const attributesMap: Record<string, Array<{ valueId: string; value: string; attributeKey: string }>> = {};\r\n            \r\n            // If variant has explicit options array, use it (new format)\r\n            if (variant.options && Array.isArray(variant.options) && variant.options.length > 0) {\r\n              for (const opt of variant.options) {\r\n                let valueId: string | null = null;\r\n                let attributeKey: string | null = null;\r\n                let value: string | null = null;\r\n\r\n                if (opt.valueId) {\r\n                  // New format: use valueId\r\n                  valueId = opt.valueId;\r\n                  // Fetch AttributeValue to get value and attributeKey\r\n                  const attrValue = await tx.attributeValue.findUnique({\r\n                    where: { id: opt.valueId },\r\n                    include: { attribute: true },\r\n                  });\r\n                  if (attrValue) {\r\n                    attributeKey = attrValue.attribute.key;\r\n                    value = attrValue.value;\r\n                  }\r\n                  options.push({ valueId: opt.valueId });\r\n                } else if (opt.attributeKey && opt.value) {\r\n                  // Try to find or create AttributeValue\r\n                  const foundValueId = await findOrCreateAttributeValue(opt.attributeKey, opt.value, data.locale);\r\n                  if (foundValueId) {\r\n                    valueId = foundValueId;\r\n                    attributeKey = opt.attributeKey;\r\n                    value = opt.value;\r\n                    options.push({ valueId: foundValueId });\r\n                  } else {\r\n                    // Fallback to old format if AttributeValue not found\r\n                    attributeKey = opt.attributeKey;\r\n                    value = opt.value;\r\n                    options.push({ attributeKey: opt.attributeKey, value: opt.value });\r\n                  }\r\n                }\r\n\r\n                // Build attributes JSONB structure\r\n                if (attributeKey && valueId && value) {\r\n                  if (!attributesMap[attributeKey]) {\r\n                    attributesMap[attributeKey] = [];\r\n                  }\r\n                  // Check if this valueId is already added for this attribute\r\n                  if (!attributesMap[attributeKey].some(item => item.valueId === valueId)) {\r\n                    attributesMap[attributeKey].push({\r\n                      valueId,\r\n                      value,\r\n                      attributeKey,\r\n                    });\r\n                  }\r\n                }\r\n              }\r\n            } else {\r\n              // Old format: Try to find or create AttributeValues for color and size\r\n              if (variant.color) {\r\n                const colorValueId = await findOrCreateAttributeValue(\"color\", variant.color, data.locale);\r\n                if (colorValueId) {\r\n                  options.push({ valueId: colorValueId });\r\n                  if (!attributesMap[\"color\"]) {\r\n                    attributesMap[\"color\"] = [];\r\n                  }\r\n                  attributesMap[\"color\"].push({\r\n                    valueId: colorValueId,\r\n                    value: variant.color,\r\n                    attributeKey: \"color\",\r\n                  });\r\n                } else {\r\n                  // Fallback to old format if AttributeValue not found\r\n                  options.push({ attributeKey: \"color\", value: variant.color });\r\n                }\r\n              }\r\n              \r\n              if (variant.size) {\r\n                const sizeValueId = await findOrCreateAttributeValue(\"size\", variant.size, data.locale);\r\n                if (sizeValueId) {\r\n                  options.push({ valueId: sizeValueId });\r\n                  if (!attributesMap[\"size\"]) {\r\n                    attributesMap[\"size\"] = [];\r\n                  }\r\n                  attributesMap[\"size\"].push({\r\n                    valueId: sizeValueId,\r\n                    value: variant.size,\r\n                    attributeKey: \"size\",\r\n                  });\r\n                } else {\r\n                  // Fallback to old format if AttributeValue not found\r\n                  options.push({ attributeKey: \"size\", value: variant.size });\r\n                }\r\n              }\r\n            }\r\n\r\n            const price = typeof variant.price === 'number' ? variant.price : parseFloat(String(variant.price));\r\n            const stock = typeof variant.stock === 'number' ? variant.stock : parseInt(String(variant.stock), 10);\r\n            const compareAtPrice = variant.compareAtPrice !== undefined && variant.compareAtPrice !== null && variant.compareAtPrice !== ''\r\n              ? (typeof variant.compareAtPrice === 'number' ? variant.compareAtPrice : parseFloat(String(variant.compareAtPrice)))\r\n              : undefined;\r\n\r\n            // Generate unique SKU for this variant\r\n            const uniqueSku = await this.generateUniqueSku(\r\n              tx,\r\n              variant.sku,\r\n              data.slug,\r\n              variantIndex,\r\n              usedSkus\r\n            );\r\n\r\n            // Convert attributesMap to JSONB format\r\n            const attributesJson = Object.keys(attributesMap).length > 0 ? attributesMap : null;\r\n\r\n            console.log(`üì¶ [ADMIN SERVICE] Variant ${variantIndex + 1} attributes:`, JSON.stringify(attributesJson, null, 2));\r\n\r\n            // Process and validate variant imageUrl\r\n            let processedVariantImageUrl: string | undefined = undefined;\r\n            if (variant.imageUrl) {\r\n              const urls = smartSplitUrls(variant.imageUrl);\r\n              const processedUrls = urls.map(url => processImageUrl(url)).filter((url): url is string => url !== null);\r\n              if (processedUrls.length > 0) {\r\n                processedVariantImageUrl = processedUrls.join(',');\r\n              }\r\n            }\r\n\r\n            return {\r\n              sku: uniqueSku,\r\n              price,\r\n              compareAtPrice,\r\n              stock: isNaN(stock) ? 0 : stock,\r\n              imageUrl: processedVariantImageUrl,\r\n              published: variant.published !== false,\r\n              attributes: attributesJson, // JSONB column\r\n              options: {\r\n                create: options,\r\n              },\r\n            };\r\n          })\r\n        );\r\n\r\n        // Final validation: log all SKUs to ensure uniqueness\r\n        const allSkus = variantsData.map(v => v.sku).filter(Boolean);\r\n        const uniqueSkus = new Set(allSkus);\r\n        console.log(`üìã [ADMIN SERVICE] Generated ${variantsData.length} variants with SKUs:`, allSkus);\r\n        \r\n        if (allSkus.length !== uniqueSkus.size) {\r\n          console.error('‚ùå [ADMIN SERVICE] Duplicate SKUs detected!', {\r\n            total: allSkus.length,\r\n            unique: uniqueSkus.size,\r\n            duplicates: allSkus.filter((sku, index) => allSkus.indexOf(sku) !== index)\r\n          });\r\n          throw new Error('Duplicate SKUs detected in variants. This should not happen.');\r\n        }\r\n        \r\n        console.log('‚úÖ [ADMIN SERVICE] All variant SKUs are unique');\r\n\r\n        // Collect all variant images to exclude from main media\r\n        const allVariantImages: any[] = [];\r\n        variantsData.forEach((variant: any) => {\r\n          if (variant.imageUrl) {\r\n            const urls = smartSplitUrls(variant.imageUrl);\r\n            allVariantImages.push(...urls);\r\n          }\r\n        });\r\n\r\n        // Prepare media array - use mainProductImage if provided and media is empty\r\n        let rawMedia = data.media || [];\r\n        if (data.mainProductImage && rawMedia.length === 0) {\r\n          // If mainProductImage is provided but media is empty, use mainProductImage as first media item\r\n          rawMedia = [data.mainProductImage];\r\n          console.log('üì∏ [ADMIN SERVICE] Using mainProductImage as media:', data.mainProductImage.substring(0, 50) + '...');\r\n        } else if (data.mainProductImage && rawMedia.length > 0) {\r\n          // If both are provided, ensure mainProductImage is first in media array\r\n          const mainImageIndex = rawMedia.findIndex((m: any) => {\r\n            const url = typeof m === 'string' ? m : m.url;\r\n            return url === data.mainProductImage;\r\n          });\r\n          if (mainImageIndex === -1) {\r\n            // mainProductImage not in media array, add it as first\r\n            rawMedia = [data.mainProductImage, ...rawMedia];\r\n            console.log('üì∏ [ADMIN SERVICE] Added mainProductImage as first media item');\r\n          } else if (mainImageIndex > 0) {\r\n            // mainProductImage is in media but not first, move it to first\r\n            const mainImage = rawMedia[mainImageIndex];\r\n            rawMedia.splice(mainImageIndex, 1);\r\n            rawMedia.unshift(mainImage);\r\n            console.log('üì∏ [ADMIN SERVICE] Moved mainProductImage to first position in media');\r\n          }\r\n        }\r\n\r\n        // Separate main images from variant images and clean them\r\n        const { main } = separateMainAndVariantImages(rawMedia, allVariantImages);\r\n        const finalMedia = cleanImageUrls(main);\r\n        \r\n        console.log('üì∏ [ADMIN SERVICE] Final main media count:', finalMedia.length);\r\n        console.log('üì∏ [ADMIN SERVICE] Variant images excluded:', allVariantImages.length);\r\n\r\n        const product = await tx.product.create({\r\n          data: {\r\n            brandId: data.brandId || undefined,\r\n            primaryCategoryId: data.primaryCategoryId || undefined,\r\n            categoryIds: data.categoryIds || [],\r\n            media: finalMedia,\r\n            published: data.published,\r\n            featured: data.featured ?? false,\r\n            publishedAt: data.published ? new Date() : undefined,\r\n            translations: {\r\n              create: {\r\n                locale: data.locale || \"en\",\r\n                title: data.title,\r\n                slug: data.slug,\r\n                subtitle: data.subtitle || undefined,\r\n                descriptionHtml: data.descriptionHtml || undefined,\r\n              },\r\n            },\r\n            variants: {\r\n              create: variantsData,\r\n            },\r\n            labels: data.labels && data.labels.length > 0\r\n              ? {\r\n                  create: data.labels.map((label) => ({\r\n                    type: label.type,\r\n                    value: label.value,\r\n                    position: label.position,\r\n                    color: label.color || undefined,\r\n                  })),\r\n                }\r\n              : undefined,\r\n          },\r\n        });\r\n\r\n        // Create ProductAttribute relations if attributeIds provided\r\n        if (data.attributeIds && data.attributeIds.length > 0) {\r\n          try {\r\n            // Ensure table exists (for Vercel deployments where migrations might not run)\r\n            await ensureProductAttributesTable();\r\n            \r\n            console.log('üîó [ADMIN SERVICE] Creating ProductAttribute relations for product:', product.id, 'attributes:', data.attributeIds);\r\n            await tx.productAttribute.createMany({\r\n              data: data.attributeIds.map((attributeId) => ({\r\n                productId: product.id,\r\n                attributeId,\r\n              })),\r\n              skipDuplicates: true,\r\n            });\r\n            console.log('‚úÖ [ADMIN SERVICE] Created ProductAttribute relations:', data.attributeIds);\r\n          } catch (error: any) {\r\n            console.error('‚ùå [ADMIN SERVICE] Failed to create ProductAttribute relations:', error);\r\n            console.error('   Product ID:', product.id);\r\n            console.error('   Attribute IDs:', data.attributeIds);\r\n            console.error('   Error code:', error.code);\r\n            console.error('   Error message:', error.message);\r\n            // Re-throw to fail the transaction\r\n            throw error;\r\n          }\r\n        }\r\n\r\n        // DISABLED: Update attribute value imageUrls from variant images\r\n        // When creating a new product, attribute values should remain unchanged\r\n        // Attribute value images and colors should not be automatically updated from variant images\r\n        // This ensures that attribute values keep their original state when products are created\r\n        /*\r\n        try {\r\n          console.log('üñºÔ∏è [ADMIN SERVICE] Updating attribute value imageUrls from variant images...');\r\n          const createdVariants = await tx.productVariant.findMany({\r\n            where: { productId: product.id },\r\n            include: {\r\n              options: {\r\n                include: {\r\n                  attributeValue: true,\r\n                },\r\n              },\r\n            },\r\n          });\r\n\r\n          for (const variant of createdVariants) {\r\n            if (!variant.imageUrl) continue;\r\n\r\n            // Use smartSplitUrls to properly handle comma-separated URLs and base64 images\r\n            const variantImageUrls = smartSplitUrls(variant.imageUrl);\r\n            if (variantImageUrls.length === 0) continue;\r\n\r\n            // Process and validate first image URL\r\n            const firstVariantImageUrl = processImageUrl(variantImageUrls[0]);\r\n            if (!firstVariantImageUrl) {\r\n              console.log(`‚ö†Ô∏è [ADMIN SERVICE] Variant ${variant.id} has invalid imageUrl, skipping attribute value update`);\r\n              continue;\r\n            }\r\n\r\n            // Get all attribute value IDs from this variant's options\r\n            const attributeValueIds = new Set<string>();\r\n            variant.options.forEach((opt: any) => {\r\n              if (opt.valueId && opt.attributeValue) {\r\n                attributeValueIds.add(opt.valueId);\r\n              }\r\n            });\r\n\r\n            // Update each attribute value's imageUrl if it doesn't already have one\r\n            // or if the variant image is more specific (e.g., base64 or full URL)\r\n            // BUT skip updating if:\r\n            // - Attribute is \"color\" and attribute value doesn't have an imageUrl\r\n            // - Attribute value only has colors but no imageUrl\r\n            for (const valueId of attributeValueIds) {\r\n              const attrValue = await tx.attributeValue.findUnique({\r\n                where: { id: valueId },\r\n                include: {\r\n                  attribute: true,\r\n                },\r\n              });\r\n\r\n              if (attrValue) {\r\n                // Check if attribute is \"color\"\r\n                const isColorAttribute = attrValue.attribute?.key === \"color\";\r\n                \r\n                // Check if attribute value only has colors but no imageUrl\r\n                const hasColors = attrValue.colors && \r\n                  (Array.isArray(attrValue.colors) ? attrValue.colors.length > 0 : \r\n                   typeof attrValue.colors === 'string' ? attrValue.colors.trim() !== '' && attrValue.colors !== '[]' : \r\n                   Object.keys(attrValue.colors || {}).length > 0);\r\n                const hasNoImageUrl = !attrValue.imageUrl || attrValue.imageUrl.trim() === '';\r\n                const isColorOnly = hasColors && hasNoImageUrl;\r\n\r\n                // Skip updating if:\r\n                // 1. It's a color attribute AND doesn't have an imageUrl, OR\r\n                // 2. It only has colors but no imageUrl\r\n                if ((isColorAttribute && hasNoImageUrl) || isColorOnly) {\r\n                  console.log(`‚è≠Ô∏è [ADMIN SERVICE] Skipping attribute value ${valueId} - color attribute or color-only value without imageUrl`);\r\n                  continue;\r\n                }\r\n\r\n                // Only update if:\r\n                // 1. Attribute value doesn't have an imageUrl, OR\r\n                // 2. Variant image is a base64 (more specific) and attribute value has a URL\r\n                const shouldUpdate = !attrValue.imageUrl || \r\n                  (firstVariantImageUrl.startsWith('data:image/') && attrValue.imageUrl && !attrValue.imageUrl.startsWith('data:image/'));\r\n\r\n                if (shouldUpdate) {\r\n                  console.log(`üì∏ [ADMIN SERVICE] Updating attribute value ${valueId} imageUrl from variant ${variant.id}:`, firstVariantImageUrl.substring(0, 50) + '...');\r\n                  await tx.attributeValue.update({\r\n                    where: { id: valueId },\r\n                    data: { imageUrl: firstVariantImageUrl },\r\n                  });\r\n                } else {\r\n                  console.log(`‚è≠Ô∏è [ADMIN SERVICE] Skipping attribute value ${valueId} - already has imageUrl`);\r\n                }\r\n              }\r\n            }\r\n          }\r\n          console.log('‚úÖ [ADMIN SERVICE] Finished updating attribute value imageUrls from variant images');\r\n        } catch (error: any) {\r\n          // Don't fail the transaction if this fails - it's a nice-to-have feature\r\n          console.warn('‚ö†Ô∏è [ADMIN SERVICE] Failed to update attribute value imageUrls from variant images:', error);\r\n        }\r\n        */\r\n\r\n        return await tx.product.findUnique({\r\n          where: { id: product.id },\r\n          include: {\r\n            translations: true,\r\n            variants: {\r\n              include: {\r\n                options: true,\r\n              },\r\n            },\r\n            labels: true,\r\n          },\r\n        });\r\n      });\r\n\r\n      // Revalidate cache\r\n      try {\r\n        console.log('üßπ [ADMIN SERVICE] Revalidating paths for new product');\r\n        revalidatePath('/');\r\n        revalidatePath('/products');\r\n        // @ts-expect-error - revalidateTag type issue in Next.js\r\n        revalidateTag('products');\r\n      } catch (e) {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] Revalidation failed:', e);\r\n      }\r\n\r\n      return result;\r\n    } catch (error: any) {\r\n      console.error(\"‚ùå [ADMIN SERVICE] createProduct error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update product\r\n   */\r\n  async updateProduct(\r\n    productId: string,\r\n    data: {\r\n      title?: string;\r\n      slug?: string;\r\n      subtitle?: string;\r\n      descriptionHtml?: string;\r\n      brandId?: string;\r\n      primaryCategoryId?: string;\r\n      categoryIds?: string[];\r\n      published?: boolean;\r\n      featured?: boolean;\r\n      locale?: string;\r\n      media?: any[];\r\n      labels?: Array<{\r\n        id?: string;\r\n        type: string;\r\n        value: string;\r\n        position: string;\r\n        color?: string | null;\r\n      }>;\r\n      attributeIds?: string[];\r\n      variants?: Array<{\r\n        id?: string;\r\n        price: string | number;\r\n        compareAtPrice?: string | number;\r\n        stock: string | number;\r\n        sku?: string;\r\n        color?: string;\r\n        size?: string;\r\n        imageUrl?: string;\r\n        published?: boolean;\r\n        options?: Array<{\r\n          attributeKey: string;\r\n          value: string;\r\n          valueId?: string;\r\n        }>;\r\n      }>;\r\n    }\r\n  ) {\r\n    try {\r\n      console.log('üîÑ [ADMIN SERVICE] Updating product:', productId);\r\n      \r\n      // Check if product exists\r\n      const existing = await db.product.findUnique({\r\n        where: { id: productId },\r\n        include: {\r\n          translations: true,\r\n        }\r\n      });\r\n\r\n      if (!existing) {\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Product not found\",\r\n          detail: `Product with id '${productId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      // Execute everything in a transaction for atomicity and speed\r\n      const result = await db.$transaction(async (tx: any) => {\r\n        // Collect all variant images to exclude from main media (if media is being updated)\r\n        let allVariantImages: any[] = [];\r\n        if (data.variants !== undefined) {\r\n          data.variants.forEach((variant: any) => {\r\n            if (variant.imageUrl) {\r\n              const urls = smartSplitUrls(variant.imageUrl);\r\n              allVariantImages.push(...urls);\r\n            }\r\n          });\r\n        } else {\r\n          // If variants not being updated, get existing variant images\r\n          const existingVariants = await tx.productVariant.findMany({\r\n            where: { productId },\r\n            select: { imageUrl: true },\r\n          });\r\n          existingVariants.forEach((variant: any) => {\r\n            if (variant.imageUrl) {\r\n              const urls = smartSplitUrls(variant.imageUrl);\r\n              allVariantImages.push(...urls);\r\n            }\r\n          });\r\n        }\r\n\r\n        // 1. Update product base data\r\n        const updateData: any = {};\r\n        if (data.brandId !== undefined) updateData.brandId = data.brandId || null;\r\n        if (data.primaryCategoryId !== undefined) updateData.primaryCategoryId = data.primaryCategoryId || null;\r\n        if (data.categoryIds !== undefined) updateData.categoryIds = data.categoryIds || [];\r\n        if (data.media !== undefined) {\r\n          // Separate main images from variant images and clean them\r\n          const { main } = separateMainAndVariantImages(data.media, allVariantImages);\r\n          updateData.media = cleanImageUrls(main);\r\n          console.log('üì∏ [ADMIN SERVICE] Updated main media count:', updateData.media.length);\r\n          console.log('üì∏ [ADMIN SERVICE] Variant images excluded:', allVariantImages.length);\r\n        }\r\n        if (data.published !== undefined) {\r\n          updateData.published = data.published;\r\n          if (data.published && !existing.publishedAt) {\r\n            updateData.publishedAt = new Date();\r\n          }\r\n        }\r\n        if (data.featured !== undefined) updateData.featured = data.featured;\r\n\r\n        // 2. Update translation\r\n        if (data.title || data.slug || data.subtitle !== undefined || data.descriptionHtml !== undefined) {\r\n          const locale = data.locale || \"en\";\r\n          await tx.productTranslation.upsert({\r\n            where: {\r\n              productId_locale: {\r\n                productId,\r\n                locale,\r\n              },\r\n            },\r\n            update: {\r\n              ...(data.title && { title: data.title }),\r\n              ...(data.slug && { slug: data.slug }),\r\n              ...(data.subtitle !== undefined && { subtitle: data.subtitle || null }),\r\n              ...(data.descriptionHtml !== undefined && { descriptionHtml: data.descriptionHtml || null }),\r\n            },\r\n            create: {\r\n              productId,\r\n              locale,\r\n              title: data.title || \"\",\r\n              slug: data.slug || \"\",\r\n              subtitle: data.subtitle || null,\r\n              descriptionHtml: data.descriptionHtml || null,\r\n            },\r\n          });\r\n        }\r\n\r\n        // 3. Update labels\r\n        if (data.labels !== undefined) {\r\n          await tx.productLabel.deleteMany({ where: { productId } });\r\n          if (data.labels.length > 0) {\r\n            await tx.productLabel.createMany({\r\n              data: data.labels.map((label) => ({\r\n                productId,\r\n                type: label.type,\r\n                value: label.value,\r\n                position: label.position,\r\n                color: label.color || undefined,\r\n              })),\r\n            });\r\n          }\r\n        }\r\n\r\n        // 3.5. Update ProductAttribute relations\r\n        if (data.attributeIds !== undefined) {\r\n          // Ensure table exists (for Vercel deployments where migrations might not run)\r\n          await ensureProductAttributesTable();\r\n          \r\n          await tx.productAttribute.deleteMany({ where: { productId } });\r\n          if (data.attributeIds.length > 0) {\r\n            await tx.productAttribute.createMany({\r\n              data: data.attributeIds.map((attributeId) => ({\r\n                productId,\r\n                attributeId,\r\n              })),\r\n              skipDuplicates: true,\r\n            });\r\n            console.log('‚úÖ [ADMIN SERVICE] Updated ProductAttribute relations:', data.attributeIds);\r\n          }\r\n        }\r\n\r\n        // 4. Update variants\r\n        if (data.variants !== undefined) {\r\n          // Get existing variants with their IDs and SKUs for matching\r\n          const existingVariants = await tx.productVariant.findMany({\r\n            where: { productId },\r\n            select: { id: true, sku: true },\r\n          });\r\n          const existingVariantIds = new Set<string>(existingVariants.map((v: { id: string }) => v.id));\r\n          // Create a map of SKU -> variant ID for quick lookup\r\n          const existingSkuMap = new Map<string, string>();\r\n          existingVariants.forEach((v: { id: string; sku: string | null }) => {\r\n            if (v.sku) {\r\n              existingSkuMap.set(v.sku.trim().toLowerCase(), v.id);\r\n            }\r\n          });\r\n          const incomingVariantIds = new Set<string>();\r\n          \r\n          const locale = data.locale || \"en\";\r\n          \r\n          // Process each variant: update if exists, create if new\r\n          if (data.variants.length > 0) {\r\n            for (const variant of data.variants) {\r\n              const options: any[] = [];\r\n              const attributesMap: Record<string, Array<{ valueId: string; value: string; attributeKey: string }>> = {};\r\n              \r\n              // Support both old format (color/size) and new format (options array)\r\n              if (variant.options && Array.isArray(variant.options) && variant.options.length > 0) {\r\n                // New format: use options array\r\n                for (const opt of variant.options) {\r\n                  let valueId: string | null = null;\r\n                  let attributeKey: string | null = null;\r\n                  let value: string | null = null;\r\n\r\n                  if (opt.valueId) {\r\n                    valueId = opt.valueId;\r\n                    const attrValue = await tx.attributeValue.findUnique({\r\n                      where: { id: opt.valueId },\r\n                      include: { attribute: true },\r\n                    });\r\n                    if (attrValue) {\r\n                      attributeKey = attrValue.attribute.key;\r\n                      value = attrValue.value;\r\n                    }\r\n                    options.push({ valueId: opt.valueId });\r\n                  } else if (opt.attributeKey && opt.value) {\r\n                    const foundValueId = await findOrCreateAttributeValue(opt.attributeKey, opt.value, locale);\r\n                    if (foundValueId) {\r\n                      valueId = foundValueId;\r\n                      attributeKey = opt.attributeKey;\r\n                      value = opt.value;\r\n                      options.push({ valueId: foundValueId });\r\n                    } else {\r\n                      attributeKey = opt.attributeKey;\r\n                      value = opt.value;\r\n                      options.push({ attributeKey: opt.attributeKey, value: opt.value });\r\n                    }\r\n                  }\r\n\r\n                  // Build attributes JSONB structure\r\n                  if (attributeKey && valueId && value) {\r\n                    if (!attributesMap[attributeKey]) {\r\n                      attributesMap[attributeKey] = [];\r\n                    }\r\n                    if (!attributesMap[attributeKey].some(item => item.valueId === valueId)) {\r\n                      attributesMap[attributeKey].push({\r\n                        valueId,\r\n                        value,\r\n                        attributeKey,\r\n                      });\r\n                    }\r\n                  }\r\n                }\r\n              } else {\r\n                // Old format: Try to find or create AttributeValues for color and size\r\n                if (variant.color) {\r\n                  const colorValueId = await findOrCreateAttributeValue(\"color\", variant.color, locale);\r\n                  if (colorValueId) {\r\n                    options.push({ valueId: colorValueId });\r\n                    if (!attributesMap[\"color\"]) {\r\n                      attributesMap[\"color\"] = [];\r\n                    }\r\n                    attributesMap[\"color\"].push({\r\n                      valueId: colorValueId,\r\n                      value: variant.color,\r\n                      attributeKey: \"color\",\r\n                    });\r\n                  } else {\r\n                    // Fallback to old format if AttributeValue not found\r\n                    options.push({ attributeKey: \"color\", value: variant.color });\r\n                  }\r\n                }\r\n                \r\n                if (variant.size) {\r\n                  const sizeValueId = await findOrCreateAttributeValue(\"size\", variant.size, locale);\r\n                  if (sizeValueId) {\r\n                    options.push({ valueId: sizeValueId });\r\n                    if (!attributesMap[\"size\"]) {\r\n                      attributesMap[\"size\"] = [];\r\n                    }\r\n                    attributesMap[\"size\"].push({\r\n                      valueId: sizeValueId,\r\n                      value: variant.size,\r\n                      attributeKey: \"size\",\r\n                    });\r\n                  } else {\r\n                    // Fallback to old format if AttributeValue not found\r\n                    options.push({ attributeKey: \"size\", value: variant.size });\r\n                  }\r\n                }\r\n              }\r\n\r\n              const price = typeof variant.price === 'number' ? variant.price : parseFloat(String(variant.price));\r\n              const stock = typeof variant.stock === 'number' ? variant.stock : parseInt(String(variant.stock), 10);\r\n              const compareAtPrice = variant.compareAtPrice !== undefined && variant.compareAtPrice !== null && variant.compareAtPrice !== ''\r\n                ? (typeof variant.compareAtPrice === 'number' ? variant.compareAtPrice : parseFloat(String(variant.compareAtPrice)))\r\n                : undefined;\r\n\r\n              if (isNaN(price) || price < 0) {\r\n                throw new Error(`Invalid price value: ${variant.price}`);\r\n              }\r\n\r\n              // Convert attributesMap to JSONB format\r\n              const attributesJson = Object.keys(attributesMap).length > 0 ? attributesMap : null;\r\n\r\n              // Check if variant should be updated or created\r\n              // First check by ID if provided\r\n              let variantToUpdate = null;\r\n              let variantIdToUse: string | null = null;\r\n              \r\n              if (variant.id && existingVariantIds.has(variant.id)) {\r\n                variantToUpdate = await tx.productVariant.findUnique({\r\n                  where: { id: variant.id },\r\n                });\r\n                variantIdToUse = variant.id;\r\n                console.log(`üîç [ADMIN SERVICE] Variant lookup by ID ${variant.id}:`, variantToUpdate ? 'found' : 'not found');\r\n              }\r\n              \r\n              // If not found by ID, try to find by SKU using the SKU map (faster than DB query)\r\n              if (!variantToUpdate && variant.sku) {\r\n                const skuValue = variant.sku.trim();\r\n                const skuKey = skuValue.toLowerCase();\r\n                const matchedVariantId = existingSkuMap.get(skuKey);\r\n                \r\n                if (matchedVariantId) {\r\n                  variantToUpdate = await tx.productVariant.findUnique({\r\n                    where: { id: matchedVariantId },\r\n                  });\r\n                  variantIdToUse = matchedVariantId;\r\n                  console.log(`üîç [ADMIN SERVICE] Variant lookup by SKU \"${skuValue}\": found variant ID ${matchedVariantId}`);\r\n                } else {\r\n                  // Check if SKU exists globally (might be from another product)\r\n                  const existingSkuVariant = await tx.productVariant.findFirst({\r\n                    where: {\r\n                      sku: skuValue,\r\n                    },\r\n                  });\r\n                  \r\n                  if (existingSkuVariant) {\r\n                    console.warn(`‚ö†Ô∏è [ADMIN SERVICE] SKU \"${skuValue}\" already exists in product ${existingSkuVariant.productId}, but not in current product ${productId}`);\r\n                    // Don't use this variant, as it belongs to another product\r\n                    throw new Error(`SKU \"${skuValue}\" already exists in another product. Please use a unique SKU.`);\r\n                  }\r\n                  \r\n                  console.log(`üîç [ADMIN SERVICE] Variant lookup by SKU \"${skuValue}\": not found in current product`);\r\n                }\r\n              }\r\n              \r\n              if (variantToUpdate && variantIdToUse) {\r\n                // Update existing variant\r\n                incomingVariantIds.add(variantIdToUse);\r\n                \r\n                // Delete old options and create new ones\r\n                await tx.productVariantOption.deleteMany({\r\n                  where: { variantId: variantToUpdate.id },\r\n                });\r\n                \r\n                // Process and validate variant imageUrl\r\n                let processedVariantImageUrl: string | undefined = undefined;\r\n                if (variant.imageUrl) {\r\n                  const urls = smartSplitUrls(variant.imageUrl);\r\n                  const processedUrls = urls.map(url => processImageUrl(url)).filter((url): url is string => url !== null);\r\n                  if (processedUrls.length > 0) {\r\n                    processedVariantImageUrl = processedUrls.join(',');\r\n                  }\r\n                }\r\n\r\n                await tx.productVariant.update({\r\n                  where: { id: variantIdToUse },\r\n                  data: {\r\n                    sku: variant.sku ? variant.sku.trim() : undefined,\r\n                    price,\r\n                    compareAtPrice,\r\n                    stock: isNaN(stock) ? 0 : stock,\r\n                    imageUrl: processedVariantImageUrl,\r\n                    published: variant.published !== false,\r\n                    attributes: attributesJson,\r\n                    options: {\r\n                      create: options,\r\n                    },\r\n                  },\r\n                });\r\n                \r\n                console.log(`‚úÖ [ADMIN SERVICE] Updated variant: ${variantIdToUse} (found by ${variant.id ? 'ID' : 'SKU'})`);\r\n              } else {\r\n                // Create new variant\r\n                // Double-check that SKU doesn't already exist (safety check)\r\n                if (variant.sku) {\r\n                  const skuValue = variant.sku.trim();\r\n                  const existingSkuCheck = await tx.productVariant.findFirst({\r\n                    where: {\r\n                      sku: skuValue,\r\n                    },\r\n                  });\r\n                  \r\n                  if (existingSkuCheck) {\r\n                    console.error(`‚ùå [ADMIN SERVICE] SKU \"${skuValue}\" already exists! Variant ID: ${existingSkuCheck.id}, Product ID: ${existingSkuCheck.productId}`);\r\n                    throw new Error(`SKU \"${skuValue}\" already exists. Cannot create duplicate variant.`);\r\n                  }\r\n                }\r\n                \r\n                // Process and validate variant imageUrl\r\n                let processedVariantImageUrl: string | undefined = undefined;\r\n                if (variant.imageUrl) {\r\n                  const urls = smartSplitUrls(variant.imageUrl);\r\n                  const processedUrls = urls.map(url => processImageUrl(url)).filter((url): url is string => url !== null);\r\n                  if (processedUrls.length > 0) {\r\n                    processedVariantImageUrl = processedUrls.join(',');\r\n                  }\r\n                }\r\n\r\n                console.log(`üÜï [ADMIN SERVICE] Creating new variant with SKU: ${variant.sku || 'none'}`);\r\n                const newVariant = await tx.productVariant.create({\r\n                  data: {\r\n                    productId,\r\n                    sku: variant.sku ? variant.sku.trim() : undefined,\r\n                    price,\r\n                    compareAtPrice,\r\n                    stock: isNaN(stock) ? 0 : stock,\r\n                    imageUrl: processedVariantImageUrl,\r\n                    published: variant.published !== false,\r\n                    attributes: attributesJson,\r\n                    options: {\r\n                      create: options,\r\n                    },\r\n                  },\r\n                });\r\n                \r\n                if (newVariant.id) {\r\n                  incomingVariantIds.add(newVariant.id);\r\n                }\r\n                \r\n                console.log(`‚úÖ [ADMIN SERVICE] Created new variant: ${newVariant.id}`);\r\n              }\r\n            }\r\n          }\r\n          \r\n          // Delete variants that are no longer in the list\r\n          const variantsToDelete = Array.from(existingVariantIds).filter(id => !incomingVariantIds.has(id));\r\n          if (variantsToDelete.length > 0) {\r\n            await tx.productVariant.deleteMany({\r\n              where: {\r\n                id: { in: variantsToDelete },\r\n                productId,\r\n              },\r\n            });\r\n            console.log(`üóëÔ∏è [ADMIN SERVICE] Deleted ${variantsToDelete.length} variant(s):`, variantsToDelete);\r\n          }\r\n        }\r\n\r\n        // Update attribute value imageUrls from variant images\r\n        // If a variant has an imageUrl, update the corresponding attribute value's imageUrl\r\n        try {\r\n          console.log('üñºÔ∏è [ADMIN SERVICE] Updating attribute value imageUrls from variant images...');\r\n          const allVariants = await tx.productVariant.findMany({\r\n            where: { productId },\r\n            include: {\r\n              options: {\r\n                include: {\r\n                  attributeValue: true,\r\n                },\r\n              },\r\n            },\r\n          });\r\n\r\n          for (const variant of allVariants) {\r\n            if (!variant.imageUrl) continue;\r\n\r\n            // Use smartSplitUrls to properly handle comma-separated URLs and base64 images\r\n            const variantImageUrls = smartSplitUrls(variant.imageUrl);\r\n            if (variantImageUrls.length === 0) continue;\r\n\r\n            // Process and validate first image URL\r\n            const firstVariantImageUrl = processImageUrl(variantImageUrls[0]);\r\n            if (!firstVariantImageUrl) {\r\n              console.log(`‚ö†Ô∏è [ADMIN SERVICE] Variant ${variant.id} has invalid imageUrl, skipping attribute value update`);\r\n              continue;\r\n            }\r\n\r\n            // Get all attribute value IDs from this variant's options\r\n            const attributeValueIds = new Set<string>();\r\n            variant.options.forEach((opt: any) => {\r\n              if (opt.valueId && opt.attributeValue) {\r\n                attributeValueIds.add(opt.valueId);\r\n              }\r\n            });\r\n\r\n            // Update each attribute value's imageUrl if it doesn't already have one\r\n            // or if the variant image is more specific (e.g., base64 or full URL)\r\n            // BUT skip updating if:\r\n            // - Attribute is \"color\" and attribute value doesn't have an imageUrl\r\n            // - Attribute value only has colors but no imageUrl\r\n            for (const valueId of attributeValueIds) {\r\n              const attrValue = await tx.attributeValue.findUnique({\r\n                where: { id: valueId },\r\n                include: {\r\n                  attribute: true,\r\n                },\r\n              });\r\n\r\n              if (attrValue) {\r\n                // Check if attribute is \"color\"\r\n                const isColorAttribute = attrValue.attribute?.key === \"color\";\r\n                \r\n                // Check if attribute value only has colors but no imageUrl\r\n                const hasColors = attrValue.colors && \r\n                  (Array.isArray(attrValue.colors) ? attrValue.colors.length > 0 : \r\n                   typeof attrValue.colors === 'string' ? attrValue.colors.trim() !== '' && attrValue.colors !== '[]' : \r\n                   Object.keys(attrValue.colors || {}).length > 0);\r\n                const hasNoImageUrl = !attrValue.imageUrl || attrValue.imageUrl.trim() === '';\r\n                const isColorOnly = hasColors && hasNoImageUrl;\r\n\r\n                // Skip updating if:\r\n                // 1. It's a color attribute AND doesn't have an imageUrl, OR\r\n                // 2. It only has colors but no imageUrl\r\n                if ((isColorAttribute && hasNoImageUrl) || isColorOnly) {\r\n                  console.log(`‚è≠Ô∏è [ADMIN SERVICE] Skipping attribute value ${valueId} - color attribute or color-only value without imageUrl`);\r\n                  continue;\r\n                }\r\n\r\n                // Only update if:\r\n                // 1. Attribute value doesn't have an imageUrl, OR\r\n                // 2. Variant image is a base64 (more specific) and attribute value has a URL\r\n                const shouldUpdate = !attrValue.imageUrl || \r\n                  (firstVariantImageUrl.startsWith('data:image/') && attrValue.imageUrl && !attrValue.imageUrl.startsWith('data:image/'));\r\n\r\n                if (shouldUpdate) {\r\n                  console.log(`üì∏ [ADMIN SERVICE] Updating attribute value ${valueId} imageUrl from variant ${variant.id}:`, firstVariantImageUrl.substring(0, 50) + '...');\r\n                  await tx.attributeValue.update({\r\n                    where: { id: valueId },\r\n                    data: { imageUrl: firstVariantImageUrl },\r\n                  });\r\n                } else {\r\n                  console.log(`‚è≠Ô∏è [ADMIN SERVICE] Skipping attribute value ${valueId} - already has imageUrl`);\r\n                }\r\n              }\r\n            }\r\n          }\r\n          console.log('‚úÖ [ADMIN SERVICE] Finished updating attribute value imageUrls from variant images');\r\n        } catch (error: any) {\r\n          // Don't fail the transaction if this fails - it's a nice-to-have feature\r\n          console.warn('‚ö†Ô∏è [ADMIN SERVICE] Failed to update attribute value imageUrls from variant images:', error);\r\n        }\r\n\r\n        // 5. Finally update the product record itself\r\n        return await tx.product.update({\r\n          where: { id: productId },\r\n          data: updateData,\r\n          include: {\r\n            translations: true,\r\n            variants: {\r\n              include: {\r\n                options: true,\r\n              },\r\n            },\r\n            labels: true,\r\n          },\r\n        });\r\n      });\r\n\r\n      // 6. Revalidate cache for this product and related pages\r\n      try {\r\n        console.log('üßπ [ADMIN SERVICE] Revalidating paths for product:', productId);\r\n        revalidatePath(`/products/${result.translations[0]?.slug}`);\r\n        revalidatePath('/');\r\n        revalidatePath('/products');\r\n        // @ts-expect-error - revalidateTag type issue in Next.js\r\n        revalidateTag('products');\r\n        // @ts-expect-error - revalidateTag type issue in Next.js\r\n        revalidateTag(`product-${productId}`);\r\n      } catch (e) {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] Revalidation failed (expected in some environments):', e);\r\n      }\r\n\r\n      return result;\r\n    } catch (error: any) {\r\n      // ... (rest of error handling)\r\n      console.error(\"‚ùå [ADMIN SERVICE] updateProduct error:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete product (soft delete)\r\n   */\r\n  async deleteProduct(productId: string) {\r\n    const product = await db.product.findUnique({\r\n      where: { id: productId },\r\n    });\r\n\r\n    if (!product) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Product not found\",\r\n        detail: `Product with id '${productId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    await db.product.update({\r\n      where: { id: productId },\r\n      data: {\r\n        deletedAt: new Date(),\r\n        published: false,\r\n      },\r\n    });\r\n\r\n    return { success: true };\r\n  }\r\n\r\n  /**\r\n   * Update product discount\r\n   */\r\n  async updateProductDiscount(productId: string, discountPercent: number) {\r\n    console.log('üí∞ [ADMIN SERVICE] updateProductDiscount called:', { productId, discountPercent });\r\n    \r\n    const product = await db.product.findUnique({\r\n      where: { id: productId },\r\n    });\r\n\r\n    if (!product) {\r\n      console.error('‚ùå [ADMIN SERVICE] Product not found:', productId);\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Product not found\",\r\n        detail: `Product with id '${productId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    const clampedDiscount = Math.max(0, Math.min(100, discountPercent));\r\n    console.log('üí∞ [ADMIN SERVICE] Updating product discount:', {\r\n      productId,\r\n      oldDiscount: product.discountPercent,\r\n      newDiscount: clampedDiscount,\r\n    });\r\n\r\n    const updated = await db.product.update({\r\n      where: { id: productId },\r\n      data: {\r\n        discountPercent: clampedDiscount,\r\n      },\r\n    });\r\n\r\n    console.log('‚úÖ [ADMIN SERVICE] Product discount updated successfully:', {\r\n      productId,\r\n      discountPercent: updated.discountPercent,\r\n    });\r\n\r\n    return { success: true, discountPercent: updated.discountPercent };\r\n  }\r\n\r\n  /**\r\n   * Get settings\r\n   */\r\n  async getSettings() {\r\n    const settings = await db.settings.findMany({\r\n      where: {\r\n        key: {\r\n          in: ['globalDiscount', 'categoryDiscounts', 'brandDiscounts', 'defaultCurrency', 'currencyRates'],\r\n        },\r\n      },\r\n    });\r\n    \r\n    const globalDiscountSetting = settings.find((s: { key: string; value: string }) => s.key === 'globalDiscount');\r\n    const categoryDiscountsSetting = settings.find((s: { key: string; value: string }) => s.key === 'categoryDiscounts');\r\n    const brandDiscountsSetting = settings.find((s: { key: string; value: string }) => s.key === 'brandDiscounts');\r\n    const defaultCurrencySetting = settings.find((s: { key: string; value: string }) => s.key === 'defaultCurrency');\r\n    const currencyRatesSetting = settings.find((s: { key: string; value: string }) => s.key === 'currencyRates');\r\n    \r\n    // Default currency rates (fallback)\r\n    const defaultCurrencyRates = {\r\n      USD: 1,\r\n      AMD: 400,\r\n      EUR: 0.92,\r\n      RUB: 90,\r\n      GEL: 2.7,\r\n    };\r\n    \r\n    return {\r\n      globalDiscount: globalDiscountSetting ? Number(globalDiscountSetting.value) : 0,\r\n      categoryDiscounts: categoryDiscountsSetting ? (categoryDiscountsSetting.value as Record<string, number>) : {},\r\n      brandDiscounts: brandDiscountsSetting ? (brandDiscountsSetting.value as Record<string, number>) : {},\r\n      defaultCurrency: defaultCurrencySetting ? (defaultCurrencySetting.value as string) : 'AMD',\r\n      currencyRates: currencyRatesSetting ? (currencyRatesSetting.value as Record<string, number>) : defaultCurrencyRates,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update settings\r\n   */\r\n  async updateSettings(data: any) {\r\n    console.log('‚öôÔ∏è [ADMIN SERVICE] Updating settings...', data);\r\n    \r\n    // Update global discount\r\n    if (data.globalDiscount !== undefined) {\r\n      const globalDiscountValue = Number(data.globalDiscount) || 0;\r\n      await db.settings.upsert({\r\n        where: { key: 'globalDiscount' },\r\n        update: {\r\n          value: globalDiscountValue,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          key: 'globalDiscount',\r\n          value: globalDiscountValue,\r\n          description: 'Global discount percentage for all products',\r\n        },\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Global discount updated:', globalDiscountValue);\r\n    }\r\n    \r\n    // Update category discounts\r\n    if (data.categoryDiscounts !== undefined) {\r\n      await db.settings.upsert({\r\n        where: { key: 'categoryDiscounts' },\r\n        update: {\r\n          value: data.categoryDiscounts,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          key: 'categoryDiscounts',\r\n          value: data.categoryDiscounts,\r\n          description: 'Discount percentages by category ID',\r\n        },\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Category discounts updated:', data.categoryDiscounts);\r\n    }\r\n    \r\n    // Update brand discounts\r\n    if (data.brandDiscounts !== undefined) {\r\n      await db.settings.upsert({\r\n        where: { key: 'brandDiscounts' },\r\n        update: {\r\n          value: data.brandDiscounts,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          key: 'brandDiscounts',\r\n          value: data.brandDiscounts,\r\n          description: 'Discount percentages by brand ID',\r\n        },\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Brand discounts updated:', data.brandDiscounts);\r\n    }\r\n    \r\n    // Update default currency\r\n    if (data.defaultCurrency !== undefined) {\r\n      const currencyValue = String(data.defaultCurrency);\r\n      await db.settings.upsert({\r\n        where: { key: 'defaultCurrency' },\r\n        update: {\r\n          value: currencyValue,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          key: 'defaultCurrency',\r\n          value: currencyValue,\r\n          description: 'Default currency for admin product pricing (USD, AMD, EUR)',\r\n        },\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Default currency updated:', currencyValue);\r\n    }\r\n    \r\n    // Update currency rates\r\n    if (data.currencyRates !== undefined) {\r\n      await db.settings.upsert({\r\n        where: { key: 'currencyRates' },\r\n        update: {\r\n          value: data.currencyRates,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          key: 'currencyRates',\r\n          value: data.currencyRates,\r\n          description: 'Currency exchange rates relative to USD (USD, AMD, EUR, RUB, GEL)',\r\n        },\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Currency rates updated:', data.currencyRates);\r\n    }\r\n    \r\n    return { success: true };\r\n  }\r\n\r\n  /**\r\n   * Get price filter settings\r\n   */\r\n  async getPriceFilterSettings() {\r\n    console.log('‚öôÔ∏è [ADMIN SERVICE] Fetching price filter settings...');\r\n    const setting = await db.settings.findUnique({\r\n      where: { key: 'price-filter' },\r\n    });\r\n\r\n    if (!setting) {\r\n      console.log('‚úÖ [ADMIN SERVICE] Price filter settings not found, returning defaults');\r\n      return {\r\n        minPrice: null,\r\n        maxPrice: null,\r\n        stepSize: null,\r\n        stepSizePerCurrency: null,\r\n      };\r\n    }\r\n\r\n    const value = setting.value as {\r\n      minPrice?: number;\r\n      maxPrice?: number;\r\n      stepSize?: number;\r\n      stepSizePerCurrency?: {\r\n        USD?: number;\r\n        AMD?: number;\r\n        RUB?: number;\r\n        GEL?: number;\r\n      };\r\n    };\r\n    console.log('‚úÖ [ADMIN SERVICE] Price filter settings loaded:', value);\r\n    return {\r\n      minPrice: value.minPrice ?? null,\r\n      maxPrice: value.maxPrice ?? null,\r\n      stepSize: value.stepSize ?? null,\r\n      stepSizePerCurrency: value.stepSizePerCurrency ?? null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update price filter settings\r\n   */\r\n  async updatePriceFilterSettings(data: {\r\n    minPrice?: number | null;\r\n    maxPrice?: number | null;\r\n    stepSize?: number | null;\r\n    stepSizePerCurrency?: {\r\n      USD?: number | null;\r\n      AMD?: number | null;\r\n      RUB?: number | null;\r\n      GEL?: number | null;\r\n    } | null;\r\n  }) {\r\n    console.log('‚öôÔ∏è [ADMIN SERVICE] Updating price filter settings...', data);\r\n    \r\n    const value: {\r\n      minPrice?: number;\r\n      maxPrice?: number;\r\n      stepSize?: number;\r\n      stepSizePerCurrency?: {\r\n        USD?: number;\r\n        AMD?: number;\r\n        RUB?: number;\r\n        GEL?: number;\r\n      };\r\n    } = {};\r\n    \r\n    if (data.minPrice !== null && data.minPrice !== undefined) {\r\n      value.minPrice = data.minPrice;\r\n    }\r\n    if (data.maxPrice !== null && data.maxPrice !== undefined) {\r\n      value.maxPrice = data.maxPrice;\r\n    }\r\n    if (data.stepSize !== null && data.stepSize !== undefined) {\r\n      value.stepSize = data.stepSize;\r\n    }\r\n    if (data.stepSizePerCurrency) {\r\n      const cleaned: { USD?: number; AMD?: number; RUB?: number; GEL?: number } = {};\r\n      if (data.stepSizePerCurrency.USD !== null && data.stepSizePerCurrency.USD !== undefined) {\r\n        cleaned.USD = data.stepSizePerCurrency.USD;\r\n      }\r\n      if (data.stepSizePerCurrency.AMD !== null && data.stepSizePerCurrency.AMD !== undefined) {\r\n        cleaned.AMD = data.stepSizePerCurrency.AMD;\r\n      }\r\n      if (data.stepSizePerCurrency.RUB !== null && data.stepSizePerCurrency.RUB !== undefined) {\r\n        cleaned.RUB = data.stepSizePerCurrency.RUB;\r\n      }\r\n      if (data.stepSizePerCurrency.GEL !== null && data.stepSizePerCurrency.GEL !== undefined) {\r\n        cleaned.GEL = data.stepSizePerCurrency.GEL;\r\n      }\r\n      if (Object.keys(cleaned).length > 0) {\r\n        value.stepSizePerCurrency = cleaned;\r\n      }\r\n    }\r\n\r\n    const setting = await db.settings.upsert({\r\n      where: { key: 'price-filter' },\r\n      update: {\r\n        value: value,\r\n        updatedAt: new Date(),\r\n      },\r\n      create: {\r\n        key: 'price-filter',\r\n        value: value,\r\n        description: 'Price filter default range and step size settings',\r\n      },\r\n    });\r\n\r\n    console.log('‚úÖ [ADMIN SERVICE] Price filter settings updated:', setting);\r\n    const stored = setting.value as any;\r\n    return {\r\n      success: true,\r\n      minPrice: stored.minPrice ?? null,\r\n      maxPrice: stored.maxPrice ?? null,\r\n      stepSize: stored.stepSize ?? null,\r\n      stepSizePerCurrency: stored.stepSizePerCurrency ?? null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get user activity (recent registrations and active users)\r\n   */\r\n  async getUserActivity(limit: number = 10) {\r\n    // Get recent registrations\r\n    const recentUsers = await db.user.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n      },\r\n      take: limit,\r\n      orderBy: { createdAt: \"desc\" },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        createdAt: true,\r\n      },\r\n    });\r\n\r\n    const recentRegistrations = recentUsers.map((user: { id: string; email: string | null; phone: string | null; firstName: string | null; lastName: string | null; createdAt: Date }) => ({\r\n      id: user.id,\r\n      email: user.email || undefined,\r\n      phone: user.phone || undefined,\r\n      name: [user.firstName, user.lastName].filter(Boolean).join(\" \") || user.email || user.phone || \"Unknown\",\r\n      registeredAt: user.createdAt.toISOString(),\r\n      lastLoginAt: undefined, // We don't track last login yet\r\n    }));\r\n\r\n    // Get active users (users with orders)\r\n    const usersWithOrders = await db.user.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        orders: {\r\n          some: {},\r\n        },\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        createdAt: true,\r\n        orders: {\r\n          select: {\r\n            id: true,\r\n            total: true,\r\n            createdAt: true,\r\n          },\r\n          orderBy: { createdAt: \"desc\" },\r\n        },\r\n      },\r\n      take: limit,\r\n    });\r\n\r\n    const activeUsers = usersWithOrders.map((user: { id: string; email: string | null; phone: string | null; firstName: string | null; lastName: string | null; createdAt: Date; orders: Array<{ id: string; total: number; createdAt: Date }> }) => {\r\n      const orders = Array.isArray(user.orders) ? user.orders : [];\r\n      const orderCount = orders.length;\r\n      const totalSpent = orders.reduce((sum: number, order: { total: number }) => sum + order.total, 0);\r\n      const lastOrder = orders[0] || null;\r\n\r\n      return {\r\n        id: user.id,\r\n        email: user.email || undefined,\r\n        phone: user.phone || undefined,\r\n        name: [user.firstName, user.lastName].filter(Boolean).join(\" \") || user.email || user.phone || \"Unknown\",\r\n        orderCount,\r\n        totalSpent,\r\n        lastOrderDate: lastOrder ? lastOrder.createdAt.toISOString() : user.createdAt.toISOString(),\r\n        lastLoginAt: undefined, // We don't track last login yet\r\n      };\r\n    });\r\n\r\n    return {\r\n      recentRegistrations,\r\n      activeUsers,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get recent orders for dashboard\r\n   */\r\n  async getRecentOrders(limit: number = 5) {\r\n    const orders = await db.order.findMany({\r\n      take: limit,\r\n      orderBy: { createdAt: \"desc\" },\r\n      include: {\r\n        items: true,\r\n      },\r\n    });\r\n\r\n    return orders.map((order: { id: string; number: string; status: string; paymentStatus: string; total: number; currency: string | null; customerEmail: string | null; customerPhone: string | null; createdAt: Date; items: Array<unknown> }) => ({\r\n      id: order.id,\r\n      number: order.number,\r\n      status: order.status,\r\n      paymentStatus: order.paymentStatus,\r\n      total: order.total,\r\n      currency: order.currency,\r\n      customerEmail: order.customerEmail || undefined,\r\n      customerPhone: order.customerPhone || undefined,\r\n      itemsCount: order.items.length,\r\n      createdAt: order.createdAt.toISOString(),\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Get top products for dashboard\r\n   */\r\n  async getTopProducts(limit: number = 5) {\r\n    // Get all order items with their variants\r\n    const orderItems = await db.orderItem.findMany({\r\n      include: {\r\n        variant: {\r\n          include: {\r\n            product: {\r\n              include: {\r\n                translations: {\r\n                  where: { locale: \"en\" },\r\n                  take: 1,\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Group by variant and calculate stats\r\n    const productStats = new Map<\r\n      string,\r\n      {\r\n        variantId: string;\r\n        productId: string;\r\n        title: string;\r\n        sku: string;\r\n        totalQuantity: number;\r\n        totalRevenue: number;\r\n        orderCount: number;\r\n        image?: string | null;\r\n      }\r\n    >();\r\n\r\n    orderItems.forEach((item: { variantId: string | null; quantity: number; total: number; variant?: { id: string; productId: string; sku: string | null; product?: { translations?: Array<{ title: string }>; media?: Array<{ url?: string }> } }; sku?: string }) => {\r\n      if (!item.variant) return;\r\n\r\n      const variantId = item.variantId || item.variant.id;\r\n      const productId = item.variant.productId;\r\n      const product = item.variant.product;\r\n      const translations = product?.translations || [];\r\n      const translation = translations[0];\r\n      const title = translation?.title || \"Unknown Product\";\r\n      const sku = item.variant.sku || item.sku || \"N/A\";\r\n      const image = product && Array.isArray(product.media) && product.media.length > 0\r\n        ? (product.media[0] as any)?.url || null\r\n        : null;\r\n\r\n      if (!productStats.has(variantId)) {\r\n        productStats.set(variantId, {\r\n          variantId,\r\n          productId,\r\n          title,\r\n          sku,\r\n          totalQuantity: 0,\r\n          totalRevenue: 0,\r\n          orderCount: 0,\r\n          image,\r\n        });\r\n      }\r\n\r\n      const stats = productStats.get(variantId)!;\r\n      stats.totalQuantity += item.quantity;\r\n      stats.totalRevenue += item.total;\r\n      stats.orderCount += 1;\r\n    });\r\n\r\n    // Convert to array and sort by revenue\r\n    const topProducts = Array.from(productStats.values())\r\n      .sort((a, b) => b.totalRevenue - a.totalRevenue)\r\n      .slice(0, limit);\r\n\r\n    return topProducts;\r\n  }\r\n\r\n  /**\r\n   * Get categories for admin\r\n   */\r\n  async getCategories() {\r\n    const categories = await db.category.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n      },\r\n      include: {\r\n        translations: {\r\n          where: { locale: \"en\" },\r\n          take: 1,\r\n        },\r\n      },\r\n      orderBy: {\r\n        position: \"asc\",\r\n      },\r\n    });\r\n\r\n    return {\r\n      data: categories.map((category: { id: string; parentId: string | null; requiresSizes: boolean | null; translations?: Array<{ title: string; slug: string }> }) => {\r\n        const translations = Array.isArray(category.translations) ? category.translations : [];\r\n        const translation = translations[0] || null;\r\n        return {\r\n          id: category.id,\r\n          title: translation?.title || \"\",\r\n          slug: translation?.slug || \"\",\r\n          parentId: category.parentId,\r\n          requiresSizes: category.requiresSizes || false,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Create category\r\n   */\r\n  async createCategory(data: {\r\n    title: string;\r\n    locale?: string;\r\n    parentId?: string;\r\n    requiresSizes?: boolean;\r\n  }) {\r\n    const locale = data.locale || \"en\";\r\n    \r\n    // Validate parent category exists if parentId is provided\r\n    if (data.parentId) {\r\n      const parentCategory = await db.category.findUnique({\r\n        where: { id: data.parentId },\r\n      });\r\n\r\n      if (!parentCategory) {\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Parent category not found\",\r\n          detail: `Parent category with id '${data.parentId}' does not exist`,\r\n        };\r\n      }\r\n    }\r\n    \r\n    // Generate slug from title\r\n    const slug = data.title\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9]+/g, \"-\")\r\n      .replace(/^-+|-+$/g, \"\");\r\n\r\n    const category = await db.category.create({\r\n      data: {\r\n        parentId: data.parentId || undefined,\r\n        requiresSizes: data.requiresSizes || false,\r\n        published: true,\r\n        translations: {\r\n          create: {\r\n            locale,\r\n            title: data.title,\r\n            slug,\r\n            fullPath: slug, // Can be enhanced to build full path\r\n          },\r\n        },\r\n      },\r\n      include: {\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ translation —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n    const categoryTranslations = Array.isArray(category.translations) ? category.translations : [];\r\n    const translation = categoryTranslations.find((t: { locale: string }) => t.locale === locale) || categoryTranslations[0] || null;\r\n\r\n    return {\r\n      data: {\r\n        id: category.id,\r\n        title: translation?.title || \"\",\r\n        slug: translation?.slug || \"\",\r\n        parentId: category.parentId,\r\n        requiresSizes: category.requiresSizes || false,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get category by ID with children\r\n   */\r\n  async getCategoryById(categoryId: string) {\r\n    const category = await db.category.findUnique({\r\n      where: { id: categoryId },\r\n      include: {\r\n        translations: {\r\n          where: { locale: \"en\" },\r\n          take: 1,\r\n        },\r\n        children: {\r\n          include: {\r\n            translations: {\r\n              where: { locale: \"en\" },\r\n              take: 1,\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!category) {\r\n      return null;\r\n    }\r\n\r\n    const translations = Array.isArray(category.translations) ? category.translations : [];\r\n    const translation = translations[0] || null;\r\n\r\n    return {\r\n      id: category.id,\r\n      title: translation?.title || \"\",\r\n      slug: translation?.slug || \"\",\r\n      parentId: category.parentId,\r\n      requiresSizes: category.requiresSizes || false,\r\n      children: category.children.map((child: { id: string; parentId: string | null; requiresSizes: boolean | null; translations?: Array<{ title: string; slug: string }> }) => {\r\n        const childTranslations = Array.isArray(child.translations) ? child.translations : [];\r\n        const childTranslation = childTranslations[0] || null;\r\n        return {\r\n          id: child.id,\r\n          title: childTranslation?.title || \"\",\r\n          slug: childTranslation?.slug || \"\",\r\n          parentId: child.parentId,\r\n          requiresSizes: child.requiresSizes || false,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update category\r\n   */\r\n  async updateCategory(categoryId: string, data: {\r\n    title?: string;\r\n    locale?: string;\r\n    parentId?: string | null;\r\n    requiresSizes?: boolean;\r\n    subcategoryIds?: string[];\r\n  }) {\r\n    const locale = data.locale || \"en\";\r\n    \r\n    const category = await db.category.findUnique({\r\n      where: { id: categoryId },\r\n      include: {\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    if (!category) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Category not found\",\r\n        detail: `Category with id '${categoryId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    // Prevent circular reference (category cannot be its own parent)\r\n    if (data.parentId === categoryId) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/bad-request\",\r\n        title: \"Invalid parent\",\r\n        detail: \"Category cannot be its own parent\",\r\n      };\r\n    }\r\n\r\n    // Prevent setting parent to a child category (would create circular reference)\r\n    if (data.parentId) {\r\n      const potentialParent = await db.category.findUnique({\r\n        where: { id: data.parentId },\r\n        include: {\r\n          children: {\r\n            where: {\r\n              deletedAt: null,\r\n            },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!potentialParent) {\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Parent category not found\",\r\n          detail: `Parent category with id '${data.parentId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      // Check if the category to update is in the children of the potential parent\r\n      const isChild = await this.isCategoryDescendant(potentialParent.id, categoryId);\r\n      if (isChild) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/bad-request\",\r\n          title: \"Circular reference\",\r\n          detail: \"Cannot set parent to a category that is a descendant of this category\",\r\n        };\r\n      }\r\n    }\r\n\r\n    // Update subcategories if provided\r\n    if (data.subcategoryIds !== undefined) {\r\n      // First, remove all existing children relationships\r\n      await db.category.updateMany({\r\n        where: { parentId: categoryId },\r\n        data: { parentId: null },\r\n      });\r\n\r\n      // Then, set new children relationships (prevent circular references)\r\n      if (data.subcategoryIds.length > 0) {\r\n        // Filter out the category itself and its descendants\r\n        const validSubcategoryIds = data.subcategoryIds.filter(id => id !== categoryId);\r\n        \r\n        // Check for circular references\r\n        for (const subId of validSubcategoryIds) {\r\n          const isDescendant = await this.isCategoryDescendant(categoryId, subId);\r\n          if (isDescendant) {\r\n            throw {\r\n              status: 400,\r\n              type: \"https://api.shop.am/problems/bad-request\",\r\n              title: \"Circular reference\",\r\n              detail: \"Cannot set a descendant category as subcategory\",\r\n            };\r\n          }\r\n        }\r\n\r\n        if (validSubcategoryIds.length > 0) {\r\n          await db.category.updateMany({\r\n            where: { \r\n              id: { in: validSubcategoryIds },\r\n            },\r\n            data: { parentId: categoryId },\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    const updateData: any = {};\r\n    \r\n    if (data.parentId !== undefined) {\r\n      updateData.parentId = data.parentId || null;\r\n    }\r\n    \r\n    if (data.requiresSizes !== undefined) {\r\n      updateData.requiresSizes = data.requiresSizes;\r\n    }\r\n\r\n    // Update translation if title is provided\r\n    if (data.title) {\r\n      const slug = data.title\r\n        .toLowerCase()\r\n        .replace(/[^a-z0-9]+/g, \"-\")\r\n        .replace(/^-+|-+$/g, \"\");\r\n\r\n      const categoryTranslations = Array.isArray(category.translations) ? category.translations : [];\r\n      const existingTranslation = categoryTranslations.find((t: { locale: string }) => t.locale === locale);\r\n\r\n      if (existingTranslation) {\r\n        // Update existing translation\r\n        await db.categoryTranslation.update({\r\n          where: { id: existingTranslation.id },\r\n          data: {\r\n            title: data.title,\r\n            slug,\r\n          },\r\n        });\r\n      } else {\r\n        // Create new translation\r\n        await db.categoryTranslation.create({\r\n          data: {\r\n            categoryId: category.id,\r\n            locale,\r\n            title: data.title,\r\n            slug,\r\n            fullPath: slug,\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    // Update category base data\r\n    const updatedCategory = await db.category.update({\r\n      where: { id: categoryId },\r\n      data: updateData,\r\n      include: {\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    const categoryTranslations = Array.isArray(updatedCategory.translations) ? updatedCategory.translations : [];\r\n    const translation = categoryTranslations.find((t: { locale: string }) => t.locale === locale) || categoryTranslations[0] || null;\r\n\r\n    return {\r\n      data: {\r\n        id: updatedCategory.id,\r\n        title: translation?.title || \"\",\r\n        slug: translation?.slug || \"\",\r\n        parentId: updatedCategory.parentId,\r\n        requiresSizes: updatedCategory.requiresSizes || false,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Helper function to check if a category is a descendant of another category\r\n   */\r\n  private async isCategoryDescendant(ancestorId: string, descendantId: string, visited: Set<string> = new Set()): Promise<boolean> {\r\n    if (visited.has(descendantId)) {\r\n      // Circular reference detected\r\n      return false;\r\n    }\r\n    visited.add(descendantId);\r\n\r\n    const category = await db.category.findUnique({\r\n      where: { id: descendantId },\r\n      include: {\r\n        parent: true,\r\n      },\r\n    });\r\n\r\n    if (!category || !category.parent) {\r\n      return false;\r\n    }\r\n\r\n    if (category.parent.id === ancestorId) {\r\n      return true;\r\n    }\r\n\r\n    return this.isCategoryDescendant(ancestorId, category.parent.id, visited);\r\n  }\r\n\r\n  /**\r\n   * Get brands for admin\r\n   */\r\n  async getBrands() {\r\n    const brands = await db.brand.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n      },\r\n      include: {\r\n        translations: {\r\n          where: { locale: \"en\" },\r\n          take: 1,\r\n        },\r\n      },\r\n      orderBy: {\r\n        createdAt: \"desc\",\r\n      },\r\n    });\r\n\r\n    return {\r\n      data: brands.map((brand: { id: string; slug: string; translations?: Array<{ name: string }> }) => {\r\n        const translations = Array.isArray(brand.translations) ? brand.translations : [];\r\n        const translation = translations[0] || null;\r\n        return {\r\n          id: brand.id,\r\n          name: translation?.name || \"\",\r\n          slug: brand.slug,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Create brand\r\n   */\r\n  async createBrand(data: {\r\n    name: string;\r\n    locale?: string;\r\n    logoUrl?: string;\r\n  }) {\r\n    const locale = data.locale || \"en\";\r\n    \r\n    // Generate base slug from name\r\n    const baseSlug = data.name\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9]+/g, \"-\")\r\n      .replace(/^-+|-+$/g, \"\");\r\n\r\n    // Generate unique slug by appending number if needed\r\n    let slug = baseSlug;\r\n    let counter = 1;\r\n    let existing = await db.brand.findUnique({\r\n      where: { slug },\r\n    });\r\n\r\n    while (existing) {\r\n      slug = `${baseSlug}-${counter}`;\r\n      counter++;\r\n      existing = await db.brand.findUnique({\r\n        where: { slug },\r\n      });\r\n      \r\n      // Safety check to prevent infinite loop\r\n      if (counter > 1000) {\r\n        throw {\r\n          status: 500,\r\n          type: \"https://api.shop.am/problems/internal-error\",\r\n          title: \"Unable to generate unique slug\",\r\n          detail: \"Could not generate a unique slug for the brand after many attempts\",\r\n        };\r\n      }\r\n    }\r\n\r\n    const brand = await db.brand.create({\r\n      data: {\r\n        slug,\r\n        logoUrl: data.logoUrl || undefined,\r\n        published: true,\r\n        translations: {\r\n          create: {\r\n            locale,\r\n            name: data.name,\r\n          },\r\n        },\r\n      },\r\n      include: {\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ translation —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞\r\n    const brandTranslations = Array.isArray(brand.translations) ? brand.translations : [];\r\n    const translation = brandTranslations.find((t: { locale: string }) => t.locale === locale) || brandTranslations[0] || null;\r\n\r\n    return {\r\n      data: {\r\n        id: brand.id,\r\n        name: translation?.name || \"\",\r\n        slug: brand.slug,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Delete category (soft delete)\r\n   */\r\n  async deleteCategory(categoryId: string) {\r\n    console.log('üóëÔ∏è [ADMIN SERVICE] deleteCategory called:', categoryId);\r\n    \r\n    const category = await db.category.findUnique({\r\n      where: { id: categoryId },\r\n      include: {\r\n        children: {\r\n          where: {\r\n            deletedAt: null,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!category) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Category not found\",\r\n        detail: `Category with id '${categoryId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    // Check if category has children\r\n    const childrenCount = category.children ? category.children.length : 0;\r\n    if (childrenCount > 0) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/bad-request\",\r\n        title: \"Cannot delete category\",\r\n        detail: `This category has ${childrenCount} child categor${childrenCount > 1 ? 'ies' : 'y'}. Please delete or move child categories first.`,\r\n        childrenCount,\r\n      };\r\n    }\r\n\r\n    // Check if category has products (using count for better performance)\r\n    const productsCount = await db.product.count({\r\n      where: {\r\n        OR: [\r\n          { primaryCategoryId: categoryId },\r\n          { categoryIds: { has: categoryId } },\r\n        ],\r\n        deletedAt: null,\r\n      },\r\n    });\r\n\r\n    if (productsCount > 0) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/bad-request\",\r\n        title: \"Cannot delete category\",\r\n        detail: `This category has ${productsCount} associated product${productsCount > 1 ? 's' : ''}. Please remove products from this category first.`,\r\n        productsCount,\r\n      };\r\n    }\r\n\r\n    await db.category.update({\r\n      where: { id: categoryId },\r\n      data: {\r\n        deletedAt: new Date(),\r\n        published: false,\r\n      },\r\n    });\r\n\r\n    console.log('‚úÖ [ADMIN SERVICE] Category deleted:', categoryId);\r\n    return { success: true };\r\n  }\r\n\r\n  /**\r\n   * Update brand\r\n   */\r\n  async updateBrand(\r\n    brandId: string,\r\n    data: {\r\n      name?: string;\r\n      locale?: string;\r\n      logoUrl?: string;\r\n    }\r\n  ) {\r\n    console.log('üîÑ [ADMIN SERVICE] updateBrand called:', brandId, data);\r\n    \r\n    const brand = await db.brand.findUnique({\r\n      where: { id: brandId },\r\n      include: {\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    if (!brand) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Brand not found\",\r\n        detail: `Brand with id '${brandId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    const locale = data.locale || \"en\";\r\n    const updateData: any = {};\r\n\r\n    // Update logo URL if provided\r\n    if (data.logoUrl !== undefined) {\r\n      updateData.logoUrl = data.logoUrl || null;\r\n    }\r\n\r\n    // Update translation if name is provided\r\n    if (data.name !== undefined) {\r\n      const brandTranslations = Array.isArray(brand.translations) ? brand.translations : [];\r\n      const existingTranslation = brandTranslations.find(\r\n        (t: { locale: string }) => t.locale === locale\r\n      );\r\n\r\n      if (existingTranslation) {\r\n        // Update existing translation\r\n        await db.brandTranslation.update({\r\n          where: { id: existingTranslation.id },\r\n          data: { name: data.name },\r\n        });\r\n      } else {\r\n        // Create new translation\r\n        await db.brandTranslation.create({\r\n          data: {\r\n            brandId: brand.id,\r\n            locale,\r\n            name: data.name,\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    // Update brand base data if needed\r\n    if (Object.keys(updateData).length > 0) {\r\n      await db.brand.update({\r\n        where: { id: brandId },\r\n        data: updateData,\r\n      });\r\n    }\r\n\r\n    // Fetch updated brand with translations\r\n    const updatedBrand = await db.brand.findUnique({\r\n      where: { id: brandId },\r\n      include: {\r\n        translations: {\r\n          where: { locale },\r\n          take: 1,\r\n        },\r\n      },\r\n    });\r\n\r\n    const brandTranslations = Array.isArray(updatedBrand?.translations) \r\n      ? updatedBrand.translations \r\n      : [];\r\n    const translation = brandTranslations[0] || null;\r\n\r\n    return {\r\n      data: {\r\n        id: updatedBrand!.id,\r\n        name: translation?.name || \"\",\r\n        slug: updatedBrand!.slug,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Delete brand (soft delete)\r\n   */\r\n  async deleteBrand(brandId: string) {\r\n    console.log('üóëÔ∏è [ADMIN SERVICE] deleteBrand called:', brandId);\r\n    \r\n    const brand = await db.brand.findUnique({\r\n      where: { id: brandId },\r\n    });\r\n\r\n    if (!brand) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Brand not found\",\r\n        detail: `Brand with id '${brandId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    // Check if brand has products (using count for better performance)\r\n    const productsCount = await db.product.count({\r\n      where: {\r\n        brandId: brandId,\r\n        deletedAt: null,\r\n      },\r\n    });\r\n\r\n    if (productsCount > 0) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/bad-request\",\r\n        title: \"Cannot delete brand\",\r\n        detail: `This brand has ${productsCount} associated product${productsCount > 1 ? 's' : ''}. Please remove or change brand for these products first.`,\r\n        productsCount,\r\n      };\r\n    }\r\n\r\n    await db.brand.update({\r\n      where: { id: brandId },\r\n      data: {\r\n        deletedAt: new Date(),\r\n        published: false,\r\n      },\r\n    });\r\n\r\n    console.log('‚úÖ [ADMIN SERVICE] Brand deleted:', brandId);\r\n    return { success: true };\r\n  }\r\n\r\n  /**\r\n   * Get attributes for admin\r\n   */\r\n  async getAttributes() {\r\n    // Ensure colors and imageUrl columns exist (runtime migration)\r\n    try {\r\n      await this.ensureColorsColumnsExist();\r\n    } catch (migrationError: any) {\r\n      console.warn('‚ö†Ô∏è [ADMIN SERVICE] Migration check failed:', migrationError.message);\r\n      // Continue anyway - might already exist\r\n    }\r\n\r\n    let attributes;\r\n    try {\r\n      attributes = await db.attribute.findMany({\r\n        include: {\r\n          translations: {\r\n            where: { locale: \"en\" },\r\n            take: 1,\r\n          },\r\n          values: {\r\n            include: {\r\n              translations: {\r\n                where: { locale: \"en\" },\r\n                take: 1,\r\n              },\r\n            },\r\n            orderBy: {\r\n              position: \"asc\",\r\n            },\r\n          },\r\n        },\r\n        orderBy: {\r\n          position: \"asc\",\r\n        },\r\n      });\r\n    } catch (error: any) {\r\n      // If attribute_values.colors column doesn't exist, fetch without it\r\n      if (error?.code === 'P2022' || error?.message?.includes('attribute_values.colors') || error?.message?.includes('does not exist')) {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] attribute_values.colors column not found, fetching without it:', error.message);\r\n        // Fetch attributes first\r\n        const attributesList = await db.attribute.findMany({\r\n          include: {\r\n            translations: {\r\n              where: { locale: \"en\" },\r\n              take: 1,\r\n            },\r\n          },\r\n          orderBy: {\r\n            position: \"asc\",\r\n          },\r\n        });\r\n\r\n        // Fetch values separately without colors and imageUrl using Prisma\r\n        // Try with select first, if it fails (because Prisma tries to select colors), use raw query\r\n        let allValues: any[];\r\n        try {\r\n          allValues = await db.attributeValue.findMany({\r\n            select: {\r\n              id: true,\r\n              attributeId: true,\r\n              value: true,\r\n              position: true,\r\n              translations: {\r\n                where: { locale: \"en\" },\r\n                take: 1,\r\n              },\r\n            },\r\n            orderBy: {\r\n              position: \"asc\",\r\n            },\r\n          });\r\n        } catch (selectError: any) {\r\n          // If select also fails, use raw query with correct column name\r\n          // Try with quoted name first, then without quotes\r\n          console.warn('‚ö†Ô∏è [ADMIN SERVICE] Using raw query for attribute values:', selectError.message);\r\n          try {\r\n            allValues = await db.$queryRaw`\r\n              SELECT \r\n                av.id,\r\n                av.\"attributeId\",\r\n                av.value,\r\n                av.position\r\n              FROM attribute_values av\r\n              ORDER BY av.position ASC\r\n            ` as any[];\r\n          } catch (rawError: any) {\r\n            // If quoted name doesn't work, try without quotes (snake_case)\r\n            console.warn('‚ö†Ô∏è [ADMIN SERVICE] Trying with snake_case column name:', rawError.message);\r\n            allValues = await db.$queryRaw`\r\n              SELECT \r\n                av.id,\r\n                av.attribute_id as \"attributeId\",\r\n                av.value,\r\n                av.position\r\n              FROM attribute_values av\r\n              ORDER BY av.position ASC\r\n            ` as any[];\r\n          }\r\n          \r\n          // Fetch translations separately\r\n          const valueIds = allValues.map((v: any) => v.id);\r\n          const valueTranslations = valueIds.length > 0 \r\n            ? await db.attributeValueTranslation.findMany({\r\n                where: {\r\n                  attributeValueId: { in: valueIds },\r\n                  locale: \"en\",\r\n                },\r\n              })\r\n            : [];\r\n          \r\n          // Add translations to values\r\n          allValues = allValues.map((val: any) => ({\r\n            ...val,\r\n            translations: valueTranslations.filter((t: any) => t.attributeValueId === val.id),\r\n          }));\r\n        }\r\n\r\n        // Combine attributes with their values\r\n        attributes = attributesList.map((attr: any) => {\r\n          const attrValues = allValues\r\n            .filter((val: any) => val.attributeId === attr.id)\r\n            .map((val: any) => {\r\n              return {\r\n                id: val.id,\r\n                attributeId: val.attributeId,\r\n                value: val.value,\r\n                position: val.position,\r\n                colors: null, // Add null for compatibility\r\n                imageUrl: null, // Add null for compatibility\r\n                translations: Array.isArray(val.translations) ? val.translations : [],\r\n              };\r\n            });\r\n          \r\n          return {\r\n            ...attr,\r\n            values: attrValues,\r\n          };\r\n        });\r\n      } else {\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    return {\r\n      data: attributes.map((attribute: { id: string; key: string; type: string; filterable: boolean; translations?: Array<{ name: string }>; values?: Array<{ id: string; value: string; translations?: Array<{ label: string }>; colors?: any; imageUrl?: string | null }> }) => {\r\n        const translations = Array.isArray(attribute.translations) ? attribute.translations : [];\r\n        const translation = translations[0] || null;\r\n        const values = Array.isArray(attribute.values) ? attribute.values : [];\r\n        return {\r\n          id: attribute.id,\r\n          key: attribute.key,\r\n          name: translation?.name || attribute.key,\r\n          type: attribute.type,\r\n          filterable: attribute.filterable,\r\n          values: values.map((value: any) => {\r\n            const valueTranslations = Array.isArray(value.translations) ? value.translations : [];\r\n            const valueTranslation = valueTranslations[0] || null;\r\n            const colorsData = value.colors;\r\n            let colorsArray: string[] = [];\r\n            \r\n            if (colorsData) {\r\n              if (Array.isArray(colorsData)) {\r\n                colorsArray = colorsData;\r\n              } else if (typeof colorsData === 'string') {\r\n                try {\r\n                  colorsArray = JSON.parse(colorsData);\r\n                } catch (e) {\r\n                  console.warn('‚ö†Ô∏è [ADMIN SERVICE] Failed to parse colors JSON:', e);\r\n                  colorsArray = [];\r\n                }\r\n              } else if (typeof colorsData === 'object') {\r\n                // If it's already an object (from Prisma JSONB), use it directly\r\n                colorsArray = Array.isArray(colorsData) ? colorsData : [];\r\n              }\r\n            }\r\n            \r\n            // Ensure colorsArray is always an array of strings\r\n            if (!Array.isArray(colorsArray)) {\r\n              colorsArray = [];\r\n            }\r\n            \r\n            console.log('üé® [ADMIN SERVICE] Parsed colors for value:', {\r\n              valueId: value.id,\r\n              valueLabel: valueTranslation?.label || value.value,\r\n              colorsData,\r\n              colorsDataType: typeof colorsData,\r\n              colorsArray,\r\n              colorsArrayLength: colorsArray.length\r\n            });\r\n            \r\n            return {\r\n              id: value.id,\r\n              value: value.value,\r\n              label: valueTranslation?.label || value.value,\r\n              colors: colorsArray,\r\n              imageUrl: value.imageUrl || null,\r\n            };\r\n          }),\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Create attribute\r\n   */\r\n  async createAttribute(data: {\r\n    name: string;\r\n    key: string;\r\n    type?: string;\r\n    filterable?: boolean;\r\n    locale?: string;\r\n  }) {\r\n    console.log('üÜï [ADMIN SERVICE] Creating attribute:', data.key);\r\n\r\n    // Check if attribute with this key already exists\r\n    const existing = await db.attribute.findUnique({\r\n      where: { key: data.key },\r\n    });\r\n\r\n    if (existing) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Attribute already exists\",\r\n        detail: `Attribute with key '${data.key}' already exists`,\r\n      };\r\n    }\r\n\r\n    const attribute = await db.attribute.create({\r\n      data: {\r\n        key: data.key,\r\n        type: data.type || \"select\",\r\n        filterable: data.filterable !== false,\r\n        translations: {\r\n          create: {\r\n            locale: data.locale || \"en\",\r\n            name: data.name,\r\n          },\r\n        },\r\n      },\r\n      include: {\r\n        translations: {\r\n          where: { locale: data.locale || \"en\" },\r\n        },\r\n        values: {\r\n          include: {\r\n            translations: {\r\n              where: { locale: data.locale || \"en\" },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    const translation = attribute.translations[0];\r\n    const values = attribute.values || [];\r\n\r\n    return {\r\n      id: attribute.id,\r\n      key: attribute.key,\r\n      name: translation?.name || attribute.key,\r\n      type: attribute.type,\r\n      filterable: attribute.filterable,\r\n      values: values.map((val: any) => {\r\n        const valTranslation = val.translations?.[0];\r\n        return {\r\n          id: val.id,\r\n          value: val.value,\r\n          label: valTranslation?.label || val.value,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update attribute translation (name)\r\n   */\r\n  async updateAttributeTranslation(\r\n    attributeId: string,\r\n    data: {\r\n      name: string;\r\n      locale?: string;\r\n    }\r\n  ) {\r\n    console.log('‚úèÔ∏è [ADMIN SERVICE] Updating attribute translation:', { attributeId, name: data.name });\r\n\r\n    const attribute = await db.attribute.findUnique({\r\n      where: { id: attributeId },\r\n      include: {\r\n        translations: {\r\n          where: { locale: data.locale || \"en\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!attribute) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Attribute not found\",\r\n        detail: `Attribute with id '${attributeId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    const locale = data.locale || \"en\";\r\n\r\n    // Use upsert to handle both create and update cases\r\n    await db.attributeTranslation.upsert({\r\n      where: {\r\n        attributeId_locale: {\r\n          attributeId,\r\n          locale,\r\n        },\r\n      },\r\n      update: {\r\n        name: data.name.trim(),\r\n      },\r\n      create: {\r\n        attributeId,\r\n        locale,\r\n        name: data.name.trim(),\r\n      },\r\n    });\r\n\r\n    // Return updated attribute with all values\r\n    const updatedAttribute = await db.attribute.findUnique({\r\n      where: { id: attributeId },\r\n      include: {\r\n        translations: {\r\n          where: { locale },\r\n        },\r\n        values: {\r\n          include: {\r\n            translations: {\r\n              where: { locale },\r\n            },\r\n          },\r\n          orderBy: { position: \"asc\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!updatedAttribute) {\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: \"Failed to retrieve updated attribute\",\r\n      };\r\n    }\r\n\r\n    const translation = updatedAttribute.translations[0];\r\n    const values = updatedAttribute.values || [];\r\n\r\n    return {\r\n      id: updatedAttribute.id,\r\n      key: updatedAttribute.key,\r\n      name: translation?.name || updatedAttribute.key,\r\n      type: updatedAttribute.type,\r\n      filterable: updatedAttribute.filterable,\r\n      values: values.map((val: any) => {\r\n        const valTranslation = val.translations?.[0];\r\n        return {\r\n          id: val.id,\r\n          value: val.value,\r\n          label: valTranslation?.label || val.value,\r\n          colors: Array.isArray(val.colors) ? val.colors : (val.colors ? JSON.parse(val.colors as string) : []),\r\n          imageUrl: val.imageUrl || null,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Add attribute value\r\n   */\r\n  async addAttributeValue(attributeId: string, data: { label: string; locale?: string }) {\r\n    console.log('‚ûï [ADMIN SERVICE] Adding attribute value:', { attributeId, label: data.label });\r\n\r\n    const attribute = await db.attribute.findUnique({\r\n      where: { id: attributeId },\r\n    });\r\n\r\n    if (!attribute) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Attribute not found\",\r\n        detail: `Attribute with id '${attributeId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    // Use label as value (normalized)\r\n    const value = data.label.trim().toLowerCase().replace(/\\s+/g, '-');\r\n\r\n    // Check if value already exists\r\n    const existing = await db.attributeValue.findFirst({\r\n      where: {\r\n        attributeId,\r\n        value,\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Value already exists\",\r\n        detail: `Value '${data.label}' already exists for this attribute`,\r\n      };\r\n    }\r\n\r\n    const attributeValue = await db.attributeValue.create({\r\n      data: {\r\n        attributeId,\r\n        value,\r\n        translations: {\r\n          create: {\r\n            locale: data.locale || \"en\",\r\n            label: data.label.trim(),\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Return updated attribute with all values\r\n    const updatedAttribute = await db.attribute.findUnique({\r\n      where: { id: attributeId },\r\n      include: {\r\n        translations: {\r\n          where: { locale: data.locale || \"en\" },\r\n        },\r\n        values: {\r\n          include: {\r\n            translations: {\r\n              where: { locale: data.locale || \"en\" },\r\n            },\r\n          },\r\n          orderBy: { position: \"asc\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!updatedAttribute) {\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: \"Failed to retrieve updated attribute\",\r\n      };\r\n    }\r\n\r\n    const translation = updatedAttribute.translations[0];\r\n    const values = updatedAttribute.values || [];\r\n\r\n    return {\r\n      id: updatedAttribute.id,\r\n      key: updatedAttribute.key,\r\n      name: translation?.name || updatedAttribute.key,\r\n      type: updatedAttribute.type,\r\n      filterable: updatedAttribute.filterable,\r\n      values: values.map((val: any) => {\r\n        const valTranslation = val.translations?.[0];\r\n        return {\r\n          id: val.id,\r\n          value: val.value,\r\n          label: valTranslation?.label || val.value,\r\n          colors: Array.isArray(val.colors) ? val.colors : (val.colors ? JSON.parse(val.colors as string) : []),\r\n          imageUrl: val.imageUrl || null,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Update attribute value\r\n   */\r\n  async updateAttributeValue(\r\n    attributeId: string,\r\n    valueId: string,\r\n    data: {\r\n      label?: string;\r\n      colors?: string[];\r\n      imageUrl?: string | null;\r\n      locale?: string;\r\n    }\r\n  ) {\r\n    console.log('‚úèÔ∏è [ADMIN SERVICE] Updating attribute value:', { attributeId, valueId, data });\r\n\r\n    // Ensure colors and imageUrl columns exist (runtime migration)\r\n    try {\r\n      await this.ensureColorsColumnsExist();\r\n    } catch (migrationError: any) {\r\n      console.warn('‚ö†Ô∏è [ADMIN SERVICE] Migration check failed:', migrationError.message);\r\n      // Continue anyway - might already exist\r\n    }\r\n\r\n    const attributeValue = await db.attributeValue.findUnique({\r\n      where: { id: valueId },\r\n      include: {\r\n        attribute: true,\r\n        translations: true,\r\n      },\r\n    });\r\n\r\n    if (!attributeValue) {\r\n      throw {\r\n        status: 404,\r\n        type: \"https://api.shop.am/problems/not-found\",\r\n        title: \"Attribute value not found\",\r\n        detail: `Attribute value with id '${valueId}' does not exist`,\r\n      };\r\n    }\r\n\r\n    if (attributeValue.attributeId !== attributeId) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation Error\",\r\n        detail: \"Attribute value does not belong to the specified attribute\",\r\n      };\r\n    }\r\n\r\n    const locale = data.locale || \"en\";\r\n    const updateData: any = {};\r\n\r\n    // Update colors if provided\r\n    if (data.colors !== undefined) {\r\n      // Ensure colors is always an array (even if empty)\r\n      // Prisma JSONB field expects an array format\r\n      updateData.colors = Array.isArray(data.colors) ? data.colors : [];\r\n      console.log('üé® [ADMIN SERVICE] Setting colors:', { \r\n        valueId, \r\n        colors: updateData.colors, \r\n        colorsType: typeof updateData.colors,\r\n        isArray: Array.isArray(updateData.colors)\r\n      });\r\n    }\r\n\r\n    // Update imageUrl if provided\r\n    if (data.imageUrl !== undefined) {\r\n      updateData.imageUrl = data.imageUrl || null;\r\n    }\r\n\r\n    // Update translation label if provided\r\n    if (data.label !== undefined) {\r\n      const existingTranslation = attributeValue.translations.find(\r\n        (t: any) => t.locale === locale\r\n      );\r\n\r\n      if (existingTranslation) {\r\n        await db.attributeValueTranslation.update({\r\n          where: { id: existingTranslation.id },\r\n          data: { label: data.label.trim() },\r\n        });\r\n      } else {\r\n        await db.attributeValueTranslation.create({\r\n          data: {\r\n            attributeValueId: valueId,\r\n            locale,\r\n            label: data.label.trim(),\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    // Update attribute value if colors or imageUrl changed\r\n    if (Object.keys(updateData).length > 0) {\r\n      console.log('üíæ [ADMIN SERVICE] Updating attribute value in database:', { \r\n        valueId, \r\n        updateData,\r\n        updateDataKeys: Object.keys(updateData)\r\n      });\r\n      const updatedValue = await db.attributeValue.update({\r\n        where: { id: valueId },\r\n        data: updateData,\r\n      });\r\n      console.log('‚úÖ [ADMIN SERVICE] Attribute value updated:', { \r\n        valueId, \r\n        savedColors: updatedValue.colors,\r\n        savedColorsType: typeof updatedValue.colors\r\n      });\r\n    }\r\n\r\n    // Return updated attribute with all values\r\n    const updatedAttribute = await db.attribute.findUnique({\r\n      where: { id: attributeId },\r\n      include: {\r\n        translations: {\r\n          where: { locale },\r\n        },\r\n        values: {\r\n          include: {\r\n            translations: {\r\n              where: { locale },\r\n            },\r\n          },\r\n          orderBy: { position: \"asc\" },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!updatedAttribute) {\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: \"Failed to retrieve updated attribute\",\r\n      };\r\n    }\r\n\r\n    const translation = updatedAttribute.translations[0];\r\n    const values = updatedAttribute.values || [];\r\n\r\n    return {\r\n      id: updatedAttribute.id,\r\n      key: updatedAttribute.key,\r\n      name: translation?.name || updatedAttribute.key,\r\n      type: updatedAttribute.type,\r\n      filterable: updatedAttribute.filterable,\r\n      values: values.map((val: any) => {\r\n        const valTranslation = val.translations?.[0];\r\n        const colorsData = val.colors;\r\n        let colorsArray: string[] = [];\r\n        \r\n        if (colorsData) {\r\n          if (Array.isArray(colorsData)) {\r\n            colorsArray = colorsData;\r\n          } else if (typeof colorsData === 'string') {\r\n            try {\r\n              colorsArray = JSON.parse(colorsData);\r\n            } catch (e) {\r\n              console.warn('‚ö†Ô∏è [ADMIN SERVICE] Failed to parse colors JSON in updateAttributeValue:', e);\r\n              colorsArray = [];\r\n            }\r\n          } else if (typeof colorsData === 'object') {\r\n            colorsArray = Array.isArray(colorsData) ? colorsData : [];\r\n          }\r\n        }\r\n        \r\n        // Ensure colorsArray is always an array of strings\r\n        if (!Array.isArray(colorsArray)) {\r\n          colorsArray = [];\r\n        }\r\n        \r\n        return {\r\n          id: val.id,\r\n          value: val.value,\r\n          label: valTranslation?.label || val.value,\r\n          colors: colorsArray,\r\n          imageUrl: val.imageUrl || null,\r\n        };\r\n      }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Delete attribute\r\n   */\r\n  async deleteAttribute(attributeId: string) {\r\n    try {\r\n      console.log('üóëÔ∏è [ADMIN SERVICE] ’ç’Ø’Ω’æ’∏÷Ç’¥ ’ß attribute-’´ ’∞’•’º’°÷Å’∏÷Ç’¥:', {\r\n        attributeId,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’°÷Ä’§’µ’∏÷Ñ attribute-’® ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´\r\n      console.log('üîç [ADMIN SERVICE] ’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß attribute-’´ ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂’®...');\r\n      const attribute = await db.attribute.findUnique({\r\n        where: { id: attributeId },\r\n        select: {\r\n          id: true,\r\n          key: true,\r\n        },\r\n      });\r\n\r\n      if (!attribute) {\r\n        console.log('‚ùå [ADMIN SERVICE] Attribute-’® ’π’´ ’£’ø’∂’æ’•’¨:', attributeId);\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Attribute not found\",\r\n          detail: `Attribute with id '${attributeId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      console.log('‚úÖ [ADMIN SERVICE] Attribute-’® ’£’ø’∂’æ’•’¨ ’ß:', {\r\n        id: attribute.id,\r\n        key: attribute.key,\r\n      });\r\n\r\n      // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’°÷Ä’§’µ’∏÷Ñ attribute-’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’ß ’°÷Ä’ø’°’§÷Ä’°’∂÷Ñ’∂’•÷Ä’∏÷Ç’¥\r\n      console.log('üîç [ADMIN SERVICE] ’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß, ’°÷Ä’§’µ’∏÷Ñ attribute-’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’ß ’°÷Ä’ø’°’§÷Ä’°’∂÷Ñ’∂’•÷Ä’∏÷Ç’¥...');\r\n      \r\n      let productAttributesCount = 0;\r\n      \r\n      // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’°÷Ä’§’µ’∏÷Ñ db.productAttribute ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´\r\n      if (db.productAttribute) {\r\n        try {\r\n          productAttributesCount = await db.productAttribute.count({\r\n            where: { attributeId },\r\n          });\r\n          console.log('üìä [ADMIN SERVICE] Product attributes count:', productAttributesCount);\r\n        } catch (countError: any) {\r\n          console.error('‚ùå [ADMIN SERVICE] Product attributes count ’Ω’≠’°’¨:', {\r\n            error: countError,\r\n            message: countError?.message,\r\n            code: countError?.code,\r\n          });\r\n          // ‘µ’©’• count-’® ’π’´ ’°’∑’≠’°’ø’∏÷Ç’¥, ÷É’∏÷Ä’±’∏÷Ç’¥ ’•’∂÷Ñ findMany-’∏’æ\r\n          try {\r\n            const productAttributes = await db.productAttribute.findMany({\r\n              where: { attributeId },\r\n              select: { id: true },\r\n            });\r\n            productAttributesCount = productAttributes.length;\r\n            console.log('üìä [ADMIN SERVICE] Product attributes count (via findMany):', productAttributesCount);\r\n          } catch (findError: any) {\r\n            console.warn('‚ö†Ô∏è [ADMIN SERVICE] Product attributes findMany-’® ’∂’∏÷Ç’µ’∂’∫’•’Ω ’π’´ ’°’∑’≠’°’ø’∏÷Ç’¥, skip ’°’∂’∏÷Ç’¥ ’•’∂÷Ñ ’Ω’ø’∏÷Ç’£’∏÷Ç’¥’®');\r\n            productAttributesCount = 0;\r\n          }\r\n        }\r\n      } else {\r\n        console.warn('‚ö†Ô∏è [ADMIN SERVICE] db.productAttribute-’® undefined ’ß, skip ’°’∂’∏÷Ç’¥ ’•’∂÷Ñ product attributes ’Ω’ø’∏÷Ç’£’∏÷Ç’¥’®');\r\n      }\r\n\r\n      if (productAttributesCount > 0) {\r\n        console.log('‚ö†Ô∏è [ADMIN SERVICE] Attribute-’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’ß ’°÷Ä’ø’°’§÷Ä’°’∂÷Ñ’∂’•÷Ä’∏÷Ç’¥:', productAttributesCount);\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Cannot delete attribute\",\r\n          detail: `Attribute is used in ${productAttributesCount} product(s). Please remove it from products first.`,\r\n        };\r\n      }\r\n\r\n      // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’°÷Ä’§’µ’∏÷Ñ attribute values-’∂’•÷Ä’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’•’∂ variants-’∂’•÷Ä’∏÷Ç’¥\r\n      console.log('üîç [ADMIN SERVICE] ’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß, ’°÷Ä’§’µ’∏÷Ñ attribute values-’∂’•÷Ä’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’•’∂ variants-’∂’•÷Ä’∏÷Ç’¥...');\r\n      const attributeValues = await db.attributeValue.findMany({\r\n        where: { attributeId },\r\n        select: { id: true },\r\n      });\r\n\r\n      console.log('üìä [ADMIN SERVICE] Attribute values count:', attributeValues.length);\r\n\r\n      if (attributeValues.length > 0) {\r\n        const valueIds = attributeValues.map((v: { id: string }) => v.id);\r\n        console.log('üîç [ADMIN SERVICE] ’ç’ø’∏÷Ç’£’æ’∏÷Ç’¥ ’ß variant options...');\r\n        \r\n        let variantOptionsCount = 0;\r\n        try {\r\n          variantOptionsCount = await db.productVariantOption.count({\r\n            where: {\r\n              valueId: { in: valueIds },\r\n            },\r\n          });\r\n          console.log('üìä [ADMIN SERVICE] Variant options count:', variantOptionsCount);\r\n        } catch (countError: any) {\r\n          console.error('‚ùå [ADMIN SERVICE] Variant options count ’Ω’≠’°’¨:', {\r\n            error: countError,\r\n            message: countError?.message,\r\n            code: countError?.code,\r\n          });\r\n          // ‘µ’©’• count-’® ’π’´ ’°’∑’≠’°’ø’∏÷Ç’¥, ÷É’∏÷Ä’±’∏÷Ç’¥ ’•’∂÷Ñ findMany-’∏’æ\r\n          const variantOptions = await db.productVariantOption.findMany({\r\n            where: {\r\n              valueId: { in: valueIds },\r\n            },\r\n            select: { id: true },\r\n          });\r\n          variantOptionsCount = variantOptions.length;\r\n          console.log('üìä [ADMIN SERVICE] Variant options count (via findMany):', variantOptionsCount);\r\n        }\r\n\r\n        if (variantOptionsCount > 0) {\r\n          console.log('‚ö†Ô∏è [ADMIN SERVICE] Attribute values-’∂’•÷Ä’® ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’•’∂ variants-’∂’•÷Ä’∏÷Ç’¥:', variantOptionsCount);\r\n          throw {\r\n            status: 400,\r\n            type: \"https://api.shop.am/problems/validation-error\",\r\n            title: \"Cannot delete attribute\",\r\n            detail: `Some attribute values are used in ${variantOptionsCount} variant(s). Please remove them from variants first.`,\r\n          };\r\n        }\r\n      }\r\n\r\n      // ’Ä’•’º’°÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ attribute-’® (values-’∂’•÷Ä’® ’Ø’∞’•’º’°÷Å’æ’•’∂ cascade-’∏’æ)\r\n      console.log('üóëÔ∏è [ADMIN SERVICE] ’Ä’•’º’°÷Å’æ’∏÷Ç’¥ ’ß attribute-’®...');\r\n      await db.attribute.delete({\r\n        where: { id: attributeId },\r\n      });\r\n\r\n      console.log('‚úÖ [ADMIN SERVICE] Attribute-’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’∞’•’º’°÷Å’æ’•’¨ ’ß:', {\r\n        attributeId,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n      \r\n      return { success: true };\r\n    } catch (error: any) {\r\n      // ‘µ’©’• ’Ω’° ’¥’•÷Ä ’Ω’ø’•’≤’Æ’°’Æ ’Ω’≠’°’¨ ’ß, ’°’∫’° ’æ’•÷Ä’°’§’°÷Ä’±’∂’∏÷Ç’¥ ’•’∂÷Ñ ’°’µ’∂\r\n      if (error.status && error.type) {\r\n        console.error('‚ùå [ADMIN SERVICE] ’ç’ø’°’∂’§’°÷Ä’ø ’Ω’≠’°’¨:', {\r\n          status: error.status,\r\n          type: error.type,\r\n          title: error.title,\r\n          detail: error.detail,\r\n        });\r\n        throw error;\r\n      }\r\n\r\n      // ’Ñ’°’∂÷Ä’°’¥’°’Ω’∂ ’¨’∏’£’°’æ’∏÷Ä’∏÷Ç’¥\r\n      console.error('‚ùå [ADMIN SERVICE] Attribute ’∞’•’º’°÷Å’¥’°’∂ ’Ω’≠’°’¨:', {\r\n        attributeId,\r\n        error: {\r\n          name: error?.name,\r\n          message: error?.message,\r\n          code: error?.code,\r\n          meta: error?.meta,\r\n          stack: error?.stack?.substring(0, 1000),\r\n        },\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      // Prisma ’Ω’≠’°’¨’∂’•÷Ä’´ ’¥’∑’°’Ø’∏÷Ç’¥\r\n      if (error?.code === 'P2025') {\r\n        console.log('‚ö†Ô∏è [ADMIN SERVICE] Prisma P2025: ‘≥÷Ä’°’º’∏÷Ç’¥’® ’π’´ ’£’ø’∂’æ’•’¨');\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Attribute not found\",\r\n          detail: `Attribute with id '${attributeId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      // ‘≥’•’∂’•÷Ä’´’Ø ’Ω’≠’°’¨\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: error?.message || \"Failed to delete attribute\",\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete attribute value\r\n   */\r\n  async deleteAttributeValue(attributeValueId: string) {\r\n    try {\r\n      console.log('üóëÔ∏è [ADMIN SERVICE] Deleting attribute value:', attributeValueId);\r\n\r\n      // First check if attribute value exists\r\n      const attributeValue = await db.attributeValue.findUnique({\r\n        where: { id: attributeValueId },\r\n        select: {\r\n          id: true,\r\n          attributeId: true,\r\n        },\r\n      });\r\n\r\n      if (!attributeValue) {\r\n        throw {\r\n          status: 404,\r\n          type: \"https://api.shop.am/problems/not-found\",\r\n          title: \"Attribute value not found\",\r\n          detail: `Attribute value with id '${attributeValueId}' does not exist`,\r\n        };\r\n      }\r\n\r\n      // Check if value is used in any variants\r\n      const variantOptionsCount = await db.productVariantOption.count({\r\n        where: {\r\n          valueId: attributeValueId,\r\n        },\r\n      });\r\n\r\n      if (variantOptionsCount > 0) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Cannot delete attribute value\",\r\n          detail: `Attribute value is used in ${variantOptionsCount} variant(s). Please remove it from variants first.`,\r\n        };\r\n      }\r\n\r\n      // Delete attribute value\r\n      await db.attributeValue.delete({\r\n        where: { id: attributeValueId },\r\n      });\r\n\r\n      // Return updated attribute\r\n      const attribute = await db.attribute.findUnique({\r\n        where: { id: attributeValue.attributeId },\r\n        include: {\r\n          translations: {\r\n            where: { locale: \"en\" },\r\n            take: 1,\r\n          },\r\n          values: {\r\n            include: {\r\n              translations: {\r\n                where: { locale: \"en\" },\r\n                take: 1,\r\n              },\r\n            },\r\n            orderBy: { position: \"asc\" },\r\n          },\r\n        },\r\n      });\r\n\r\n      if (!attribute) {\r\n        throw {\r\n          status: 500,\r\n          type: \"https://api.shop.am/problems/internal-error\",\r\n          title: \"Internal Server Error\",\r\n          detail: \"Failed to retrieve updated attribute\",\r\n        };\r\n      }\r\n\r\n      const translation = attribute.translations[0];\r\n      const values = attribute.values || [];\r\n\r\n      return {\r\n        id: attribute.id,\r\n        key: attribute.key,\r\n        name: translation?.name || attribute.key,\r\n        type: attribute.type,\r\n        filterable: attribute.filterable,\r\n        values: values.map((val: any) => {\r\n          const valTranslation = val.translations?.[0];\r\n          return {\r\n            id: val.id,\r\n            value: val.value,\r\n            label: valTranslation?.label || val.value,\r\n          };\r\n        }),\r\n      };\r\n    } catch (error: any) {\r\n      console.error('‚ùå [ADMIN SERVICE] Error deleting attribute value:', error);\r\n      if (error.status) {\r\n        throw error;\r\n      }\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: error.message || \"Failed to delete attribute value\",\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get recent activity for dashboard\r\n   */\r\n  async getActivity(limit: number = 10) {\r\n    const activities: Array<{\r\n      type: string;\r\n      title: string;\r\n      description: string;\r\n      timestamp: string;\r\n    }> = [];\r\n\r\n    // Get recent orders\r\n    const recentOrders = await db.order.findMany({\r\n      take: limit,\r\n      orderBy: { createdAt: \"desc\" },\r\n      include: {\r\n        items: true,\r\n      },\r\n    });\r\n\r\n    recentOrders.forEach((order: { number: string; items: Array<unknown>; total: number; currency: string | null; createdAt: Date }) => {\r\n      activities.push({\r\n        type: \"order\",\r\n        title: `New Order #${order.number}`,\r\n        description: `${order.items.length} items ‚Ä¢ ${order.total} ${order.currency}`,\r\n        timestamp: order.createdAt.toISOString(),\r\n      });\r\n    });\r\n\r\n    // Get recent user registrations\r\n    const recentUsers = await db.user.findMany({\r\n      take: Math.floor(limit / 2),\r\n      orderBy: { createdAt: \"desc\" },\r\n      where: { deletedAt: null },\r\n      select: {\r\n        firstName: true,\r\n        lastName: true,\r\n        email: true,\r\n        phone: true,\r\n        createdAt: true,\r\n      },\r\n    });\r\n\r\n    recentUsers.forEach((user: { firstName: string | null; lastName: string | null; email: string | null; phone: string | null; createdAt: Date }) => {\r\n      const name = [user.firstName, user.lastName].filter(Boolean).join(\" \") || user.email || user.phone || \"New User\";\r\n      activities.push({\r\n        type: \"user\",\r\n        title: \"New User Registration\",\r\n        description: name,\r\n        timestamp: user.createdAt.toISOString(),\r\n      });\r\n    });\r\n\r\n    // Sort by timestamp (most recent first) and limit\r\n    return activities\r\n      .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\r\n      .slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Get analytics data\r\n   */\r\n  async getAnalytics(period: string = 'week', startDate?: string, endDate?: string) {\r\n    // Calculate date range based on period\r\n    let start: Date;\r\n    let end: Date = new Date();\r\n    end.setHours(23, 59, 59, 999);\r\n\r\n    switch (period) {\r\n      case 'day':\r\n        start = new Date();\r\n        start.setHours(0, 0, 0, 0);\r\n        break;\r\n      case 'week':\r\n        start = new Date();\r\n        start.setDate(start.getDate() - 7);\r\n        start.setHours(0, 0, 0, 0);\r\n        break;\r\n      case 'month':\r\n        start = new Date();\r\n        start.setDate(start.getDate() - 30);\r\n        start.setHours(0, 0, 0, 0);\r\n        break;\r\n      case 'year':\r\n        start = new Date();\r\n        start.setFullYear(start.getFullYear() - 1);\r\n        start.setHours(0, 0, 0, 0);\r\n        break;\r\n      case 'custom':\r\n        if (startDate && endDate) {\r\n          start = new Date(startDate);\r\n          start.setHours(0, 0, 0, 0);\r\n          end = new Date(endDate);\r\n          end.setHours(23, 59, 59, 999);\r\n        } else {\r\n          start = new Date();\r\n          start.setDate(start.getDate() - 7);\r\n          start.setHours(0, 0, 0, 0);\r\n        }\r\n        break;\r\n      default:\r\n        start = new Date();\r\n        start.setDate(start.getDate() - 7);\r\n        start.setHours(0, 0, 0, 0);\r\n    }\r\n\r\n    // Get orders in date range\r\n    const orders = await db.order.findMany({\r\n      where: {\r\n        createdAt: {\r\n          gte: start,\r\n          lte: end,\r\n        },\r\n      },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            variant: {\r\n              include: {\r\n                product: {\r\n                  include: {\r\n                    translations: {\r\n                      where: { locale: 'en' },\r\n                      take: 1,\r\n                    },\r\n                    categories: {\r\n                      include: {\r\n                        translations: {\r\n                          where: { locale: 'en' },\r\n                          take: 1,\r\n                        },\r\n                      },\r\n                    },\r\n                  },\r\n                },\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Calculate order statistics\r\n    const totalOrders = orders.length;\r\n    const paidOrders = orders.filter((o: { paymentStatus: string }) => o.paymentStatus === 'paid').length;\r\n    const pendingOrders = orders.filter((o: { status: string }) => o.status === 'pending').length;\r\n    const completedOrders = orders.filter((o: { status: string }) => o.status === 'completed').length;\r\n    const totalRevenue = orders\r\n      .filter((o: { paymentStatus: string }) => o.paymentStatus === 'paid')\r\n      .reduce((sum: number, o: { total: number }) => sum + o.total, 0);\r\n\r\n    // Calculate top products\r\n    const productMap = new Map<string, {\r\n      variantId: string;\r\n      productId: string;\r\n      title: string;\r\n      sku: string;\r\n      totalQuantity: number;\r\n      totalRevenue: number;\r\n      orderCount: number;\r\n      image?: string | null;\r\n    }>();\r\n\r\n    orders.forEach((order: { items: Array<{ variantId: string | null; variant?: { product?: { id: string; translations?: Array<{ title: string }>; media?: Array<{ url?: string }> } }; productTitle?: string; sku?: string; quantity: number; total: number }> }) => {\r\n      order.items.forEach((item: { variantId: string | null; variant?: { product?: { id: string; translations?: Array<{ title: string }>; media?: Array<{ url?: string }> } }; productTitle?: string; sku?: string; quantity: number; total: number }) => {\r\n        if (item.variantId) {\r\n          const key = item.variantId;\r\n          const existing = productMap.get(key) || {\r\n            variantId: item.variantId,\r\n            productId: item.variant?.product?.id || '',\r\n            title: item.productTitle || 'Unknown Product',\r\n            sku: item.sku || 'N/A',\r\n            totalQuantity: 0,\r\n            totalRevenue: 0,\r\n            orderCount: 0,\r\n            image: null,\r\n          };\r\n          existing.totalQuantity += item.quantity;\r\n          existing.totalRevenue += item.total;\r\n          existing.orderCount += 1;\r\n          productMap.set(key, existing);\r\n        }\r\n      });\r\n    });\r\n\r\n    const topProducts = Array.from(productMap.values())\r\n      .sort((a, b) => b.totalRevenue - a.totalRevenue)\r\n      .slice(0, 10);\r\n\r\n    // Calculate top categories\r\n    const categoryMap = new Map<string, {\r\n      categoryId: string;\r\n      categoryName: string;\r\n      totalQuantity: number;\r\n      totalRevenue: number;\r\n      orderCount: number;\r\n    }>();\r\n\r\n    orders.forEach((order: { items: Array<{ variant?: { product?: { categories: Array<{ id: string; translations?: Array<{ title: string }> }> } }; quantity: number; total: number }> }) => {\r\n      order.items.forEach((item: { variant?: { product?: { categories: Array<{ id: string; translations?: Array<{ title: string }> }> } }; quantity: number; total: number }) => {\r\n        if (item.variant?.product) {\r\n          item.variant.product.categories.forEach((category: { id: string; translations?: Array<{ title: string }> }) => {\r\n            const categoryId = category.id;\r\n            const translations = category.translations || [];\r\n            const categoryName = translations[0]?.title || category.id;\r\n            const existing = categoryMap.get(categoryId) || {\r\n              categoryId,\r\n              categoryName,\r\n              totalQuantity: 0,\r\n              totalRevenue: 0,\r\n              orderCount: 0,\r\n            };\r\n            existing.totalQuantity += item.quantity;\r\n            existing.totalRevenue += item.total;\r\n            existing.orderCount += 1;\r\n            categoryMap.set(categoryId, existing);\r\n          });\r\n        }\r\n      });\r\n    });\r\n\r\n    const topCategories = Array.from(categoryMap.values())\r\n      .sort((a, b) => b.totalRevenue - a.totalRevenue)\r\n      .slice(0, 10);\r\n\r\n    // Calculate orders by day\r\n    const ordersByDayMap = new Map<string, { count: number; revenue: number }>();\r\n\r\n    orders.forEach((order: { createdAt: Date; paymentStatus: string; total: number }) => {\r\n      const dateKey = order.createdAt.toISOString().split('T')[0];\r\n      const existing = ordersByDayMap.get(dateKey) || { count: 0, revenue: 0 };\r\n      existing.count += 1;\r\n      if (order.paymentStatus === 'paid') {\r\n        existing.revenue += order.total;\r\n      }\r\n      ordersByDayMap.set(dateKey, existing);\r\n    });\r\n\r\n    const ordersByDay = Array.from(ordersByDayMap.entries())\r\n      .map(([date, data]) => ({\r\n        _id: date,\r\n        count: data.count,\r\n        revenue: data.revenue,\r\n      }))\r\n      .sort((a, b) => a._id.localeCompare(b._id));\r\n\r\n    return {\r\n      period,\r\n      dateRange: {\r\n        start: start.toISOString(),\r\n        end: end.toISOString(),\r\n      },\r\n      orders: {\r\n        totalOrders,\r\n        totalRevenue,\r\n        paidOrders,\r\n        pendingOrders,\r\n        completedOrders,\r\n      },\r\n      topProducts,\r\n      topCategories,\r\n      ordersByDay,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get delivery settings\r\n   */\r\n  async getDeliverySettings() {\r\n    console.log('üöö [ADMIN SERVICE] getDeliverySettings called');\r\n    \r\n    const setting = await db.settings.findUnique({\r\n      where: { key: 'delivery-locations' },\r\n    });\r\n\r\n    if (!setting) {\r\n      console.log('‚úÖ [ADMIN SERVICE] Delivery settings not found, returning defaults');\r\n      return {\r\n        locations: [],\r\n      };\r\n    }\r\n\r\n    const value = setting.value as { locations?: Array<{ id?: string; country: string; city: string; price: number }> };\r\n    console.log('‚úÖ [ADMIN SERVICE] Delivery settings loaded:', value);\r\n    return {\r\n      locations: value.locations || [],\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get delivery price for a specific city\r\n   * Returns the configured price if city has shipping, otherwise returns 0\r\n   */\r\n  async getDeliveryPrice(city: string, country: string = 'Armenia') {\r\n    console.log('üöö [ADMIN SERVICE] getDeliveryPrice called:', { city, country });\r\n    \r\n    const setting = await db.settings.findUnique({\r\n      where: { key: 'delivery-locations' },\r\n    });\r\n\r\n    if (!setting) {\r\n      console.log('‚úÖ [ADMIN SERVICE] Delivery settings not found, returning 0 (no shipping for this city)');\r\n      return 0; // No shipping configured for this city\r\n    }\r\n\r\n    const value = setting.value as { locations?: Array<{ country: string; city: string; price: number }> };\r\n    const locations = value.locations || [];\r\n\r\n    // Find matching location (case-insensitive)\r\n    const location = locations.find(\r\n      (loc) => \r\n        loc.city.toLowerCase().trim() === city.toLowerCase().trim() &&\r\n        loc.country.toLowerCase().trim() === country.toLowerCase().trim()\r\n    );\r\n\r\n    if (location) {\r\n      console.log('‚úÖ [ADMIN SERVICE] Delivery price found:', location.price);\r\n      return location.price;\r\n    }\r\n\r\n    // If no exact match, try to find by city only (case-insensitive)\r\n    const cityMatch = locations.find(\r\n      (loc) => loc.city.toLowerCase().trim() === city.toLowerCase().trim()\r\n    );\r\n\r\n    if (cityMatch) {\r\n      console.log('‚úÖ [ADMIN SERVICE] Delivery price found by city:', cityMatch.price);\r\n      return cityMatch.price;\r\n    }\r\n\r\n    // Return 0 if no match found (city doesn't have shipping configured)\r\n    console.log('‚úÖ [ADMIN SERVICE] No delivery price found for city, returning 0');\r\n    return 0; // No shipping for this city\r\n  }\r\n\r\n  /**\r\n   * Update delivery settings\r\n   */\r\n  async updateDeliverySettings(data: { locations: Array<{ id?: string; country: string; city: string; price: number }> }) {\r\n    console.log('üöö [ADMIN SERVICE] updateDeliverySettings called:', data);\r\n    \r\n    // Validate locations\r\n    if (!Array.isArray(data.locations)) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation Error\",\r\n        detail: \"Locations must be an array\",\r\n      };\r\n    }\r\n\r\n    // Validate each location\r\n    for (const location of data.locations) {\r\n      if (!location.country || !location.city) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: \"Each location must have country and city\",\r\n        };\r\n      }\r\n      if (typeof location.price !== 'number' || location.price < 0) {\r\n        throw {\r\n          status: 400,\r\n          type: \"https://api.shop.am/problems/validation-error\",\r\n          title: \"Validation Error\",\r\n          detail: \"Price must be a non-negative number\",\r\n        };\r\n      }\r\n    }\r\n\r\n    // Generate IDs for new locations\r\n    const locationsWithIds = data.locations.map((location, index) => ({\r\n      ...location,\r\n      id: location.id || `location-${Date.now()}-${index}`,\r\n    }));\r\n\r\n    const setting = await db.settings.upsert({\r\n      where: { key: 'delivery-locations' },\r\n      update: {\r\n        value: { locations: locationsWithIds },\r\n        updatedAt: new Date(),\r\n      },\r\n      create: {\r\n        key: 'delivery-locations',\r\n        value: { locations: locationsWithIds },\r\n        description: 'Delivery prices by country and city',\r\n      },\r\n    });\r\n\r\n    console.log('‚úÖ [ADMIN SERVICE] Delivery settings updated:', setting);\r\n    return {\r\n      locations: locationsWithIds,\r\n    };\r\n  }\r\n}\r\n\r\nexport const adminService = new AdminService();\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5559, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/app/api/v1/admin/dashboard/top-products/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { authenticateToken, requireAdmin } from \"@/lib/middleware/auth\";\r\nimport { adminService } from \"@/lib/services/admin.service\";\r\n\r\n/**\r\n * GET /api/v1/admin/dashboard/top-products\r\n * Get top products for admin dashboard\r\n */\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    console.log(\"üìä [TOP-PRODUCTS] Request received\");\r\n    const user = await authenticateToken(req);\r\n    \r\n    if (!user || !requireAdmin(user)) {\r\n      console.log(\"‚ùå [TOP-PRODUCTS] Unauthorized or not admin\");\r\n      return NextResponse.json(\r\n        {\r\n          type: \"https://api.shop.am/problems/forbidden\",\r\n          title: \"Forbidden\",\r\n          status: 403,\r\n          detail: \"Admin access required\",\r\n          instance: req.url,\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Get limit from query params\r\n    const { searchParams } = new URL(req.url);\r\n    const limit = parseInt(searchParams.get(\"limit\") || \"5\", 10);\r\n\r\n    console.log(`‚úÖ [TOP-PRODUCTS] User authenticated: ${user.id}, limit: ${limit}`);\r\n    const result = await adminService.getTopProducts(limit);\r\n    console.log(\"‚úÖ [TOP-PRODUCTS] Top products retrieved successfully\");\r\n    \r\n    return NextResponse.json({ data: result });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå [TOP-PRODUCTS] Error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        type: error.type || \"https://api.shop.am/problems/internal-error\",\r\n        title: error.title || \"Internal Server Error\",\r\n        status: error.status || 500,\r\n        detail: error.detail || error.message || \"An error occurred\",\r\n        instance: req.url,\r\n      },\r\n      { status: error.status || 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAMO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,QAAQ,GAAG,CAAC;QACZ,MAAM,OAAO,MAAM,IAAA,+JAAiB,EAAC;QAErC,IAAI,CAAC,QAAQ,CAAC,IAAA,0JAAY,EAAC,OAAO;YAChC,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,MAAM;gBACN,OAAO;gBACP,QAAQ;gBACR,QAAQ;gBACR,UAAU,IAAI,GAAG;YACnB,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,8BAA8B;QAC9B,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY,KAAK;QAEzD,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,KAAK,EAAE,CAAC,SAAS,EAAE,OAAO;QAC9E,MAAM,SAAS,MAAM,oKAAY,CAAC,cAAc,CAAC;QACjD,QAAQ,GAAG,CAAC;QAEZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAO;IAC1C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,MAAM,MAAM,IAAI,IAAI;YACpB,OAAO,MAAM,KAAK,IAAI;YACtB,QAAQ,MAAM,MAAM,IAAI;YACxB,QAAQ,MAAM,MAAM,IAAI,MAAM,OAAO,IAAI;YACzC,UAAU,IAAI,GAAG;QACnB,GACA;YAAE,QAAQ,MAAM,MAAM,IAAI;QAAI;IAElC;AACF"}}]
}