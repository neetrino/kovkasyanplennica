{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/client.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as any;\n\n// Ensure UTF-8 encoding for PostgreSQL connection\n// This fixes encoding issues with Armenian and other UTF-8 characters\nconst databaseUrl = process.env.DATABASE_URL || '';\nlet urlWithEncoding = databaseUrl;\n\nif (!databaseUrl.includes('client_encoding')) {\n  urlWithEncoding = databaseUrl.includes('?') \n    ? `${databaseUrl}&client_encoding=UTF8`\n    : `${databaseUrl}?client_encoding=UTF8`;\n  \n  // Temporarily override DATABASE_URL for Prisma Client\n  process.env.DATABASE_URL = urlWithEncoding;\n}\n\nexport const db =\n  globalForPrisma.prisma ??\n  new PrismaClient({ \n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n    errorFormat: \"pretty\",\n  });\n\n// Prisma Client connects automatically on first query (lazy connection)\n// No need to call $connect() explicitly as it can cause issues in Next.js API routes\n// Connection will be established automatically when the first database query is made\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db;\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAExB,kDAAkD;AAClD,sEAAsE;AACtE,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY,IAAI;AAChD,IAAI,kBAAkB;AAEtB,IAAI,CAAC,YAAY,QAAQ,CAAC,oBAAoB;IAC5C,kBAAkB,YAAY,QAAQ,CAAC,OACnC,GAAG,YAAY,qBAAqB,CAAC,GACrC,GAAG,YAAY,qBAAqB,CAAC;IAEzC,sDAAsD;IACtD,QAAQ,GAAG,CAAC,YAAY,GAAG;AAC7B;AAEO,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;IAC3E,aAAa;AACf;AAEF,wEAAwE;AACxE,qFAAqF;AACrF,qFAAqF;AAErF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/packages/db/index.ts"],"sourcesContent":["export * from \"./client\";\r\n\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/lib/services/auth.service.ts"],"sourcesContent":["import * as bcrypt from \"bcryptjs\";\r\nimport * as jwt from \"jsonwebtoken\";\r\nimport { db } from \"@white-shop/db\";\r\n\r\nexport interface RegisterData {\r\n  email?: string;\r\n  phone?: string;\r\n  password: string;\r\n  firstName?: string;\r\n  lastName?: string;\r\n}\r\n\r\nexport interface LoginData {\r\n  email?: string;\r\n  phone?: string;\r\n  password: string;\r\n}\r\n\r\nexport interface AuthResponse {\r\n  user: {\r\n    id: string;\r\n    email: string | null;\r\n    phone: string | null;\r\n    firstName: string | null;\r\n    lastName: string | null;\r\n    roles: string[];\r\n  };\r\n  token: string;\r\n}\r\n\r\nclass AuthService {\r\n  /**\r\n   * Register new user\r\n   */\r\n  async register(data: RegisterData): Promise<AuthResponse> {\r\n    console.log(\"üîê [AUTH] Registration attempt:\", {\r\n      email: data.email || \"not provided\",\r\n      phone: data.phone || \"not provided\",\r\n      hasFirstName: !!data.firstName,\r\n      hasLastName: !!data.lastName,\r\n    });\r\n\r\n    if (!data.email && !data.phone) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation failed\",\r\n        detail: \"Either email or phone is required\",\r\n      };\r\n    }\r\n\r\n    if (!data.password || data.password.length < 6) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation failed\",\r\n        detail: \"Password must be at least 6 characters\",\r\n      };\r\n    }\r\n\r\n    // Check if user already exists\r\n    const existingUser = await db.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          ...(data.email ? [{ email: data.email }] : []),\r\n          ...(data.phone ? [{ phone: data.phone }] : []),\r\n        ],\r\n        deletedAt: null,\r\n      },\r\n      select: { id: true },\r\n    });\r\n\r\n    if (existingUser) {\r\n      console.log(\r\n        \"‚ùå [AUTH] User already exists:\",\r\n        existingUser.email || existingUser.phone\r\n      );\r\n      throw {\r\n        status: 409,\r\n        type: \"https://api.shop.am/problems/conflict\",\r\n        title: \"User already exists\",\r\n        detail: \"User with this email or phone already exists\",\r\n      };\r\n    }\r\n\r\n    // Hash password\r\n    console.log(\"üîí [AUTH] Hashing password...\");\r\n    const passwordHash = await bcrypt.hash(data.password, 10);\r\n    console.log(\"‚úÖ [AUTH] Password hashed successfully\");\r\n\r\n    // Create user\r\n    console.log(\"üíæ [AUTH] Creating user in database...\");\r\n    let user;\r\n    try {\r\n      user = await db.user.create({\r\n        data: {\r\n          email: data.email || null,\r\n          phone: data.phone || null,\r\n          passwordHash,\r\n          firstName: data.firstName || null,\r\n          lastName: data.lastName || null,\r\n          locale: \"en\",\r\n          roles: [\"customer\"],\r\n        },\r\n        select: {\r\n          id: true,\r\n          email: true,\r\n          phone: true,\r\n          firstName: true,\r\n          lastName: true,\r\n          roles: true,\r\n        },\r\n      });\r\n      console.log(\"‚úÖ [AUTH] User created successfully\");\r\n    } catch (error: any) {\r\n      console.error(\"‚ùå [AUTH] User creation failed:\", error);\r\n      if (error.code === \"P2002\") {\r\n        // Prisma unique constraint error\r\n        throw {\r\n          status: 409,\r\n          type: \"https://api.shop.am/problems/conflict\",\r\n          title: \"User already exists\",\r\n          detail: \"User with this email or phone already exists\",\r\n        };\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    // Generate JWT token\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error(\"‚ùå [AUTH] JWT_SECRET is not set!\");\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: \"Server configuration error\",\r\n      };\r\n    }\r\n\r\n    console.log(\"üé´ [AUTH] Generating JWT token...\");\r\n    const token = jwt.sign(\r\n      { userId: user.id },\r\n      process.env.JWT_SECRET as string,\r\n      { expiresIn: process.env.JWT_EXPIRES_IN || \"7d\" } as jwt.SignOptions\r\n    );\r\n    console.log(\"‚úÖ [AUTH] JWT token generated\");\r\n\r\n    return {\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        phone: user.phone,\r\n        firstName: user.firstName,\r\n        lastName: user.lastName,\r\n        roles: user.roles,\r\n      },\r\n      token,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Login user\r\n   */\r\n  async login(data: LoginData): Promise<AuthResponse> {\r\n    console.log(\"üîê [AUTH] Login attempt:\", {\r\n      email: data.email || \"not provided\",\r\n      phone: data.phone || \"not provided\",\r\n    });\r\n\r\n    if (!data.email && !data.phone) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation failed\",\r\n        detail: \"Either email or phone is required\",\r\n      };\r\n    }\r\n\r\n    if (!data.password) {\r\n      throw {\r\n        status: 400,\r\n        type: \"https://api.shop.am/problems/validation-error\",\r\n        title: \"Validation failed\",\r\n        detail: \"Password is required\",\r\n      };\r\n    }\r\n\r\n    // Find user\r\n    console.log(\"üîç [AUTH] Searching for user in database...\");\r\n    const user = await db.user.findFirst({\r\n      where: {\r\n        OR: [\r\n          ...(data.email ? [{ email: data.email }] : []),\r\n          ...(data.phone ? [{ phone: data.phone }] : []),\r\n        ],\r\n        deletedAt: null,\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        phone: true,\r\n        firstName: true,\r\n        lastName: true,\r\n        passwordHash: true,\r\n        roles: true,\r\n        blocked: true,\r\n      },\r\n    });\r\n\r\n    if (!user || !user.passwordHash) {\r\n      console.log(\"‚ùå [AUTH] User not found or no password set\");\r\n      throw {\r\n        status: 401,\r\n        type: \"https://api.shop.am/problems/unauthorized\",\r\n        title: \"Invalid credentials\",\r\n        detail: \"Invalid email/phone or password\",\r\n      };\r\n    }\r\n\r\n    console.log(\"‚úÖ [AUTH] User found:\", user.id);\r\n\r\n    // Check password\r\n    console.log(\"üîí [AUTH] Verifying password...\");\r\n    const isValidPassword = await bcrypt.compare(\r\n      data.password,\r\n      user.passwordHash\r\n    );\r\n\r\n    if (!isValidPassword) {\r\n      console.log(\"‚ùå [AUTH] Invalid password\");\r\n      throw {\r\n        status: 401,\r\n        type: \"https://api.shop.am/problems/unauthorized\",\r\n        title: \"Invalid credentials\",\r\n        detail: \"Invalid email/phone or password\",\r\n      };\r\n    }\r\n\r\n    if (user.blocked) {\r\n      console.log(\"‚ùå [AUTH] Account is blocked\");\r\n      throw {\r\n        status: 403,\r\n        type: \"https://api.shop.am/problems/forbidden\",\r\n        title: \"Account blocked\",\r\n        detail: \"Your account has been blocked\",\r\n      };\r\n    }\r\n\r\n    // Generate JWT token\r\n    if (!process.env.JWT_SECRET) {\r\n      throw {\r\n        status: 500,\r\n        type: \"https://api.shop.am/problems/internal-error\",\r\n        title: \"Internal Server Error\",\r\n        detail: \"Server configuration error\",\r\n      };\r\n    }\r\n\r\n    const token = jwt.sign(\r\n      { userId: user.id },\r\n      process.env.JWT_SECRET as string,\r\n      { expiresIn: process.env.JWT_EXPIRES_IN || \"7d\" } as jwt.SignOptions\r\n    );\r\n\r\n    console.log(\"‚úÖ [AUTH] Login successful, token generated\");\r\n\r\n    return {\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        phone: user.phone,\r\n        firstName: user.firstName,\r\n        lastName: user.lastName,\r\n        roles: user.roles,\r\n      },\r\n      token,\r\n    };\r\n  }\r\n}\r\n\r\nexport const authService = new AuthService();\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAAA;;;;AA4BA,MAAM;IACJ;;GAEC,GACD,MAAM,SAAS,IAAkB,EAAyB;QACxD,QAAQ,GAAG,CAAC,mCAAmC;YAC7C,OAAO,KAAK,KAAK,IAAI;YACrB,OAAO,KAAK,KAAK,IAAI;YACrB,cAAc,CAAC,CAAC,KAAK,SAAS;YAC9B,aAAa,CAAC,CAAC,KAAK,QAAQ;QAC9B;QAEA,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,KAAK,EAAE;YAC9B,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,IAAI,CAAC,KAAK,QAAQ,IAAI,KAAK,QAAQ,CAAC,MAAM,GAAG,GAAG;YAC9C,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,+BAA+B;QAC/B,MAAM,eAAe,MAAM,gIAAE,CAAC,IAAI,CAAC,SAAS,CAAC;YAC3C,OAAO;gBACL,IAAI;uBACE,KAAK,KAAK,GAAG;wBAAC;4BAAE,OAAO,KAAK,KAAK;wBAAC;qBAAE,GAAG,EAAE;uBACzC,KAAK,KAAK,GAAG;wBAAC;4BAAE,OAAO,KAAK,KAAK;wBAAC;qBAAE,GAAG,EAAE;iBAC9C;gBACD,WAAW;YACb;YACA,QAAQ;gBAAE,IAAI;YAAK;QACrB;QAEA,IAAI,cAAc;YAChB,QAAQ,GAAG,CACT,iCACA,aAAa,KAAK,IAAI,aAAa,KAAK;YAE1C,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,gBAAgB;QAChB,QAAQ,GAAG,CAAC;QACZ,MAAM,eAAe,MAAM,2IAAW,CAAC,KAAK,QAAQ,EAAE;QACtD,QAAQ,GAAG,CAAC;QAEZ,cAAc;QACd,QAAQ,GAAG,CAAC;QACZ,IAAI;QACJ,IAAI;YACF,OAAO,MAAM,gIAAE,CAAC,IAAI,CAAC,MAAM,CAAC;gBAC1B,MAAM;oBACJ,OAAO,KAAK,KAAK,IAAI;oBACrB,OAAO,KAAK,KAAK,IAAI;oBACrB;oBACA,WAAW,KAAK,SAAS,IAAI;oBAC7B,UAAU,KAAK,QAAQ,IAAI;oBAC3B,QAAQ;oBACR,OAAO;wBAAC;qBAAW;gBACrB;gBACA,QAAQ;oBACN,IAAI;oBACJ,OAAO;oBACP,OAAO;oBACP,WAAW;oBACX,UAAU;oBACV,OAAO;gBACT;YACF;YACA,QAAQ,GAAG,CAAC;QACd,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,kCAAkC;YAChD,IAAI,MAAM,IAAI,KAAK,SAAS;gBAC1B,iCAAiC;gBACjC,MAAM;oBACJ,QAAQ;oBACR,MAAM;oBACN,OAAO;oBACP,QAAQ;gBACV;YACF;YACA,MAAM;QACR;QAEA,qBAAqB;QACrB,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;YACd,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,QAAQ,GAAG,CAAC;QACZ,MAAM,QAAQ,+IAAQ,CACpB;YAAE,QAAQ,KAAK,EAAE;QAAC,GAClB,QAAQ,GAAG,CAAC,UAAU,EACtB;YAAE,WAAW,QAAQ,GAAG,CAAC,cAAc,IAAI;QAAK;QAElD,QAAQ,GAAG,CAAC;QAEZ,OAAO;YACL,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,OAAO,KAAK,KAAK;gBACjB,WAAW,KAAK,SAAS;gBACzB,UAAU,KAAK,QAAQ;gBACvB,OAAO,KAAK,KAAK;YACnB;YACA;QACF;IACF;IAEA;;GAEC,GACD,MAAM,MAAM,IAAe,EAAyB;QAClD,QAAQ,GAAG,CAAC,4BAA4B;YACtC,OAAO,KAAK,KAAK,IAAI;YACrB,OAAO,KAAK,KAAK,IAAI;QACvB;QAEA,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,KAAK,EAAE;YAC9B,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,IAAI,CAAC,KAAK,QAAQ,EAAE;YAClB,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,YAAY;QACZ,QAAQ,GAAG,CAAC;QACZ,MAAM,OAAO,MAAM,gIAAE,CAAC,IAAI,CAAC,SAAS,CAAC;YACnC,OAAO;gBACL,IAAI;uBACE,KAAK,KAAK,GAAG;wBAAC;4BAAE,OAAO,KAAK,KAAK;wBAAC;qBAAE,GAAG,EAAE;uBACzC,KAAK,KAAK,GAAG;wBAAC;4BAAE,OAAO,KAAK,KAAK;wBAAC;qBAAE,GAAG,EAAE;iBAC9C;gBACD,WAAW;YACb;YACA,QAAQ;gBACN,IAAI;gBACJ,OAAO;gBACP,OAAO;gBACP,WAAW;gBACX,UAAU;gBACV,cAAc;gBACd,OAAO;gBACP,SAAS;YACX;QACF;QAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,YAAY,EAAE;YAC/B,QAAQ,GAAG,CAAC;YACZ,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,QAAQ,GAAG,CAAC,wBAAwB,KAAK,EAAE;QAE3C,iBAAiB;QACjB,QAAQ,GAAG,CAAC;QACZ,MAAM,kBAAkB,MAAM,8IAAc,CAC1C,KAAK,QAAQ,EACb,KAAK,YAAY;QAGnB,IAAI,CAAC,iBAAiB;YACpB,QAAQ,GAAG,CAAC;YACZ,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,IAAI,KAAK,OAAO,EAAE;YAChB,QAAQ,GAAG,CAAC;YACZ,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,qBAAqB;QACrB,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,MAAM;gBACJ,QAAQ;gBACR,MAAM;gBACN,OAAO;gBACP,QAAQ;YACV;QACF;QAEA,MAAM,QAAQ,+IAAQ,CACpB;YAAE,QAAQ,KAAK,EAAE;QAAC,GAClB,QAAQ,GAAG,CAAC,UAAU,EACtB;YAAE,WAAW,QAAQ,GAAG,CAAC,cAAc,IAAI;QAAK;QAGlD,QAAQ,GAAG,CAAC;QAEZ,OAAO;YACL,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,OAAO,KAAK,KAAK;gBACjB,WAAW,KAAK,SAAS;gBACzB,UAAU,KAAK,QAAQ;gBACvB,OAAO,KAAK,KAAK;YACnB;YACA;QACF;IACF;AACF;AAEO,MAAM,cAAc,IAAI"}},
    {"offset": {"line": 370, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/white%20shop/White-Shop-templete/WhiteShop-Template/apps/web/app/api/v1/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { authService } from \"@/lib/services/auth.service\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const data = await req.json();\r\n    const result = await authService.login(data);\r\n    return NextResponse.json(result);\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå [AUTH] Login error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        type: error.type || \"https://api.shop.am/problems/internal-error\",\r\n        title: error.title || \"Internal Server Error\",\r\n        status: error.status || 500,\r\n        detail: error.detail || error.message || \"An error occurred\",\r\n        instance: req.url,\r\n      },\r\n      { status: error.status || 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,SAAS,MAAM,kKAAW,CAAC,KAAK,CAAC;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,MAAM,MAAM,IAAI,IAAI;YACpB,OAAO,MAAM,KAAK,IAAI;YACtB,QAAQ,MAAM,MAAM,IAAI;YACxB,QAAQ,MAAM,MAAM,IAAI,MAAM,OAAO,IAAI;YACzC,UAAU,IAAI,GAAG;QACnB,GACA;YAAE,QAAQ,MAAM,MAAM,IAAI;QAAI;IAElC;AACF"}}]
}