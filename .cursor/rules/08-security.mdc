---
description: Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ¯Õ¡Õ¶Õ¸Õ¶Õ¶Õ¥Ö€Ö‰ Õ”ÕÔ»ÕÔ»Ô¿Ô±Ô¿Ô±Õ†Ö‰ Ô¿Õ«Ö€Õ¡Õ¼Õ¾Õ¸Ö‚Õ´ Õ§ Õ¡Õ´Õ¢Õ¸Õ²Õ» Õ¯Õ¸Õ¤Õ«Õ¶Ö‰
globs: ["**/*.ts", "**/*.tsx", "**/*.env*", "**/api/**", "**/auth/**", "**/middleware*"]
alwaysApply: false
---

# Ô±Õ†ÕÕÔ±Õ†Ô³ÕˆÕ’Ô¹Õ…Ô±Õ† Ô¿Ô±Õ†ÕˆÕ†Õ†ÔµÕ

> Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¨ Õ¨Õ¶Õ¿Ö€Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶ Õ¹Õ§, Õ¡ÕµÕ¬ ÕºÕ¡Õ°Õ¡Õ¶Õ»Ö‰ Ô±ÕµÕ½ Õ¯Õ¡Õ¶Õ¸Õ¶Õ¶Õ¥Ö€Õ¨ ÕŠÔ±ÕÕÔ±Ô´Ô»Õ Õ¥Õ¶Ö‰

---

## ğŸš¨ Õ”ÕÔ»ÕÔ»Ô¿Ô±Ô¿Ô±Õ† Ô¿Ô±Õ†ÕˆÕ†Õ†ÔµÕ

### ÔµÕÔµÕ”ÔµÔ¼ÔµÕ Õ´Õ«Õ› Õ¡Ö€Õ¡

```typescript
// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ â€” Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€ Õ¯Õ¸Õ¤Õ¸Ö‚Õ´
const API_KEY = 'sk_live_abc123';
const DB_PASSWORD = 'mypassword';

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ â€” SQL Õ«Õ¶ÕªÕ¥Õ¯ÖÕ«Õ¡Õ¶Õ¥Ö€
const query = `SELECT * FROM users WHERE id = ${userId}`;
await db.$queryRawUnsafe(query);

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ â€” eval Ö‡ Õ¶Õ´Õ¡Õ¶Õ¶Õ¥Ö€
eval(userInput);
new Function(userInput)();

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ â€” Õ¡Õ¶Õ¾Õ¿Õ¡Õ¶Õ£Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ¡Õ¶Õ»Õ¡Õ¿Õ¸Ö‚Õ´
app.use(cors({ origin: '*' })); // Õ„Õ«Õ¡ÕµÕ¶ dev-Õ« Õ°Õ¡Õ´Õ¡Ö€
// CSRF-Õ¶ Õ¡Õ¶Õ»Õ¡Õ¿Õ¾Õ¡Õ® Õ§

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ â€” Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€Õ« Õ¬Õ¸Õ£Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´
console.log('Password:', password);
logger.info({ token: accessToken });
```

---

## ğŸ” Õ†ÕÔ»ÕÔ±Ô³ÕÕˆÕ’Õ„ (AUTHENTICATION)

> **Auth decision.** Ô»Õ¶Ö„Õ¶Õ¸Ö‚Õ©ÕµÕ¡Õ¶ Õ°Õ¡Õ½Õ¿Õ¡Õ¿Õ´Õ¡Õ¶ Õ¼Õ¡Õ¦Õ´Õ¡Õ¾Õ¡Ö€Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¨ Õ¨Õ¶Õ¿Ö€Õ¾Õ¸Ö‚Õ´ Õ§ `docs/TECH_CARD.md`-Õ¸Ö‚Õ´ (Õ¢Õ¡ÕªÕ«Õ¶ 5)Ö‰ **Õ„Õ« Õ«Ö€Õ¡Õ¯Õ¡Õ¶Õ¡ÖÕ¶Õ«Õ›Ö€ JWT Õ±Õ¥Õ¼Ö„Õ¸Õ¾**, Õ¥Õ©Õ¥ TECH_CARD-Õ¸Ö‚Õ´ Õ¢Õ¡ÖÕ¡Õ°Õ¡ÕµÕ¿ Õ¶Õ·Õ¾Õ¡Õ® Õ¹Õ§ JWTÖ‰ Default-Õ¨ Auth.js 5.x / cookie-based sessions â€” Ö…Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ«Õ›Ö€ Auth.js, Õ¥Õ©Õ¥ TECH_CARD-Õ¸Ö‚Õ´ Õ¡ÕµÕ¤ÕºÕ¥Õ½ Õ§ Õ¶Õ·Õ¾Õ¡Õ®Ö‰

### Ô³Õ¡Õ²Õ¿Õ¶Õ¡Õ¢Õ¡Õ¼Õ¥Ö€

```typescript
// âœ… Ô³Õ¡Õ²Õ¿Õ¶Õ¡Õ¢Õ¡Õ¼Õ¥Ö€Õ« Õ°Õ¥Õ·Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´
import { hash, verify, argon2id } from 'argon2';

// Õ€Õ¥Õ·Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´ Õ£Ö€Õ¡Õ¶ÖÕ´Õ¡Õ¶ ÕªÕ¡Õ´Õ¡Õ¶Õ¡Õ¯
const passwordHash = await hash(password, {
  type: argon2id,
  memoryCost: 65536,  // 64 MB
  timeCost: 3,
  parallelism: 4,
});

// ÕÕ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´ Õ´Õ¸Ö‚Õ¿Ö„Õ« ÕªÕ¡Õ´Õ¡Õ¶Õ¡Õ¯
const isValid = await verify(user.passwordHash, password);

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ
const passwordHash = md5(password);     // Ô¹Õ¸Ö‚ÕµÕ¬ Õ¡Õ¬Õ£Õ¸Ö€Õ«Õ©Õ´
const passwordHash = sha256(password);  // Ô±Õ¼Õ¡Õ¶Ö salt
```

### JWT Ô¹Õ¸Ö„Õ¥Õ¶Õ¶Õ¥Ö€

```typescript
// âœ… JWT-Õ« Õ³Õ«Õ·Õ¿ Õ¯Õ¡Ö€Õ£Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´ (HS256 + symmetric secret)
import jwt from 'jsonwebtoken';

const accessToken = jwt.sign(
  { userId: user.id, role: user.role },
  process.env.JWT_SECRET!,
  { 
    expiresIn: '15m',           // Ô¿Õ¡Ö€Õ³ ÕªÕ¡Õ´Õ¯Õ¥Õ¿
    algorithm: 'HS256',         // ÕÕ«Õ´Õ¥Õ¿Ö€Õ«Õ¯ Õ¡Õ¬Õ£Õ¸Ö€Õ«Õ©Õ´ (secret string)
    issuer: 'api.example.com',
    audience: 'example.com',
  }
);

// Refresh token â€” Õ¥Ö€Õ¯Õ¡Ö€ ÕªÕ¡Õ´Õ¯Õ¥Õ¿, ÕºÕ¡Õ°Õ¥Õ¬ Ô²Ô´-Õ¸Ö‚Õ´
const refreshToken = jwt.sign(
  { userId: user.id, tokenId: uuid() },
  process.env.JWT_REFRESH_SECRET!,
  { expiresIn: '7d' }
);

// ÔµÕ©Õ¥ RS256 (Õ¡Õ½Õ«Õ´Õ¥Õ¿Ö€Õ«Õ¯) Õ§ ÕºÕ¥Õ¿Ö„ â€” Ö…Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ«Õ›Ö€ key pair
// const accessToken = jwt.sign(payload, privateKey, { algorithm: 'RS256' });

// âŒ ÕÔ½Ô±Ô¼
const token = jwt.sign(payload, 'secret'); // Ô¹Õ¸Ö‚ÕµÕ¬ Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„
jwt.sign(payload, secret, { expiresIn: '30d' }); // Õ‰Õ¡ÖƒÕ«Ö Õ¥Ö€Õ¯Õ¡Ö€ access-Õ« Õ°Õ¡Õ´Õ¡Ö€
```

### ÕÕ¥Õ½Õ«Õ¡Õ¶Õ¥Ö€

```typescript
// âœ… Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£ cookie-Õ¶Õ¥Ö€ Õ½Õ¥Õ½Õ«Õ¡Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€
res.cookie('sessionId', sessionId, {
  httpOnly: true,     // JS-Õ«Ö Õ°Õ¡Õ½Õ¡Õ¶Õ¥Õ¬Õ« Õ¹Õ§
  secure: true,      // Õ„Õ«Õ¡ÕµÕ¶ HTTPS
  sameSite: 'strict', // CSRF-Õ«Ö ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 Ö…Ö€
  path: '/',
  domain: '.example.com',
});
```

---

## ğŸ›¡ï¸ ÕŠÔ±Õ‡ÕÕŠÔ±Õ†ÕˆÕ’Ô¹Õ…ÕˆÕ’Õ† Õ€Ô±Õ„Ô±ÕÔ¿Ô»Õ‘

### XSS (Cross-Site Scripting)

```typescript
// âœ… ÔµÕ¬Ö„Õ« Õ§Õ¯Ö€Õ¡Õ¶Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´
import { escape } from 'html-escaper';

const safeHtml = escape(userInput);

// âœ… Content Security Policy
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.example.com"],
    },
  },
}));

// âœ… React-Õ¨ Õ¡Õ¾Õ¿Õ¸Õ´Õ¡Õ¿ Õ§Õ¯Ö€Õ¡Õ¶Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´ Õ§
return <div>{userInput}</div>; // Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£

// âŒ ÕÕÔ±Õ†Ô³Ô±ÕÕˆÕ â€” dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userInput }} />
```

### CSRF (Cross-Site Request Forgery)

```typescript
// âœ… Next.js â€” Server Actions-Õ¨ Õ¸Ö‚Õ¶Õ¥Õ¶ Õ¶Õ¥Ö€Õ¯Õ¡Õ¼Õ¸Ö‚ÖÕ¾Õ¡Õ® CSRF-ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶
// (origin-Õ¨ Õ½Õ¿Õ¸Ö‚Õ£Õ¾Õ¸Ö‚Õ´ Õ§ Õ¡Õ¾Õ¿Õ¸Õ´Õ¡Õ¿, SameSite cookies)
// Ô¼Ö€Õ¡ÖÕ¸Ö‚ÖÕ«Õ¹ â€” SameSite cookies Õ½Õ¥Õ½Õ«Õ¡Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€
cookies().set('session', value, { sameSite: 'strict', httpOnly: true, secure: true });

// âœ… NestJS â€” Õ½Õ¥ÖƒÕ¡Õ¯Õ¡Õ¶ CSRF guard
// ÕÕ¡Ö€Õ¢Õ¥Ö€Õ¡Õ¯ 1. Double Submit Cookie
@Injectable()
export class CsrfGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const req = context.switchToHttp().getRequest();
    const cookieToken = req.cookies['csrf-token'];
    const headerToken = req.headers['x-csrf-token'];
    if (!cookieToken || cookieToken !== headerToken) {
      throw new ForbiddenException('Invalid CSRF token');
    }
    return true;
  }
}

// âœ… SameSite cookies (Õ¥Ö€Õ¯Õ¸Ö‚ stack-Õ« Õ°Õ¡Õ´Õ¡Ö€)
res.cookie('session', value, { sameSite: 'strict' });
```

> âš ï¸ `csurf` ÖƒÕ¡Õ©Õ¥Õ©Õ¨ deprecated Õ§ (Õ¡Ö€Õ­Õ«Õ¾Õ¡ÖÕ¾Õ¡Õ® 2022-Õ«Ö)Ö‰ Õ‰Ö…Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ¥Õ¬Ö‰

### SQL Injection

```typescript
// âœ… Prisma-Õ¶ Õ¡Õ¾Õ¿Õ¸Õ´Õ¡Õ¿ ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ´ Õ§
const user = await prisma.user.findFirst({
  where: { email: userInput }, // Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£
});

// âœ… ÕŠÕ¡Ö€Õ¡Õ´Õ¥Õ¿Ö€Õ¡ÖÕ¾Õ¡Õ® Õ°Õ¡Ö€ÖÕ¸Ö‚Õ´Õ¶Õ¥Ö€
const result = await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${userInput}
`; // Ô±Õ¶Õ¾Õ¿Õ¡Õ¶Õ£ â€” Prisma-Õ¶ Õ§Õ¯Ö€Õ¡Õ¶Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´ Õ§

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ
await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE email = '${userInput}'`
);
```

### NoSQL Injection

```typescript
// âœ… ÕÕ«ÕºÕ¥Ö€Õ« Õ¾Õ¡Õ¬Õ«Õ¤Õ¡ÖÕ«Õ¡
const userId = z.string().uuid().parse(userInput);

// âŒ ÕÕÔ±Õ†Ô³Ô±ÕÕˆÕ â€” Õ¡Õ¼Õ¡Õ¶Ö Õ¾Õ¡Õ¬Õ«Õ¤Õ¡ÖÕ«Õ¡ÕµÕ«
const user = await db.findOne({ 
  _id: userInput // Ô¿Õ¡Ö€Õ¸Õ² Õ§ Õ¬Õ«Õ¶Õ¥Õ¬ { $ne: null }
});
```

---

## ğŸ”’ Ô±ÕÔ¹ÕˆÕÔ»Ô¶Ô±Õ‘Ô»Ô± (AUTHORIZATION)

### RBAC (Role-Based Access Control)

```typescript
// âœ… Ô´Õ¥Ö€Õ¥Ö€Õ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin', 'manager')
@Delete(':id')
async delete(@Param('id') id: string) {
  return this.service.delete(id);
}

// âœ… ÕŒÕ¥Õ½Õ¸Ö‚Ö€Õ½Õ« Õ½Õ¥ÖƒÕ¡Õ¯Õ¡Õ¶Õ¡Õ¿Õ«Ö€Õ¸Õ» Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
async updateOrder(orderId: string, userId: string, data: UpdateOrderDto) {
  const order = await this.prisma.order.findUnique({
    where: { id: orderId },
  });
  
  if (!order) {
    throw new NotFoundException();
  }
  
  // ÕÕ¥ÖƒÕ¡Õ¯Õ¡Õ¶Õ¡Õ¿Õ«Ö€Õ¸Õ» Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
  if (order.userId !== userId) {
    throw new ForbiddenException('You can only edit your own orders');
  }
  
  return this.prisma.order.update({
    where: { id: orderId },
    data,
  });
}
```

### Õ†Õ¾Õ¡Õ¦Õ¡Õ£Õ¸Ö‚ÕµÕ¶ Õ¡Ö€Õ¿Õ¸Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¶Õ¥Ö€Õ« Õ½Õ¯Õ¦Õ¢Õ¸Ö‚Õ¶Ö„

```typescript
// âœ… ÕÕ¥Ö€Õ¡Õ¤Õ¡Ö€Õ±Ö€Õ¸Ö‚Õ› Õ´Õ«Õ¡ÕµÕ¶ Õ¡Õ¶Õ°Ö€Õ¡ÕªÕ¥Õ·Õ¿ Õ¤Õ¡Õ·Õ¿Õ¥Ö€Õ¨
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    name: true,
    email: true,
    // Õ‰Õ¾Õ¥Ö€Õ¡Õ¤Õ¡Ö€Õ±Õ¶Õ¥Õ¬. passwordHash, role, internalNotes
  },
});

// âœ… ÕÕ¡Ö€Õ¢Õ¥Ö€ DTO Õ¿Õ¡Ö€Õ¢Õ¥Ö€ Õ´Õ¸Ö‚Õ¿Ö„Õ« Õ´Õ¡Õ¯Õ¡Ö€Õ¤Õ¡Õ¯Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€
export class UserPublicDto {
  id: string;
  name: string;
}

export class UserPrivateDto extends UserPublicDto {
  email: string;
  phone: string;
}

export class UserAdminDto extends UserPrivateDto {
  role: string;
  createdAt: Date;
  lastLoginAt: Date;
}
```

---

## ğŸ”‘ Ô³Ô±Õ‚ÕÕ†Ô»Õ”Õ†ÔµÕ

### Ô³Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€Õ« ÕºÕ¡Õ°ÕºÕ¡Õ¶Õ¸Ö‚Õ´

```bash
# âœ… Environment variables
DATABASE_URL=postgresql://...
JWT_SECRET=very-long-random-string
API_KEY=sk_live_...

# .env Ö†Õ¡ÕµÕ¬Õ¨ .gitignore-Õ¸Ö‚Õ´
# âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ .env commit Õ¹Õ¡Õ¶Õ¥Õ¬

# âœ… Production â€” Ö…Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ«Õ›Ö€ secrets manager
# - AWS Secrets Manager
# - HashiCorp Vault
# - Kubernetes Secrets
```

### Ô³Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€Õ« Õ£Õ¥Õ¶Õ¥Ö€Õ¡ÖÕ«Õ¡

```bash
# âœ… Ô¿Ö€Õ«ÕºÕ¿Õ¸Õ£Ö€Õ¡Ö†Õ«Õ¡Õ¯Õ¡Õ¶ Õ¡Õ´Õ¸Ö‚Ö€ Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€
openssl rand -base64 32  # JWT_SECRET-Õ« Õ°Õ¡Õ´Õ¡Ö€
openssl rand -hex 32     # API Õ¢Õ¡Õ¶Õ¡Õ¬Õ«Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€

# âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ
JWT_SECRET=secret
JWT_SECRET=12345
```

### env ÖƒÕ¸ÖƒÕ¸Õ­Õ¡Õ¯Õ¡Õ¶Õ¶Õ¥Ö€Õ« Õ¾Õ¡Õ¬Õ«Õ¤Õ¡ÖÕ«Õ¡

```typescript
// âœ… ÕÕ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´ Õ´Õ¥Õ¯Õ¶Õ¡Ö€Õ¯Õ« ÕªÕ¡Õ´Õ¡Õ¶Õ¡Õ¯
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  JWT_SECRET: z.string().min(32),
  NODE_ENV: z.enum(['development', 'production', 'test']),
});

const env = envSchema.parse(process.env);

export default env;
```

---

## ğŸ“ Õ„ÕˆÕ’ÕÕ”Ô±Õ…Ô»Õ† ÕÕÕ…Ô±Ô¼Õ†ÔµÕÔ» ÕÔ±Ô¼Ô»Ô´Ô±Õ‘Ô»Ô±

### Ô¸Õ¶Õ¤Õ°Õ¡Õ¶Õ¸Ö‚Ö€ Õ¯Õ¡Õ¶Õ¸Õ¶Õ¶Õ¥Ö€

```typescript
// âœ… ÕÕ¡Õ¬Õ«Õ¤Õ¡ÖÖ€Õ¸Ö‚Õ› Ô±Õ„Ô²ÕˆÕ‚Õ‹ Õ´Õ¸Ö‚Õ¿Ö„Õ¨
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string().email().max(255),
  password: z.string().min(8).max(100),
  name: z.string().min(1).max(100).optional(),
});

// âœ… ÕÕ¡Õ¶Õ«Õ¿Õ«Õ¦Õ¡ÖÕ«Õ¡
const sanitizedInput = input
  .trim()
  .replace(/[<>]/g, ''); // HTML Õ©Õ¥Õ£Õ¥Ö€Õ« Õ°Õ¥Õ¼Õ¡ÖÕ¸Ö‚Õ´

// âœ… Õ‰Õ¡ÖƒÕ« Õ½Õ¡Õ°Õ´Õ¡Õ¶Õ¡ÖƒÕ¡Õ¯Õ¸Ö‚Õ´Õ¶Õ¥Ö€
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ limit: '1mb', extended: true }));
```

### Õ–Õ¡ÕµÕ¬Õ¥Ö€Õ« Õ¢Õ¥Õ¼Õ¶Õ¸Ö‚Õ´

```typescript
// âœ… ÕÕ«ÕºÕ« Ö‡ Õ¹Õ¡ÖƒÕ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_SIZE = 5 * 1024 * 1024; // 5MB

async function uploadFile(file: Express.Multer.File) {
  // MIME type-Õ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
  if (!ALLOWED_TYPES.includes(file.mimetype)) {
    throw new BadRequestException('Invalid file type');
  }
  
  // Õ‰Õ¡ÖƒÕ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
  if (file.size > MAX_SIZE) {
    throw new BadRequestException('File too large');
  }
  
  // ÕÕ¿Õ¥Õ²Õ®Õ«Õ›Ö€ Õ¶Õ¸Ö€ Ö†Õ¡ÕµÕ¬Õ« Õ¡Õ¶Õ¸Ö‚Õ¶
  const filename = `${uuid()}${path.extname(file.originalname)}`;
  
  // originalname-Õ¨ ÕˆÕ‰ Ö…Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ¥Õ¬ Õ¸Ö‚Õ²Õ²Õ¡Õ¯Õ«
}
```

---

## ğŸŒ HTTPS ÔµÕ HEADERS

### Security Headers

```typescript
// âœ… Õ•Õ£Õ¿Õ¡Õ£Õ¸Ö€Õ®Õ«Õ›Ö€ helmet
import helmet from 'helmet';

app.use(helmet());

// Ô¿Õ¡Õ´ Õ¯Õ¡Ö€Õ£Õ¡Õ¾Õ¸Ö€Õ«Õ›Ö€ Õ±Õ¥Õ¼Ö„Õ¸Õ¾
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  next();
});
```

### CORS

```typescript
// âœ… CORS-Õ« Õ³Õ«Õ·Õ¿ Õ¯Õ¡Ö€Õ£Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´
app.use(cors({
  origin: [
    'https://example.com',
    'https://admin.example.com',
  ],
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400, // 24 ÕªÕ¡Õ´
}));

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ production-Õ¸Ö‚Õ´
app.use(cors({ origin: '*' }));
```

---

## ğŸ“Š Ô¼ÕˆÔ³Ô±ÕÕˆÕÕ„Ô±Õ† Ô¿Ô±Õ†ÕˆÕ†Õ†ÔµÕ

### Ô»Õ¶Õ¹ Õ¬Õ¸Õ£Õ¡Õ¾Õ¸Ö€Õ¥Õ¬

```typescript
// âœ… Ô¼Õ¸Õ£Õ¡Õ¾Õ¸Ö€Õ«Õ›Ö€ Õ¡Õ¶Õ¾Õ¿Õ¡Õ¶Õ£ Õ¿Õ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€
logger.info('User logged in', { userId: user.id, ip: req.ip });
logger.warn('Failed login attempt', { email, ip: req.ip, attempts });
logger.error('Payment failed', { orderId, errorCode });

// âŒ ÔµÕÔµÕ”ÔµÔ¼ÔµÕ Õ´Õ« Õ¬Õ¸Õ£Õ¡Õ¾Õ¸Ö€Õ¥Õ¬
logger.info('Login', { email, password }); // Ô³Õ¡Õ²Õ¿Õ¶Õ¡Õ¢Õ¡Õ¼
logger.debug('Token', { accessToken });    // Ô¹Õ¸Ö„Õ¥Õ¶
logger.info('Card', { cardNumber });       // ÕÕ³Õ¡Ö€Õ¡ÕµÕ«Õ¶ Õ¿Õ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€
```

### ÕÕ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€Õ« Õ¤Õ«Õ´Õ¡Õ¯Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´

```typescript
// âœ… Ô´Õ«Õ´Õ¡Õ¯Õ¡Õ¾Õ¸Ö€Õ«Õ›Ö€ Õ¦Õ£Õ¡ÕµÕ¸Ö‚Õ¶ Õ¿Õ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€Õ¨
function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  return `${local[0]}***@${domain}`;
}

function maskCard(card: string): string {
  return `****${card.slice(-4)}`;
}

logger.info('Payment processed', {
  email: maskEmail(user.email),
  card: maskCard(cardNumber),
});
```

---

## ğŸ“‹ Ô±Õ†ÕÕÔ±Õ†Ô³ÕˆÕ’Ô¹Õ…Ô±Õ† ÕÕÕˆÕ’Ô³Ô±Õ‘ÕˆÕ’Õ‘Ô±Ô¿

### Ô´Õ¥ÕºÕ¬Õ¸ÕµÕ«Ö Õ¡Õ¼Õ¡Õ»

- [ ] Ô²Õ¸Õ¬Õ¸Ö€ Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€Õ¨ environment variables-Õ¸Ö‚Õ´
- [ ] .env-Õ¶ .gitignore-Õ¸Ö‚Õ´
- [ ] HTTPS-Õ¨ Õ´Õ«Õ¡ÖÕ¾Õ¡Õ® Õ§
- [ ] Security headers-Õ¨ Õ¯Õ¡Ö€Õ£Õ¡Õ¾Õ¸Ö€Õ¾Õ¡Õ® Õ¥Õ¶
- [ ] CORS-Õ¨ Õ½Õ¡Õ°Õ´Õ¡Õ¶Õ¡ÖƒÕ¡Õ¯Õ¾Õ¡Õ® Õ§
- [ ] Rate limiting-Õ¨ Õ´Õ«Õ¡ÖÕ¾Õ¡Õ® Õ§
- [ ] Ô²Õ¸Õ¬Õ¸Ö€ Õ´Õ¸Ö‚Õ¿Ö„Õ¡ÕµÕ«Õ¶ Õ¿Õ¾ÕµÕ¡Õ¬Õ¶Õ¥Ö€Õ« Õ¾Õ¡Õ¬Õ«Õ¤Õ¡ÖÕ«Õ¡
- [ ] Ô³Õ¡Õ²Õ¿Õ¶Õ¡Õ¢Õ¡Õ¼Õ¥Ö€Õ¨ Õ°Õ¥Õ·Õ¡Õ¾Õ¸Ö€Õ¾Õ¡Õ® Õ¥Õ¶ (argon2/bcrypt)
- [ ] JWT Õ¯Õ¡Ö€Õ³ ÕªÕ¡Õ´Õ¯Õ¥Õ¿Õ¸Õ¾
- [ ] Ô¼Õ¸Õ£Õ¡Õ¾Õ¸Ö€Õ¸Ö‚Õ´ Õ¡Õ¼Õ¡Õ¶Ö Õ£Õ¡Õ²Õ¿Õ¶Õ«Ö„Õ¶Õ¥Ö€Õ«
- [ ] SQL injection-Õ«Ö ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶ (ORM)
- [ ] XSS-Õ«Ö ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶ (CSP)
- [ ] CSRF-Õ«Ö ÕºÕ¡Õ·Õ¿ÕºÕ¡Õ¶Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶

### ÕŠÕ¡Ö€Õ¢Õ¥Ö€Õ¡Õ¢Õ¡Ö€

- [ ] Ô¿Õ¡Õ­Õ¾Õ¡Õ®Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¶Õ¥Ö€Õ« Õ©Õ¡Ö€Õ´Õ¡ÖÕ¸Ö‚Õ´ (npm audit)
- [ ] Ô½Õ¸ÖÕ¥Õ¬Õ«Õ¸Ö‚Õ©ÕµÕ¸Ö‚Õ¶Õ¶Õ¥Ö€Õ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´
- [ ] Õ„Õ¸Ö‚Õ¿Ö„Õ« Õ«Ö€Õ¡Õ¾Õ¸Ö‚Õ¶Ö„Õ¶Õ¥Ö€Õ« Õ¾Õ¥Ö€Õ¡Õ¶Õ¡ÕµÕ¸Ö‚Õ´
- [ ] Ô¼Õ¸Õ£Õ¥Ö€Õ« Õ½Õ¿Õ¸Ö‚Õ£Õ¸Ö‚Õ´

---

---

## â˜ï¸ Õ–Ô±Õ…Ô¼ÔµÕÔ» ÕŠÔ±Õ€ÕŠÔ±Õ†ÕˆÕ’Õ„ (CLOUDFLARE R2)

> Cloudflare R2 â€” Õ¢Õ¸Õ¬Õ¸Ö€ Õ¶Õ¡Õ­Õ¡Õ£Õ®Õ¥Ö€Õ« Õ¬Õ¼Õ¥Õ¬ÕµÕ¡ÕµÕ¶ ÕºÕ¡Õ°Õ¸ÖÕ¨Ö‰ `public/` Õ´Õ«Õ¡ÕµÕ¶ Õ½Õ¿Õ¡Õ¿Õ«Õ¯ Õ¡Õ½Õ¥Õ¿Õ¶Õ¥Ö€Õ« Õ°Õ¡Õ´Õ¡Ö€ (favicon, robots.txt, og-image)Ö‰

### Env variables (ÕºÕ¡Ö€Õ¿Õ¡Õ¤Õ«Ö€ Õ¶Õ¡Õ­Õ¡Õ£Õ®Õ« Õ´Õ¥Õ¯Õ¶Õ¡Ö€Õ¯Õ«Õ¶)

```bash
R2_ACCOUNT_ID="your_account_id"
R2_ACCESS_KEY_ID="your_access_key"
R2_SECRET_ACCESS_KEY="your_secret_key"
R2_BUCKET_NAME="your_bucket_name"
R2_PUBLIC_URL="https://pub-xxx.r2.dev"  # Õ¯Õ¡Õ´ custom domain
```

### S3-Õ°Õ¡Õ´Õ¡Õ¿Õ¥Õ²Õ¥Õ¬Õ« Õ¯Õ¬Õ«Õ¥Õ¶Õ¿ (Õ¥Ö€Õ¯Õ¸Ö‚ stack-Õ« Õ°Õ¡Õ´Õ¡Ö€ Õ¨Õ¶Õ¤Õ°Õ¡Õ¶Õ¸Ö‚Ö€)

```typescript
// lib/r2.ts
import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3';

export const r2 = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
  },
});

export async function uploadFile(key: string, body: Buffer, contentType: string) {
  await r2.send(new PutObjectCommand({
    Bucket: process.env.R2_BUCKET_NAME!,
    Key: key,
    Body: body,
    ContentType: contentType,
  }));
  return `${process.env.R2_PUBLIC_URL}/${key}`;
}
```

### Next.js â€” Route Handler (upload)

```typescript
// app/api/upload/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { uploadFile } from '@/lib/r2';
import { nanoid } from 'nanoid';

const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB

export async function POST(req: NextRequest) {
  const formData = await req.formData();
  const file = formData.get('file') as File;
  if (!file) return NextResponse.json({ error: 'No file' }, { status: 400 });

  // ÕÕ«ÕºÕ« Ö‡ Õ¹Õ¡ÖƒÕ« Õ¾Õ¡Õ¬Õ«Õ¤Õ¡ÖÕ«Õ¡
  if (!ALLOWED_TYPES.includes(file.type)) {
    return NextResponse.json({ error: 'File type not allowed' }, { status: 400 });
  }
  if (file.size > MAX_FILE_SIZE) {
    return NextResponse.json({ error: 'File too large (max 10MB)' }, { status: 400 });
  }

  const buffer = Buffer.from(await file.arrayBuffer());
  const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  const key = `uploads/${nanoid()}-${safeName}`;
  const url = await uploadFile(key, buffer, file.type);

  return NextResponse.json({ url });
}
```

### NestJS â€” Upload Multer-Õ¸Õ¾

```typescript
// files/files.controller.ts
@Controller('files')
export class FilesController {
  constructor(private readonly filesService: FilesService) {}

  @Post('upload')
  @UseInterceptors(FileInterceptor('file'))
  async upload(@UploadedFile() file: Express.Multer.File) {
    // Õ–Õ¡ÕµÕ¬Õ« Õ¡Õ¶Õ¾Õ¡Õ¶ Õ½Õ¡Õ¶Õ«Õ¿Õ«Õ¦Õ¡ÖÕ«Õ¡ (Õ°Õ¡Õ¿Õ¸Ö‚Õ¯ Õ¶Õ«Õ·Õ¥Ö€, Õ¢Õ¡ÖÕ¡Õ¿Õ¶Õ¥Ö€Õ« Õ°Õ¥Õ¼Õ¡ÖÕ¸Ö‚Õ´)
    const safeName = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '_');
    const key = `uploads/${nanoid()}-${safeName}`;
    const url = await this.filesService.upload(key, file.buffer, file.mimetype);
    return { url };
  }
}
```

### Ô¿Õ¡Õ¶Õ¸Õ¶Õ¶Õ¥Ö€

- âœ… Ô²Õ¸Õ¬Õ¸Ö€ Ö…Õ£Õ¿Õ¡Õ¿Õ«Ö€Õ¸Õ» Ö†Õ¡ÕµÕ¬Õ¥Ö€Õ¨ â†’ R2
- âœ… `public/` â†’ Õ´Õ«Õ¡ÕµÕ¶ favicon.ico, robots.txt, sitemap.xml, og-image
- âœ… R2-Õ« env vars-Õ¨ Õ¬Ö€Õ¡ÖÕ¾Õ¡Õ® Õ¥Õ¶ Õ¶Õ¡Õ­Õ¡Õ£Õ®Õ« Õ´Õ¥Õ¯Õ¶Õ¡Ö€Õ¯Õ«Õ¶
- âŒ Õ•Õ£Õ¿Õ¡Õ¿Õ«Ö€Õ¸Õ» Ö†Õ¡ÕµÕ¬Õ¥Ö€ public/-Õ¸Ö‚Õ´ Õ¹ÕºÕ¡Õ°Õ¥Õ¬
- âŒ Ô²Õ¥Õ¼Õ¶Õ¾Õ¡Õ® Ö†Õ¡ÕµÕ¬Õ¥Ö€ Õ¼Õ¥ÕºÕ¸Õ¦Õ«Õ¿Õ¸Ö€Õ«Õ¡ commit Õ¹Õ¡Õ¶Õ¥Õ¬

---

**ÕÕ¡Ö€Õ¢Õ¥Ö€Õ¡Õ¯.** 1.1
**Ô±Õ´Õ½Õ¡Õ©Õ«Õ¾.** 2026-02-12
